<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro • MostreAki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --verde-escuro: #003735;
      --verde-texto: #214645;
      --fundo: #92a9a6;
      --bordo: #7d2f59;
      --grad1: #d9d9d9;
      --grad2: #af91a1;
      --chip-bg: #f5e7ef;
      --input-bg: #f7f7f7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--fundo);
      color: var(--verde-texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      background: #c4d4d1;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: .5rem;
      text-decoration: none;
      color: var(--verde-escuro);
      font-weight: 700;
      letter-spacing: .01em;
    }

    .brand img {
      height: 55px;
      width: auto;
      display: block;
    }

    .brand span {
      font-size: 1.35rem;
    }

    .topbar-accent {
      height: 4px;
      background: var(--bordo);
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
    }

    /* MAIN LAYOUT */
    main {
      flex: 1;
      padding: 2rem 1rem 2.5rem;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    .page-title {
      font-size: clamp(1.8rem, 4vw, 2.3rem);
      color: var(--verde-escuro);
      margin-bottom: .25rem;
      font-weight: 800;
    }

    .page-sub {
      font-size: 1rem;
      margin-bottom: 1.5rem;
      max-width: 620px;
      line-height: 1.5;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 3fr);
      gap: 1.75rem;
    }

    @media (min-width: 880px) {
      .grid {
        grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
        align-items: flex-start;
      }
    }

    .card {
      background: #fdfdfd;
      border-radius: 24px;
      box-shadow:
        0 18px 30px rgba(0,0,0,.18),
        0 0 0 1px rgba(255,255,255,.7);
      padding: 1.75rem 1.5rem 1.9rem;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 0 0, rgba(255,255,255,.7) 0, transparent 45%),
        radial-gradient(circle at 100% 100%, rgba(125,47,89,.08) 0, transparent 55%);
      opacity: .9;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 1.3rem;
      color: var(--verde-escuro);
      font-weight: 700;
      margin-bottom: .35rem;
    }

    .card-sub {
      font-size: .95rem;
      line-height: 1.6;
      margin-bottom: 1.15rem;
    }

    /* FORM */
    form {
      display: flex;
      flex-direction: column;
      gap: .9rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: .3rem;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
    }

    .field-row .field {
      flex: 1 1 160px;
    }

    label {
      font-size: .9rem;
      font-weight: 600;
      color: var(--verde-escuro);
    }

    .hint {
      font-size: .8rem;
      color: #666;
      line-height: 1.4;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: var(--input-bg);
      padding: .7rem 1rem;
      font-size: .95rem;
      outline: none;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }

    input:focus {
      border-color: var(--bordo);
      box-shadow: 0 0 0 3px rgba(125,47,89,.18);
      background: #fff;
    }

    input[readonly] {
      color: #777;
      background: #ececec;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: .75rem;
      margin-top: .75rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: .98rem;
      padding: .7rem 1.2rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .55rem;
      transition: transform .1s ease, box-shadow .1s ease, filter .1s ease;
      text-decoration: none;
      text-align: center;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      box-shadow: 0 4px 10px rgba(0,0,0,.18);
      border: 2px solid rgba(0,0,0,.08);
    }

    .btn-primary:hover {
      filter: brightness(1.03);
    }

    .btn-google {
      background: #fff;
      color: #444;
      border: 1px solid rgba(0,0,0,.16);
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }

    .btn-ghost {
      background: transparent;
      color: var(--bordo);
      border: 1px solid rgba(125,47,89,.45);
    }

    .btn-google img {
      width: 18px;
      height: 18px;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin: .8rem 0 .2rem;
      font-size: .8rem;
      color: #777;
    }

    .divider span {
      flex: 1;
      height: 1px;
      background: rgba(0,0,0,.12);
    }

    .small-text {
      font-size: .8rem;
      color: #666;
      line-height: 1.5;
      margin-top: .4rem;
    }

    /* LATERAL CARD */
    .side-card-title {
      font-weight: 700;
      margin-bottom: .4rem;
      color: var(--verde-escuro);
    }

    .bullet-list {
      font-size: .9rem;
      line-height: 1.6;
      padding-left: 1rem;
    }

    .bullet-list li + li {
      margin-top: .3rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .25rem .7rem;
      border-radius: 999px;
      background: var(--chip-bg);
      font-size: .8rem;
      color: var(--bordo);
      margin-top: .6rem;
    }

    /* ALERT MODAL */
    .alert-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }

    .alert-box {
      background: #fff;
      border-radius: 18px;
      max-width: 420px;
      width: 100%;
      padding: 1.3rem 1.4rem 1.1rem;
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      border: 1px solid rgba(125,47,89,.18);
    }

    .alert-title {
      font-weight: 700;
      margin-bottom: .25rem;
      color: var(--verde-escuro);
    }

    .alert-msg {
      font-size: .9rem;
      line-height: 1.5;
      margin-bottom: .9rem;
    }

    .alert-actions {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
    }

    .alert-actions .btn {
      padding-inline: 1rem;
      font-size: .88rem;
    }

    /* FOOTER */
    footer {
      margin-top: auto;
      background: #7c9390;
      padding: 1.1rem 1rem 1.3rem;
      color: #f5f5f5;
    }

    footer .foot-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: .5rem;
      font-size: .8rem;
      align-items: center;
    }

    footer img {
      height: 26px;
      width: auto;
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar-inner">
      <a href="index.html" class="brand" aria-label="Voltar para a página inicial MostreAki">
        <img src="logo.svg" alt="MostreAki">
        <span>MostreAki</span>
      </a>
    </div>
    <div class="topbar-accent"></div>
  </header>

  <main>
    <div class="wrap">
      <h1 class="page-title">Criar conta</h1>
      <p class="page-sub">
        Crie sua conta MostreAki para ativar sua assinatura, configurar seu catálogo
        digital e gerenciar tudo em um só lugar.
      </p>

      <div class="grid">
        <!-- FORM CARD -->
        <section class="card">
          <div class="card-inner">
            <h2 class="card-title">Dados de acesso</h2>
            <p class="card-sub">
              Você pode se cadastrar usando um e-mail e senha ou conectar sua conta Google.
            </p>

            <div class="actions">
              <button type="button" id="btnGoogle" class="btn btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
                <span>Continuar com Google</span>
              </button>
            </div>

            <div class="divider" aria-hidden="true">
              <span></span> ou preencha seus dados <span></span>
            </div>

            <form id="cadastroForm" novalidate>
              <div class="field">
                <label for="slug">Nome de usuário (slug)</label>
                <input id="slug" type="text" autocomplete="username" required
                       placeholder="ex: lamaggie, studio-ana, bar-do-joao" />
                <p class="hint">
                  Esse será o seu <strong>nome de usuário público</strong> e também o identificador
                  do seu catálogo. Use apenas letras, números, pontos e hífen.
                </p>
              </div>

              <div class="field">
                <label for="telefone">WhatsApp comercial</label>
                <input id="telefone" type="tel" autocomplete="tel" required
                       placeholder="(11) 90000-0000" />
                <p class="hint">
                  Telefone usado para contato nos botões de WhatsApp dos seus anúncios
                  (pode ser ajustado depois na sua conta).
                </p>
              </div>

              <div class="field">
                <label for="email">E-mail de acesso</label>
                <input id="email" type="email" autocomplete="email" required
                       placeholder="voce@exemplo.com" />
              </div>

              <div class="field-row" id="pwRow">
                <div class="field">
                  <label for="senha">Senha</label>
                  <input id="senha" type="password" autocomplete="new-password" minlength="6" />
                </div>
                <div class="field">
                  <label for="senha2">Confirmar senha</label>
                  <input id="senha2" type="password" autocomplete="new-password" minlength="6" />
                </div>
              </div>

              <p class="small-text">
                Ao criar sua conta você concorda com os termos de uso e autoriza o contato
                do MostreAki para assuntos relacionados à sua assinatura.
              </p>

              <div class="actions">
                <button type="submit" class="btn btn-primary" id="btnCriarConta">
                  Criar conta
                </button>
                <a href="login.html" class="btn btn-ghost">Já tenho conta</a>
              </div>
            </form>
          </div>
        </section>

        <!-- SIDE CARD -->
        <aside class="card">
          <div class="card-inner">
            <h3 class="side-card-title">O que você ganha com sua conta?</h3>
            <ul class="bullet-list">
              <li>Gerenciar seus dados de titular diretamente na página <b>Minha Conta</b>.</li>
              <li>Acesso ao <b>catálogo digital</b> e ao <b>álbum</b> conforme o plano contratado.</li>
              <li>Facilidade para trocar banners, fotos e informações principais do seu site.</li>
              <li>Integração com links externos (Mercado Livre, PicPay, PayPal, Pix QR Code e outros).</li>
              <li>Suporte do MostreAki por WhatsApp em horário comercial.</li>
            </ul>
            <div class="chip">
              ✔ Cadastro simples • sem burocracia
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer>
    <div class="foot-inner">
      <div>© <span id="year"></span> MostreAki • Todos os direitos reservados.</div>
      <img src="logo.svg" alt="MostreAki">
    </div>
  </footer>

  <!-- ALERT -->
  <div id="alert" class="alert-backdrop" role="alertdialog" aria-modal="true">
    <div class="alert-box">
      <div class="alert-title" id="alertTitle">Aviso</div>
      <div class="alert-msg" id="alertMsg">Mensagem.</div>
      <div class="alert-actions" id="alertActions"></div>
    </div>
  </div>

  <!-- Firebase + Lógica de cadastro -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      sendEmailVerification,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      query,
      where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ====== Firebase config ======
    const app = initializeApp({
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    });
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ====== util ======
    const $ = id => document.getElementById(id);
    $("year").textContent = new Date().getFullYear();

    const alertBG = $("alert");
    const alertTitle = $("alertTitle");
    const alertMsg = $("alertMsg");
    const alertActions = $("alertActions");

    function showAlert({ title = "Aviso", html = "", actions = [{ text: "Fechar" }] }) {
      alertTitle.textContent = title;
      alertMsg.innerHTML = html;
      alertActions.innerHTML = "";
      actions.forEach(a => {
        const btn = document.createElement("button");
        btn.className = "btn " + (a.variant === "ghost" ? "btn-ghost" : "btn-primary");
        btn.textContent = a.text;
        btn.onclick = () => {
          if (a.onClick) a.onClick();
          closeAlert();
        };
        alertActions.appendChild(btn);
      });
      alertBG.style.display = "flex";
    }

    function closeAlert() {
      alertBG.style.display = "none";
    }

    alertBG.addEventListener("click", e => {
      if (e.target === alertBG) closeAlert();
    });

    // ====== helpers de slug e telefone ======
    function normalizarSlug(raw) {
      return raw
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")   // tira acentos
        .toLowerCase()
        .replace(/[^a-z0-9.-]+/g, "-")                     // só letras/números/ponto/hífen
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");
    }

    async function slugJaExiste(slug) {
      const q = query(collection(db, "usuarios"), where("slug", "==", slug));
      const snap = await getDocs(q);
      return !snap.empty;
    }

    // ====== estado: cadastro via Google? ======
    let usandoGoogle = false;

    const form = $("cadastroForm");
    const inputSlug = $("slug");
    const inputTel = $("telefone");
    const inputEmail = $("email");
    const inputSenha = $("senha");
    const inputSenha2 = $("senha2");
    const pwRow = $("pwRow");
    const btnGoogle = $("btnGoogle");

    btnGoogle.addEventListener("click", async () => {
      try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        usandoGoogle = true;
        inputEmail.value = user.email || "";
        inputEmail.readOnly = true;
        pwRow.style.display = "none";

        if (!inputSlug.value && user.displayName) {
          inputSlug.value = normalizarSlug(user.displayName);
        }

        showAlert({
          title: "Conta Google conectada",
          html: "Agora escolha o seu <b>nome de usuário (slug)</b> e informe o WhatsApp comercial. Depois clique em <b>Criar conta</b> para concluir o cadastro."
        });

      } catch (e) {
        console.error(e);
        showAlert({
          title: "Não foi possível entrar com Google",
          html: "Tente novamente ou use o cadastro por e-mail e senha."
        });
      }
    });

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();

      const slugRaw = inputSlug.value.trim();
      const tel = inputTel.value.trim();
      const email = inputEmail.value.trim();
      const senha = inputSenha.value;
      const senha2 = inputSenha2.value;

      if (!slugRaw) {
        return showAlert({ title: "Slug obrigatório", html: "Informe o seu nome de usuário (slug)." });
      }
      const slug = normalizarSlug(slugRaw);
      if (!slug) {
        return showAlert({
          title: "Slug inválido",
          html: "Use apenas letras, números, pontos e hífens no seu nome de usuário."
        });
      }

      if (!tel) {
        return showAlert({ title: "WhatsApp obrigatório", html: "Informe o número de WhatsApp comercial." });
      }

      if (!email) {
        return showAlert({ title: "E-mail obrigatório", html: "Informe um e-mail para acesso." });
      }

      // e-mail simples
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
      if (!emailRe.test(email)) {
        return showAlert({ title: "E-mail inválido", html: "Revise o endereço de e-mail informado." });
      }

      // se NÃO for Google, precisamos de senha
      if (!usandoGoogle) {
        if (!senha || !senha2) {
          return showAlert({
            title: "Defina uma senha",
            html: "Informe e confirme sua senha para continuar."
          });
        }
        if (senha.length < 6) {
          return showAlert({
            title: "Senha fraca",
            html: "A senha deve ter pelo menos <b>6 caracteres</b>."
          });
        }
        if (senha !== senha2) {
          return showAlert({
            title: "Senhas diferentes",
            html: "A confirmação de senha não confere. Digite novamente."
          });
        }
      }

      try {
        // checar se slug já existe
        if (await slugJaExiste(slug)) {
          return showAlert({
            title: "Nome de usuário em uso",
            html: "Esse slug já está cadastrado. Escolha outro nome de usuário."
          });
        }

        let user;

        if (usandoGoogle) {
          user = auth.currentUser;
          if (!user) {
            return showAlert({
              title: "Sessão expirada",
              html: "Entre novamente com Google ou faça o cadastro por e-mail."
            });
          }
          // atualiza displayName e e-mail (já vem do Google)
          await updateProfile(user, { displayName: slug });
        } else {
          const cred = await createUserWithEmailAndPassword(auth, email, senha);
          user = cred.user;
          await updateProfile(user, { displayName: slug });
          await sendEmailVerification(user);
        }

        // cria/atualiza documento em "usuarios"
        const userDocRef = doc(db, "usuarios", user.uid);
        await setDoc(userDocRef, {
          email,
          slug,
          catalogoSlug: slug,
          whatsapp: tel,
          createdAt: serverTimestamp(),
          catalogoAtivo: false
        }, { merge: true });

        // tudo ok
        if (usandoGoogle) {
          showAlert({
            title: "Cadastro concluído",
            html: "Sua conta foi vinculada ao Google e os dados foram salvos. Você já pode acessar a página <b>Minha Conta</b> e seus recursos.",
            actions: [
              {
                text: "Ir para Minha Conta",
                onClick: () => { window.location.href = "minha-conta.html"; }
              }
            ]
          });
        } else {
          showAlert({
            title: "Cadastro criado",
            html: "Enviamos um e-mail de confirmação para <b>" + email +
                  "</b>.<br>Confirme o endereço e, depois, acesse a página <b>Minha Conta</b> para continuar.",
            actions: [
              {
                text: "Ir para login",
                onClick: () => { window.location.href = "login.html"; }
              }
            ]
          });
        }

      } catch (e) {
        console.error(e);
        let msg = "Erro inesperado ao criar conta. Tente novamente em alguns instantes.";
        if (e.code === "auth/email-already-in-use") {
          msg = "Este e-mail já está sendo usado em outra conta. Tente fazer login ou recuperar a senha.";
        }
        showAlert({ title: "Não foi possível concluir", html: msg });
      }
    });
  </script>
</body>
</html>
