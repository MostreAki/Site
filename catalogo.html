<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catálogo • MostreAki</title>
<style>
  :root{
    --header:#e9e3dc;
    --paper:#fdfcfb;
    --ink:#222;
    --muted:#6b7280;
    --accent:#fa1e39;
    --container:#ffffff;
    --btn:#fa1e39;
    --text:#000000;
    --bg:#ffffff;
  }
  html,body{margin:0;padding:0}
  body{background:var(--paper);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  header{background:var(--header);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
  .logo{font-weight:800}
  .who{opacity:.7;font-size:.9rem}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fill,minmax(250px,1fr))}
  .tile{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
  .tile img{width:100%;height:200px;object-fit:cover;display:block;background:#f3f3f3}
  .meta{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;color:#6b7280;font-size:.8rem}
  .info{padding:12px;display:grid;gap:8px}
  .title{font-weight:800;letter-spacing:.02em}
  .swatches{display:flex;gap:6px}
  .sw{width:14px;height:14px;border-radius:4px;border:1px solid rgba(0,0,0,.08)}
  .price{font-weight:900}
  .edit{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .edit input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;font-size:.95rem}
  .edit .save{padding:8px 12px;border:none;border-radius:8px;background:var(--btn);color:#fff;font-weight:800;cursor:pointer}
  .muted{background:#fff;border:1px solid #eee;color:#555;border-radius:8px;padding:6px 10px;cursor:pointer}
  .danger{border-color:#fecaca;color:#b91c1c}
  /* add tile */
  .add-tile{height:200px;border:2px dashed #d6d3d1;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#fffaf3;box-shadow:0 6px 18px rgba(0,0,0,.04);cursor:pointer;transition:transform .06s,border-color .15s}
  .add-tile:hover{border-color:#c8b6a6}
  .add-tile:active{transform:scale(.99)}
  .add-inner{text-align:center;color:#7c6f64}
  .add-inner .plus{font-size:42px;line-height:1}
  .add-inner small{display:block;margin-top:6px;color:#9a9088}
  .add-tile.dragover{background:#fff4e6;border-color:#c58f5c}
  .uploading::after{content:"Enviando...";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);color:#fff;font-weight:800;border-radius:14px}
  footer{background:var(--header);padding:14px;text-align:center;color:#555}
  .badge{font-size:.8rem;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid #eee}
</style>
</head>
<body>
<header>
  <div class="logo">MostreAki • Catálogo</div>
  <div class="who">
    <span id="modeBadge" class="badge">Carregando…</span>
  </div>
</header>

<main class="wrap">
  <div id="notice" style="display:none;margin:10px 0;padding:10px;border:1px solid #fde68a;background:#fef9c3;border-radius:8px;color:#7c6f64"></div>
  <div class="grid" id="grid"></div>
</main>

<footer>© <span id="year"></span> MostreAki</footer>

<script>
  // aplica tema vindo do CrieAki (localStorage)
  (function applyTheme(){
    try{
      const root=document.documentElement.style;
      const bg=localStorage.getItem('bgColor')||'#ffffff';
      const text=localStorage.getItem('textColor')||'#000000';
      const header=localStorage.getItem('headerColor')||'#e9e3dc';
      const footer=localStorage.getItem('footerColor')||'#e9e3dc';
      const cont=localStorage.getItem('containerColor')||'#ffffff';
      const btn=localStorage.getItem('btnColor')||'#fa1e39';
      root.setProperty('--bg',bg);
      root.setProperty('--text',text);
      root.setProperty('--header',header);
      root.setProperty('--btn',btn);
      root.setProperty('--container',cont);
    }catch(e){}
    document.getElementById('year').textContent=new Date().getFullYear();
  })();

  // parse #uid=...&name=...
  function parseHash(){
    const h=(location.hash||'').replace(/^#/,'');
    const params=new URLSearchParams(h);
    return { uid: params.get('uid')||null, name: params.get('name')||null };
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // >>> Firebase do seu projeto
  const app = initializeApp({
    apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
    authDomain: "mostreaki-2025.firebaseapp.com",
    projectId: "mostreaki-2025",
    storageBucket: "mostreaki-2025.appspot.com",
    messagingSenderId: "748712068097",
    appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
  });

  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const grid = document.getElementById('grid');
  const notice = document.getElementById('notice');
  const modeBadge = document.getElementById('modeBadge');

  const moneyToNumber = (v)=> {
    if(typeof v==='number') return v;
    return Number(String(v).replace(/[^0-9,.-]/g,'').replace(/\./g,'').replace(',','.'))||0;
  };
  const numberToBRL = (n)=>{
    try{ return (+n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
    catch{ return `R$ ${( +n || 0).toFixed(2)}`;}
  };

  // input file invisível
  const picker = document.createElement('input');
  picker.type='file'; picker.accept='image/*'; picker.multiple=true; document.body.appendChild(picker);

  function readContext(){
    const { uid, name } = parseHash();
    return { pageUid: uid, pageName: name };
  }

  function setModeBadge(canEdit, name){
    modeBadge.textContent = canEdit ? 'Modo edição' : 'Modo público';
    modeBadge.style.background = canEdit ? '#eef6ff' : '#fff';
    modeBadge.style.borderColor = canEdit ? '#bfdbfe' : '#eee';
    const who = name ? ` • ${name}` : '';
    modeBadge.title = (canEdit?'Você pode editar este catálogo':'Visualização pública') + who;
  }

  async function uploadSingle(file, userId){
    return new Promise((resolve, reject)=>{
      const path = `catalog/${userId}/images/${Date.now()}-${file.name}`;
      const r = ref(storage, path);
      const t = uploadBytesResumable(r, file, {contentType:file.type});
      t.on('state_changed', ()=>{}, reject, async ()=>{
        const url = await getDownloadURL(t.snapshot.ref);
        await addDoc(collection(db, 'catalogos', userId, 'imagens'), {
          url, path, createdAt: serverTimestamp(), titulo:'', preco:0, quantidade:1
        });
        resolve();
      });
    });
  }

  async function handleUploads(files, userId){
    const tile = document.querySelector('.add-tile');
    if(tile) tile.classList.add('uploading');
    for(const f of files){ await uploadSingle(f, userId); }
    if(tile) tile.classList.remove('uploading');
    await
