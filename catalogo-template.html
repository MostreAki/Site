<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catálogo • MostreAki</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --mk-bg1:#0f6f69; --mk-bg2:#179b93;
    --mk-card:#f3f5f6; --mk-ink:#24423f; --mk-ink-soft:#5e7b76;
    --mk-accent:#1fb394; --mk-title:#c6f2e0;
    --shadow: 0 10px 24px rgba(0,0,0,.18), 0 4px 12px rgba(0,0,0,.12);
    --r:20px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--mk-ink);
    background: radial-gradient(1200px 600px at 20% -10%, #1aa79f22 0%, #0000 60%),
                linear-gradient(180deg, var(--mk-bg1), var(--mk-bg2));
    min-height:100dvh;
  }

  /* topo */
  .topbar{display:flex;align-items:center;gap:12px;padding:14px 18px;
    background:linear-gradient(90deg,#b8efe1aa,#b8efe122);backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid #ffffff2e;position:sticky;top:0;z-index:50}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:34px;height:34px;border-radius:999px}
  .brand strong{font-weight:800;color:#fff;text-shadow:0 1px 0 #0003}
  .brand b{color:#ff4b55}

  /* hero */
  .hero{max-width:1100px;margin:24px auto 10px;padding:0 16px;text-align:center}
  .logo{margin:0 auto 18px;width:120px;height:120px;border-radius:999px;background:#fff;border:6px solid #ffffffcc;
        display:grid;place-items:center;box-shadow:var(--shadow);overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .banner{height:180px;border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;
          background:linear-gradient(180deg,#cfeff9,#e8f7ff);border:1px solid #fff}
  .title{margin:14px 0 4px;font-size:clamp(26px,4vw,38px);font-weight:800;letter-spacing:.3px;
         color:var(--mk-title);text-shadow:0 4px 16px rgba(0,0,0,.35),0 1px 0 #0003}
  .subtitle{margin:0 0 8px;color:#e9fbf6;font-weight:600;text-shadow:0 1px 0 #0003}

  /* grid */
  .wrap{max-width:1100px;margin:16px auto 60px;padding:0 16px}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .card{background:#eee;border-radius:18px;box-shadow:var(--shadow);border:1px solid #e7ebee;overflow:hidden}
  .frame{background:#e9e9e9;border:12px solid #e5e5e5;border-bottom-width:10px;border-radius:12px;
         margin:10px}
  .thumb{aspect-ratio:4/3;background:
          linear-gradient(#bfe8ff,#e7f5ff) padding-box,
          linear-gradient(45deg,#0000,#0000) border-box;
         border:1px solid #d0dbe2;display:grid;place-items:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}

  /* faixa inferior estilo “polaroid” */
  .strip{
    display:grid;grid-template-columns:auto 1fr 60px;gap:8px;align-items:center;
    background:#efefef;border-top:1px solid #d9e1e6;padding:10px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;
  }
  .labels{font-weight:800;color:#2f4e49;line-height:1.15}
  .inputs{display:grid;gap:6px}
  .inputs input{
    width:100%;max-width:130px;padding:7px 10px;border-radius:10px;border:1px solid #cfd8dd;background:#fff;
    font:600 14px Poppins,sans-serif;color:#263532;outline:none;
  }
  .waWrap{
    background:radial-gradient(#0000 68%, #0001 70%) 0 0/16px 16px #e8ecef;
    border-radius:12px;display:grid;place-items:center;padding:4px;
  }
  .wa{
    width:44px;height:44px;border-radius:999px;display:grid;place-items:center;background:#25D366;color:#fff;border:none;cursor:pointer;
    box-shadow:0 6px 16px rgba(37,211,102,.35);transition:transform .08s ease-out
  }
  .wa:active{transform:translateY(1px) scale(.98)}
  .wa svg{width:24px;height:24px;fill:currentColor}

  /* barra de ações */
  .bar{max-width:1100px;margin:6px auto 0;padding:0 16px 6px;display:flex;gap:10px;justify-content:flex-end}
  .pill{border:none;background:var(--mk-accent);color:#fff;font-weight:800;padding:10px 14px;border-radius:999px;box-shadow:var(--shadow);cursor:pointer}
  .pill[disabled]{opacity:.5;cursor:not-allowed}

  footer{color:#cfe9e4;text-align:center;padding:26px 16px 44px;background:linear-gradient(180deg,#0e6b65,#0a4e4a);border-top:1px solid #ffffff22}
  footer small{opacity:.9}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><img src="https://mostreaki.com.br/img/mostreaki-icon.png" alt=""><strong>Mostre<b>Aki</b></strong></div>
    <div style="margin-left:auto;color:#eafff9;font-weight:700">Catálogo</div>
  </div>

  <header class="hero">
    <div class="logo"><img id="logoImg" alt="logo"></div>
    <div class="banner" id="banner"></div>
    <div class="title" id="catTitle">Catálogo do Cliente</div>
    <div class="subtitle" id="catSubtitle">Escolha um item e chame no WhatsApp</div>
  </header>

  <div class="bar" id="editBar" hidden>
    <button class="pill" id="saveBtn" disabled>Salvar alterações</button>
  </div>

  <main class="wrap"><section class="grid" id="grid"></section></main>

  <footer><small>© <span id="year"></span> MostreAki. Todos os direitos reservados.</small></footer>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    /* ===== CONFIG ===== */
    const firebaseConfig = {
      apiKey:"AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain:"mostreaki-2025.firebaseapp.com",
      databaseURL:"https://mostreaki-2025-default-rtdb.firebaseio.com",
      projectId:"mostreaki-2025",
      storageBucket:"mostreaki-2025.firebasestorage.app",
      messagingSenderId:"748712068097",
      appId:"1:748712068097:web:09cf043fbb45917ef6ec00"
    };
    /* Onde ficam as imagens do cliente (ex.: GitHub/Pages/Cloudflare) */
    const ASSETS_HOST = "https://assets.mostreaki.com.br";
    /* ===== /CONFIG ===== */

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);

    const $ = (id)=>document.getElementById(id);
    const ui = { year:$("year"), grid:$("grid"), editBar:$("editBar"), saveBtn:$("saveBtn"),
                 title:$("catTitle"), subtitle:$("catSubtitle"), logo:$("logoImg"), banner:$("banner") };

    ui.year.textContent = new Date().getFullYear();

    const params = new URLSearchParams(location.search);
    const slug   = params.get("c") || "demo";
    const editRequested = params.get("edit")==="1";

    const imgURL = f => `${ASSETS_HOST}/catalogo/${slug}/${f}`;
    const digits = s => (s||"").replace(/\D/g,"");
    const waMsg  = (n,p,q)=>`Olá! Tenho interesse no item *${n}*.\nQtde: ${q||1}\nPreço: R$ ${Number(p||0).toFixed(2)}`;

    const dirty = new Map();
    function markDirty(id,p){ dirty.set(id,{...(dirty.get(id)||{}),...p}); ui.saveBtn.disabled = dirty.size===0; }

    function makeCard(id,data,readonly,whats){
      const nome = data.nome || `Produto ${id}`;
      const preco= Number(data.preco||0).toFixed(2);
      const qtd  = Number(data.quantidade||0);
      const img  = data.imagem ? imgURL(data.imagem) : "";
      const wrap = document.createElement("article");
      wrap.className = "card";
      wrap.innerHTML = `
        <div class="frame">
          <div class="thumb">${img?`<img src="${img}" alt="">`:``}</div>
          <div class="strip">
            <div class="labels">Preço<br>Qtde</div>
            <div class="inputs">
              <input class="in-price" type="number" step="0.01" min="0" value="${preco}" ${readonly?'disabled':''}>
              <input class="in-qty"   type="number" step="1"    min="0" value="${qtd}"   ${readonly?'disabled':''}>
            </div>
            <div class="waWrap">
              <button class="wa" title="WhatsApp">
                <svg viewBox="0 0 32 32"><path d="M19.11 17.32c-.27-.14-1.59-.79-1.84-.88-.25-.09-.43-.14-.62.14-.18.27-.71.88-.87 1.06-.16.18-.32.2-.59.07-.27-.14-1.15-.42-2.19-1.34-.81-.72-1.36-1.6-1.52-1.87-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.62-1.49-.85-2.04-.22-.53-.44-.46-.62-.47-.16-.01-.34-.01-.52-.01s-.48.07-.73.34c-.25.27-.96.94-.96 2.29s.99 2.66 1.13 2.84c.14.18 1.94 2.96 4.7 4.15.66.29 1.18.46 1.58.59.66.21 1.26.18 1.73.11.53-.08 1.59-.65 1.82-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32zM16 3C8.83 3 3 8.83 3 16c0 2.29.6 4.44 1.66 6.32L3 29l6.85-1.79C11.8 28.38 13.83 29 16 29c7.17 0 13-5.83 13-13S23.17 3 16 3z"/></svg>
              </button>
            </div>
          </div>
        </div>
      `;
      const inPrice = wrap.querySelector('.in-price');
      const inQty   = wrap.querySelector('.in-qty');
      const wa      = wrap.querySelector('.wa');
      wa.addEventListener('click', ()=>{
        const msg = encodeURIComponent(waMsg(nome, inPrice.value, inQty.value));
        const phone = digits(whats||'55');
        window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
      });
      if(!readonly){
        inPrice.addEventListener('input',()=>markDirty(id,{preco:Number(inPrice.value||0)}));
        inQty  .addEventListener('input',()=>markDirty(id,{quantidade:Number(inQty.value||0)}));
      }
      return wrap;
    }

    async function loadMeta(){
      try{
        const cfgRef = doc(db,"catalogos",slug,"meta","config");
        const snap   = await getDoc(cfgRef);
        const cfg    = snap.exists()? snap.data(): {};
        ui.title.textContent    = cfg.titulo    || "Catálogo do Cliente";
        ui.subtitle.textContent = cfg.subtitulo || "Escolha um item e chame no WhatsApp";
        ui.logo.src = cfg.logo ? imgURL(cfg.logo) : "https://dummyimage.com/240x240/ffffff/cccccc.png&text=LOGO";
        if(cfg.banner) ui.banner.style.background = `center/cover no-repeat url('${imgURL(cfg.banner)}')`;
        return cfg;
      }catch(e){ console.warn("meta:",e); return {}; }
    }

    async function boot(){
      const cfg = await loadMeta();

      // owner / permissão
      let canEdit=false, ownerUid=null;
      try{
        const ownRef = doc(db,"catalogos",slug,"meta","owner");
        const ownSnap= await getDoc(ownRef);
        if(ownSnap.exists()) ownerUid = ownSnap.data().uid||null;
      }catch{}
      onAuthStateChanged(auth,(u)=>{ canEdit = !!(u && editRequested && ownerUid && u.uid===ownerUid); ui.editBar.hidden=!canEdit; });

      // itens
      let docs=[];
      try{
        const itRef = collection(db,"catalogos",slug,"itens");
        const qRef  = query(itRef, orderBy("ordem","asc"));
        const snap  = await getDocs(qRef);
        snap.forEach(d=>docs.push({id:d.id,...d.data()}));
      }catch(e){ console.warn("itens:",e); }

      ui.grid.innerHTML="";
      if(docs.length===0){
        // placeholders (8) — igual ao seu Canva: foto + Preço/Qtde + WA
        for(let i=1;i<=8;i++){
          ui.grid.appendChild( makeCard(String(i), {nome:`Produto ${i}`}, false, cfg.whats) );
        }
      }else{
        const readonly = !editRequested;
        docs.forEach(d => ui.grid.appendChild( makeCard(d.id, d, readonly, cfg.whats) ));
      }

      ui.saveBtn.addEventListener('click', async ()=>{
        if(!canEdit){ alert("Você não tem permissão para salvar este catálogo."); return; }
        ui.saveBtn.disabled=true;
        try{
          const ops=[];
          for(const [id,payload] of dirty.entries()){
            ops.push( updateDoc(doc(db,"catalogos",slug,"itens",id), payload) );
          }
          await Promise.all(ops); dirty.clear(); alert("Catálogo atualizado!");
        }catch(e){ console.error(e); alert("Erro ao salvar."); }
        finally{ ui.saveBtn.disabled = dirty.size===0; }
      });
    }
    boot();
  </script>
</body>
</html>
