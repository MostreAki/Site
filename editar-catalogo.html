<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Editar Cat√°logo ‚Äì MostreAki (Storage ‚â§ 400KB + Firestore)</title>
  <style>
    :root{
      --brand:#16b0af; --brandLight:#c4e8de; --ink:#083f3e; --bg:#ff768d;
      --danger:#d73e45; --line:#e7f3f1; --inkSub:#4a6665; --btnText:#fff; --muted:#567; --ok:#0a7;
      /* fundo opcional do card do item */
      --item-bg:url("/assets/card-bg-mostreaki.png");
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:#cceee6;display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid #bfe3da}
    header .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    header .logo b{color:#f61f38}
    header .logo img{height:40px}
    .user-wrap{margin-left:auto;display:flex;align-items:center;gap:10px}
    .user-circle{width:42px;height:42px;border-radius:50%;overflow:hidden;display:none;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.15);background:#0b3e3c;color:#fff;font-weight:800;align-items:center;justify-content:center}
    .menu-icon{width:36px;height:26px;position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .menu-icon span{position:absolute;width:24px;height:3px;background:#1b1b1b;border-radius:3px}
    .menu-icon span:nth-child(1){top:2px}
    .menu-icon span:nth-child(2){top:11px}
    .menu-icon span:nth-child(3){bottom:2px}
    nav#menu{display:none;position:absolute;right:12px;top:64px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 18px 50px rgba(0,0,0,.12);padding:10px 12px;gap:8px;flex-direction:column}
    nav#menu a{padding:10px 12px;border-radius:8px;color:#0b3e3c}
    nav#menu a:hover{background:#eef8f5}
    main.container{max-width:1100px;margin:22px auto;padding:0 16px}
    h2{color:#0b3e3c;margin:12px 0 8px;font-size:1.9rem}
    .sub{color:var(--inkSub);margin-bottom:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:#e9fbf8;border:1px solid #cfeee9;color:#0b4d4c;font-weight:700}
    .ghost-link{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:2px solid var(--brand); color:var(--brand); background:#fff; font-weight:800;}
    .card{background:#cceee6;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:16px}
    .card .head{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700;color:#0b3e3c;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .card .body{padding:16px}
    .hint{font-size:.95rem;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .item{
      position:relative;border:1px solid #d8ebe7;border-radius:16px;padding:14px;background:#fff;
      box-shadow:0 8px 28px rgba(0,0,0,.05);
      overflow:hidden; isolation:isolate;
    }
    .item::before{
      content:""; position:absolute; inset:0; z-index:-1; opacity:.08;
      background-image:var(--item-bg);
      background-size:cover; background-position:center; background-repeat:no-repeat;
      filter:saturate(1.1) contrast(1.05);
    }
    .item h4{margin:0 0 10px;color:#0b3e3c;font-size:1.08rem}
    .row{display:grid;grid-template-columns:1fr 160px 140px;gap:10px}
    @media(max-width:820px){ .row{grid-template-columns:1fr 1fr} .col-qty{grid-column:1 / -1} }
    .row + .row{margin-top:10px}
    label{display:block;font-weight:600;color:#124b49;margin:4px 0}
    input[type="text"], input[type="number"], input[type="url"]{
      width:100%;padding:11px 12px;border:1px solid #cfe9e3;border-radius:12px;background:#fff
    }

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:11px 14px;font-weight:800;cursor:pointer}
    .btn.save{background:var(--brand);color:var(--btnText)}
    .btn.ghost{background:#fff;border:2px solid var(--brand);color:var(--brand)}
    .btn.ok{background:var(--ok);color:#fff}
    .status-ok{background:#eafff7;border:1px solid #bcefe0;color:#0b7558;border-radius:10px;padding:10px 12px}
    .status-err{background:#fff1f1;border:1px solid #f1c6c6;color:#a33;border-radius:10px;padding:10px 12px}
    .row-switch{display:flex;align-items:center;gap:10px}
    .uploader{margin-top:12px;border-top:1px dashed #e2efec;padding-top:12px}
    .uploader .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}

    /* ===== Bot√£o de ARQUIVO custom sem √≠cone (texto centralizado ‚ÄúMostreAki‚Äù) ===== */
    .filecell{display:flex;flex-direction:column;gap:6px}
    .visually-hidden{
      position:absolute!important; width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
    .file-btn{
      display:inline-flex;align-items:center;justify-content:center;
      width:100%; min-height:44px; padding:10px 10px;
      border:1px dashed #b7ddd7; border-radius:12px;
      background:#0f766e; color:#fff; font-weight:800; cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      transition:transform .08s ease, box-shadow .12s ease, background .12s ease;
      text-align:center; user-select:none;
    }
    .file-btn:active{ transform:translateY(1px); box-shadow:0 4px 12px rgba(0,0,0,.14); }

    .pv{margin-top:10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .pv-wrap { position: relative; }
    .pv img{width:100%;height:104px;object-fit:cover;border:1px solid #e3f2ef;border-radius:10px;background:#FFF}
    .progress{height:8px;background:#e9f5f1;border-radius:6px;overflow:hidden}
    .bar{height:8px;background:linear-gradient(90deg,#19c5a7,#12a69f)}
    footer{color:#567;font-size:.88rem;text-align:center;padding:20px 16px}
    .btn.auth{min-width:92px;text-align:center}

    /* Bot√£o de lixeira aparece s√≥ quando a imagem est√° vis√≠vel */
    .remove-btn{
      position:absolute; top:4px; right:4px;
      background:rgba(0,0,0,.6); color:#fff; border:none;
      border-radius:50%; width:24px; height:24px; cursor:pointer;
      font-size:14px; line-height:22px; display:none;
    }
    .pv-wrap.has-image .remove-btn{ display:block; }
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="/logomarca-mostreaki.svg" alt="Logo"> <b>MostreAki</b></div>
    <div class="user-wrap">
      <div id="userCircle" class="user-circle" title="Usu√°rio"></div>
      <a id="authBtn" href="#" class="btn ghost auth">Entrar</a>
      <div id="menuBtn" class="menu-icon" aria-label="Abrir menu" role="button" tabindex="0">
        <span></span><span></span><span></span>
      </div>
      <nav id="menu">
        <a href="/index.html">P√°gina Inicial</a>
        <a href="/sobre.html">Sobre</a>
        <a href="/planos.html">Planos</a>
        <a href="/parceiros.html">Parceiros</a>
        <a href="/servicos-adicionais.html">Servi√ßos Adicionais</a>
        <a href="/instrucoes.html">Instru√ß√µes</a>
        <a href="/redes-sociais.html">Redes Sociais</a>
        <a href="/contatos.html">Contatos</a>
        <a href="/minha-conta.html">Minha Conta</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>Editar Cat√°logo</h2>
    <div class="sub">
      <span class="pill">Slug: <b id="slugLabel" style="margin-left:6px">‚Äî</b></span>
      <a id="publicLink" class="ghost-link" href="#" target="_blank" rel="noopener" title="Abrir a p√°gina p√∫blica do cat√°logo">üîó Ver p√°gina p√∫blica</a>
      <span id="planoInfo" class="hint"></span>
    </div>

    <section class="card">
      <div class="head">
        <div>Configura√ß√µes</div>
        <div class="toolbar">
          <button id="btnSalvarTudo" class="btn save">Salvar tudo</button>
        </div>
      </div>
      <div class="body">
        <div class="row-switch">
          <label><input id="chkAtivo" type="checkbox"> Cat√°logo ativo</label>
          <span id="statusSave" class="hint"></span>
        </div>
        <p id="hintLimite" class="hint" style="margin-top:12px"></p>
        <p class="hint" style="margin-top:8px">
          Para subir a imagem clique no <b>Bot√£o MostreAki</b>. 
          Envie as <b>imagens</b> (convertidas automaticamente ‚â§ 400 KB) mantendo alta qualidade.
        </p>
      </div>
    </section>

    <section class="card">
      <div class="head">Itens do Cat√°logo</div>
      <div class="body">
        <div id="grid" class="grid"></div>
      </div>
    </section>
  </main>

  <footer>¬© <span id="ano"></span> MostreAki</footer>

  <!-- Firebase v10.14 -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence 
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, getDocs, collection, writeBatch, serverTimestamp,
      updateDoc, deleteField
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, updateMetadata } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    // ========= Firebase config =========
    const cfg = {
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    };
    const app = getApps().length ? getApp() : initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    await setPersistence(auth, browserLocalPersistence);

    const $ = s => document.querySelector(s);
    document.getElementById('ano').textContent = new Date().getFullYear();

    // Menu
    (()=>{ const btn=$('#menuBtn'),menu=$('#menu'); if(!btn||!menu) return;
      const open=()=>{menu.style.display='flex';document.addEventListener('click',onDoc,true);document.addEventListener('keydown',onKey);}
      const close=()=>{menu.style.display='none';document.removeEventListener('click',onDoc,true);document.removeEventListener('keydown',onKey);}
      const toggle=()=> menu.style.display==='flex'?close():open();
      function onDoc(e){ if(!menu.contains(e.target)&&e.target!==btn) close(); }
      function onKey(e){ if(e.key==='Escape') close(); }
      btn.addEventListener('click',e=>{e.stopPropagation();toggle();});
    })();

    // Helpers
    const fmtBRL = c => 'R$ ' + (c/100).toLocaleString('pt-BR',{minimumFractionDigits:2});
    const parseBRL = s => { const n=parseFloat(String(s).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.')); return isNaN(n)?0:Math.round(n*100); };
    const bust = url => url ? (url + (url.includes('?')?'&':'?') + 't=' + Date.now()) : url;

    // Slug + link p√∫blico
    function getSlug(){ const u=new URL(location.href); return u.searchParams.get('c') || u.searchParams.get('slug') || ''; }
    const slug = getSlug(); $('#slugLabel').textContent = slug || '‚Äî';
    function setPublicLink(slug, meta={}){ const a=$('#publicLink'); if(!a||!slug){ if(a) a.href='#'; return; }
      const custom=(meta.publicPagePath||meta.public_page_path||meta.customPublicPage||'').trim();
      a.href = custom || `/catalogo-${slug}.html`; }

    // Plano
    function normalizePlano(p=''){ return p.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }
    function maxByPlano(plano){ const p=normalizePlano(plano||''); if(p.includes('avancado'))return 100; if(p.includes('intermedi')||p.includes('essencial'))return 60; return 30; }
    async function resolveLimiteAssinatura(ownerUid){
      const s = await getDoc(doc(db,'assinaturas',ownerUid));
      if(!s.exists()) return { ativo:false, limite:30, plano:'sem-plano' };
      const d=s.data(); const status=String(d.status||'').toLowerCase(); const plano=d.plano||d.planoAtual?.nome||'basico';
      return { ativo: status==='ativo', limite: maxByPlano(plano), plano };
    }

    async function exigirDonoOuEditor(uid, slug){
      const refCfg = doc(db,'catalogos',slug,'meta','config');
      const s = await getDoc(refCfg);
      if(!s.exists()) throw new Error('CONFIG_NOT_FOUND');
      const data = s.data();
      const ehDono = data.ownerUid === uid;
      const ehEditor = Array.isArray(data.editores) && data.editores.includes(uid);
      if(!(ehDono || ehEditor)) throw new Error('NOT_OWNER');
      return data;
    }

    // Avatar + sair
    function renderUserCircle(user){
      const el = $('#userCircle'); const btn=$('#authBtn');
      const show = ()=> el.style.display='flex';
      if(!user){
        el.style.display='none';
        btn.textContent='Entrar';
        btn.onclick=(e)=>{ e.preventDefault(); window.location.href='/index.html'; };
        return;
      }
      btn.textContent='Sair';
      btn.onclick=async (e)=>{ e.preventDefault(); try{ await signOut(auth); } finally{ window.location.href='/index.html'; } };
      const url = user.photoURL;
      el.title = user.displayName || user.email || user.uid;
      el.innerHTML = '';
      if(url){ const img=new Image(); img.src=url; img.alt='User'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; el.appendChild(img); show(); return; }
      const name = (user.displayName || user.email || 'U').trim();
      const initials = name.split('@')[0].split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'U').join('');
      el.textContent = initials; show();
    }

    // Compress√£o ‚â§ 400KB
    async function compressToJPEG(file, maxBytes=400*1024, maxW=1400, maxH=1400){
      const img = new Image(); img.src = URL.createObjectURL(file); await img.decode();
      const r = Math.min(maxW/img.width, maxH/img.height, 1), w=Math.round(img.width*r), h=Math.round(img.height*r);
      const canvas = Object.assign(document.createElement('canvas'), { width:w, height:h });
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      let q=0.9, step=0.08, out;
      for(let i=0;i<10;i++){ out = await new Promise(res=>canvas.toBlob(res,'image/jpeg',q)); if(out.size<=maxBytes || q<=0.4) break; q-=step; step=Math.max(0.03,step*0.75); }
      return new File([out], file.name.replace(/\.\w+$/i,'.jpg'), { type:'image/jpeg' });
    }

    /* Bot√£o custom ‚ÄúMostreAki‚Äù (sem √≠cone) */
    function fileButtonHTML(forId){
      return `<label class="file-btn" for="${forId}"><span>MostreAki</span></label>`;
    }

    // ===== UI dos itens =====
    function buildGrid(limite){
      const grid = $('#grid'); grid.innerHTML='';
      for(let i=1;i<=limite;i++){
        const id = String(i).padStart(2,'0');
        grid.insertAdjacentHTML('beforeend', `
          <div class="item">
            <h4>Item ${id}</h4>
            <div class="row">
              <div>
                <label for="nome_${id}">Nome</label>
                <input type="text" id="nome_${id}" placeholder="Ex.: Produto ${id}">
              </div>
              <div>
                <label for="preco_${id}">Pre√ßo</label>
                <input type="text" id="preco_${id}" placeholder="R$ 0,00">
              </div>
              <div class="col-qty">
                <label for="qtd_${id}">Quantidade</label>
                <input type="number" id="qtd_${id}" min="0" step="1" placeholder="0">
              </div>
            </div>

            <div class="row" style="grid-template-columns:1fr;">
              <div>
                <label for="ml_${id}">Link Mercado Livre (opcional)</label>
                <input type="url" id="ml_${id}" placeholder="https://produto.mercadolivre.com.br/...">
              </div>
            </div>

            <div class="uploader">
              <label>Imagens</label>
              <div class="grid3">
                <div class="filecell">
                  <label for="f1_${id}">IMG 1</label>
                  <input class="visually-hidden" type="file" id="f1_${id}" accept="image/*">
                  ${fileButtonHTML(`f1_${id}`)}
                </div>
                <div class="filecell">
                  <label for="f2_${id}">IMG 2</label>
                  <input class="visually-hidden" type="file" id="f2_${id}" accept="image/*">
                  ${fileButtonHTML(`f2_${id}`)}
                </div>
                <div class="filecell">
                  <label for="f3_${id}">IMG 3</label>
                  <input class="visually-hidden" type="file" id="f3_${id}" accept="image/*">
                  ${fileButtonHTML(`f3_${id}`)}
                </div>
              </div>
              <div class="pv" id="pv_${id}">
                <div class="pv-wrap"><img id="p1_${id}" style="display:none" alt=""></div>
                <div class="pv-wrap"><img id="p2_${id}" style="display:none" alt=""></div>
                <div class="pv-wrap"><img id="p3_${id}" style="display:none" alt=""></div>
              </div>
              <div class="progress" style="margin:8px 0;display:none" id="pg_${id}"><div class="bar" id="bar_${id}" style="width:0%"></div></div>
              <div class="toolbar">
                <button class="btn ok" data-up="${id}">Enviar imagens</button>
              </div>
              <div class="hint" id="hint_${id}"></div>
            </div>
          </div>`);
      }

      // pr√©vias locais + atualiza√ß√£o de lixeiras
      $('#grid').querySelectorAll('input[type=file]').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const id = inp.id.split('_')[1];
          const which = inp.id.startsWith('f1_')?1:inp.id.startsWith('f2_')?2:3;
          const img = document.getElementById(`p${which}_${id}`);
          if(inp.files && inp.files[0]){ img.src = URL.createObjectURL(inp.files[0]); img.style.display='block'; }
          else { img.src=''; img.style.display='none'; }
          updateRemoveButtonsForItem(id);
        });
      });
      $('#grid').querySelectorAll('button[data-up]').forEach(b=> b.onclick = ()=> uploadImagensDoItem(b.dataset.up));
    }

    async function carregarItens(slug, limite){
      const snap = await getDocs(collection(db,'catalogos',slug,'itens'));
      const map={}; snap.forEach(d=> map[d.id]=d.data());
      for(let i=1;i<=limite;i++){
        const id=String(i).padStart(2,'0'); const d=map[id]; if(!d) continue;
        $('#nome_'+id).value  = d.nome || d.titulo || '';
        $('#qtd_'+id).value   = (typeof d.quantidade==='number')? d.quantidade : (d.qtde||0);
        const cents = (typeof d.precoCentavos==='number')? d.precoCentavos : (typeof d.preco==='number'? Math.round(d.preco*100):0);
        $('#preco_'+id).value = fmtBRL(cents);
        $('#ml_'+id).value    = d.mlUrl || '';
        const urls=[d.urlImagem,d.urlImagem2,d.urlImagem3];
        urls.forEach((u,ix)=>{ 
          const im=document.getElementById('p'+(ix+1)+'_'+id); 
          if(im && u){ im.src=bust(u); im.style.display='block'; }
        });
        updateRemoveButtonsForItem(id);
      }
    }

    async function salvarTudo(slug, limite){
      const stx = document.getElementById('statusSave'); stx.textContent='Salvando...'; stx.className='hint';
      try{
        const batch = writeBatch(db);
        for(let i=1;i<=limite;i++){
          const id=String(i).padStart(2,'0');
          const nome=(document.getElementById('nome_'+id)?.value||'').trim();
          const qtd =parseInt(document.getElementById('qtd_'+id)?.value||'0',10);
          const cents=parseBRL(document.getElementById('preco_'+id)?.value||'');
          const ml =(document.getElementById('ml_'+id)?.value||'').trim();
          batch.set(doc(db,'catalogos',slug,'itens',id),{
            ordem:i, nome, quantidade:isNaN(qtd)?0:qtd, precoCentavos:cents, mlUrl:ml, atualizadoEm:serverTimestamp()
          },{merge:true});
        }
        await batch.commit();
        stx.textContent='Salvo com sucesso.'; stx.className='status-ok';
        setTimeout(()=>{ stx.textContent=''; stx.className='hint'; },1800);
      }catch(e){ stx.textContent='Falha ao salvar.'; stx.className='status-err'; console.error(e); }
    }

    async function carregarMeta(slug){
      const s=await getDoc(doc(db,'catalogos',slug,'meta','config')); let d={};
      if(s.exists()){ d=s.data(); $('#chkAtivo').checked=!!d.catalogoAtivo; }
      setPublicLink(slug,d); return d;
    }

    async function salvarMeta(slug, ownerUid){
      await setDoc(doc(db,'catalogos',slug,'meta','config'),{
        ownerUid, catalogoAtivo: $('#chkAtivo').checked, atualizadoEm: serverTimestamp()
      },{merge:true});
    }

    function bloquearUI(msg){ document.querySelector('main.container').innerHTML = `<div class="card"><div class="body status-err">${msg}</div></div>`; }

    // Upload por slot fixo (n√£o reordena)
    async function uploadImagensDoItem(id){
      const hint=$('#hint_'+id), barBox=$('#pg_'+id), bar=$('#bar_'+id);
      const f1=$('#f1_'+id)?.files?.[0]||null;
      const f2=$('#f2_'+id)?.files?.[0]||null;
      const f3=$('#f3_'+id)?.files?.[0]||null;
      if(!f1 && !f2 && !f3){ hint.textContent='Selecione pelo menos 1 imagem.'; return; }

      const toUpload=[];
      for(const [slot,file] of [[1,f1],[2,f2],[3,f3]]){
        if(!file) continue;
        const c=await compressToJPEG(file, 400*1024, 1400, 1400);
        if(c.size>400*1024){ hint.textContent=`IMG ${slot} ainda > 400KB (${Math.round(c.size/1024)}KB).`; return; }
        toUpload.push([slot,c]);
      }

      hint.textContent='Enviando...'; barBox.style.display='block'; bar.style.width='0%';
      const base=`catalogos/${slug}/itens/${id}`;
      let sent=0, total=toUpload.reduce((a,[_s,f])=>a+f.size,0);
      const newUrls={};

      for(const [slot,file] of toUpload){
        const name=`i${String(slot).padStart(2,'0')}.jpg`;
        const path=`${base}/${name}`;
        const r=ref(st, path);
        await new Promise((resolve,reject)=>{
          const task=uploadBytesResumable(r,file,{ contentType:'image/jpeg', cacheControl:'public,max-age=31536000,immutable' });
          task.on('state_changed', snap=>{
            const p=Math.round(((sent+snap.bytesTransferred)/total)*100); bar.style.width=p+'%';
          }, reject, async ()=>{
            const url=await getDownloadURL(r);
            await updateMetadata(r, { cacheControl: 'public, max-age=60' });
            newUrls[slot]=url; sent+=file.size; resolve();
          });
        });
      }

      const itemRef = doc(db, 'catalogos', slug, 'itens', id);
      const patch = { atualizadoEm: serverTimestamp() };
      if(newUrls[1]) patch.urlImagem  = newUrls[1];
      if(newUrls[2]) patch.urlImagem2 = newUrls[2];
      if(newUrls[3]) patch.urlImagem3 = newUrls[3];
      await setDoc(itemRef, patch, { merge:true });

      for(const s of [1,2,3]){
        if(newUrls[s]){
          const im=document.getElementById(`p${s}_${id}`);
          if(im){ im.src=bust(newUrls[s]); im.style.display='block'; }
        }
      }
      updateRemoveButtonsForItem(id);

      hint.textContent='Imagens enviadas e salvas!';
      bar.style.width='100%'; setTimeout(()=>{ barBox.style.display='none'; },1200);
    }

    // Remover individual (n√£o reordena)
    async function removerImagem(slug, id, campo, imgEl) {
      const hint = document.getElementById('hint_' + id);
      try {
        hint.textContent = 'Removendo imagem...';
        if (imgEl.src && imgEl.src.startsWith("https://firebasestorage.googleapis.com/")) {
          try {
            const url = new URL(imgEl.src);
            const path = decodeURIComponent(url.pathname.split("/o/")[1].split("?")[0]);
            await deleteObject(ref(st, path));
          } catch (e) { console.warn('Storage delete falhou, seguindo:', e?.code || e); }
        }
        const itemRef = doc(db, "catalogos", slug, "itens", id);
        await updateDoc(itemRef, { [campo]: deleteField(), atualizadoEm: serverTimestamp() });
        imgEl.src=''; imgEl.style.display='none';
        const which = campo === 'urlImagem' ? '1' : (campo === 'urlImagem2' ? '2' : '3');
        const fileInput = document.getElementById('f' + which + '_' + id);
        if (fileInput) fileInput.value = '';
        updateRemoveButtonsForItem(id);
        hint.textContent = 'Imagem removida.'; setTimeout(()=> hint.textContent = '', 1500);
      } catch (e) {
        console.error("Erro ao remover imagem:", e);
        hint.textContent = 'Falha ao remover (regras do Storage/Firestore?).';
        hint.className = 'status-err';
      }
    }

    // Cria/atualiza lixeiras apenas quando a imagem est√° vis√≠vel
    function updateRemoveButtonsForItem(id){
      for (let n = 1; n <= 3; n++) {
        const imgEl = document.getElementById(`p${n}_${id}`);
        if (!imgEl) continue;
        const wrap = imgEl.parentElement;
        if (!wrap) continue;
        // remove bot√£o antigo
        const old = wrap.querySelector('button.remove-btn');
        if (old) old.remove();
        // exibe bot√£o s√≥ se a imagem estiver vis√≠vel
        if (imgEl.style.display !== 'none' && imgEl.src) {
          wrap.classList.add('has-image');
          const btn = document.createElement('button');
          btn.textContent = 'üóëÔ∏è';
          btn.className = 'remove-btn';
          btn.onclick = () => {
            const campo = n === 1 ? "urlImagem" : n === 2 ? "urlImagem2" : "urlImagem3";
            removerImagem(slug, id, campo, imgEl).then(()=> btn.remove());
          };
          wrap.style.position = 'relative';
          wrap.appendChild(btn);
        } else {
          wrap.classList.remove('has-image');
        }
      }
    }

    // Auth + carregamento
    onAuthStateChanged(auth, async user=>{
      try{
        if(!user){ window.location.replace('/index.html'); return; }
        renderUserCircle(auth.currentUser);
        if(!slug){ bloquearUI('Informe ?c=<slug> para editar.'); return; }

        const cfgMeta = await exigirDonoOuEditor((auth.currentUser||{}).uid, slug);
        const { ativo, limite, plano } = await resolveLimiteAssinatura(cfgMeta.ownerUid);
        if(!ativo){ bloquearUI('Assinatura inativa para este cat√°logo.'); return; }
        document.getElementById('hintLimite').textContent = `Seu plano (${plano}) permite at√© ${limite} itens.`;
        document.getElementById('planoInfo').textContent = `Plano atual: ${plano}`;

        buildGrid(limite);
        const meta = await carregarMeta(slug);
        await carregarItens(slug, limite);

        document.getElementById('btnSalvarTudo').onclick = ()=> salvarTudo(slug, limite);
        document.getElementById('chkAtivo').addEventListener('change', ()=> salvarMeta(slug, cfgMeta.ownerUid));
        setPublicLink(slug, meta);
      }catch(e){
        console.error(e);
        if(e.message==='NOT_OWNER') bloquearUI('Voc√™ n√£o tem permiss√£o para editar este cat√°logo.');
        else if(e.message==='CONFIG_NOT_FOUND') bloquearUI('Configura√ß√£o n√£o encontrada. Crie /catalogos/'+slug+'/meta/config.');
        else bloquearUI('Erro ao carregar. Verifique as regras do Firestore/Storage.');
      }
    });
  </script>
</body>
</html>
