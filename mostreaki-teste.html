<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Login MostreAki</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    :root {
      --cor-fundo: #92a9a6;
      --cor-header: #cde0dd;
      --cor-magenta: #7d2f59;
      --cor-magenta-clara: #af91a1;
      --cor-botao: #7d2f59;
      --cor-botao-texto: #fff;
      --cor-alert-bg: rgba(0,0,0,.55);
      --cor-card-alert: #f5f0f4;
      --cor-texto: #123;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #a8b9b6 0, #92a9a6 40%, #7f9692 100%);
      color: var(--cor-texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      background: var(--cor-header);
      padding: .6rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .logo-mark {
      width: 34px;
      height: 34px;
      border-radius: 6px;
      background: linear-gradient(180deg, #003735 0, #7d2f59 100%);
    }

    .logo-text-main {
      font-weight: 700;
      color: #003735;
      font-size: 1.25rem;
    }
    .logo-text-sub {
      font-weight: 700;
      color: #7d2f59;
      font-size: 1.25rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: .75rem;
    }

    #btnAbrirLogin {
      border: none;
      padding: .4rem 1.1rem;
      border-radius: 999px;
      background: var(--cor-botao);
      color: var(--cor-botao-texto);
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,.18);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      font-size: .95rem;
    }
    #btnAbrirLogin:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,.22);
      background: #5e2342;
    }

    #authText {
      font-size: .9rem;
      color: var(--cor-magenta);
      font-weight: 600;
      cursor: pointer;
      display: none;
    }

    #userCircle {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: #7d2f59;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: .95rem;
      background-size: cover;
      background-position: center;
      box-shadow: 0 0 0 2px #f2e7ee;
      cursor: pointer;
    }

    main {
      padding: 1.5rem 1rem;
      max-width: 700px;
      margin: 0 auto;
      text-align: center;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: .5rem;
      color: #003735;
    }
    p.desc {
      font-size: .95rem;
      color: #123;
      max-width: 480px;
      margin: 0 auto 1.5rem;
    }

    /* MODAL LOGIN */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #f7f4f8;
      border-radius: 16px;
      padding: 1.5rem 1.25rem 1.25rem;
      max-width: 360px;
      width: 92%;
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
      position: relative;
      border-top: 5px solid var(--cor-magenta);
    }
    .modal h2 {
      font-size: 1.3rem;
      margin-bottom: .25rem;
      color: #003735;
    }
    .modal p {
      font-size: .85rem;
      color: #444;
      margin-bottom: 1rem;
    }
    .modal .close {
      position: absolute;
      top: .5rem;
      right: .7rem;
      border: none;
      background: transparent;
      font-size: 1.3rem;
      cursor: pointer;
      color: #777;
    }
    .field {
      text-align: left;
      margin-bottom: .75rem;
    }
    .field label {
      display: block;
      font-size: .8rem;
      margin-bottom: .25rem;
      color: #333;
    }
    .field input[type="email"],
    .field input[type="password"] {
      width: 100%;
      padding: .6rem .7rem;
      border-radius: 10px;
      border: 1px solid #c9b6c5;
      font-size: .9rem;
      outline: none;
      background: #fff;
    }
    .field input:focus {
      border-color: var(--cor-magenta);
      box-shadow: 0 0 0 1px rgba(125,47,89,.25);
    }
    .field-inline {
      display: flex;
      align-items: center;
      gap: .4rem;
      font-size: .8rem;
      color: #555;
    }
    .field-inline input {
      width: auto;
    }

    #btnEntrar {
      margin-top: .6rem;
      width: 100%;
      padding: .65rem;
      border-radius: 999px;
      border: none;
      background: var(--cor-botao);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: .95rem;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    #btnEntrar:hover {
      background: #5e2342;
    }

    .modal-links {
      margin-top: .6rem;
      display: flex;
      flex-direction: column;
      gap: .3rem;
      font-size: .8rem;
      text-align: left;
    }
    .modal-links a {
      color: var(--cor-magenta);
      text-decoration: none;
      font-weight: 600;
    }

    /* ALERTA */
    #alert {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: var(--cor-alert-bg);
      z-index: 60;
    }
    .alert-box {
      background: var(--cor-card-alert);
      border-radius: 14px;
      padding: 1.1rem .9rem .8rem;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      border-left: 4px solid var(--cor-magenta);
    }
    .alert-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: .3rem;
      color: #2a1a28;
    }
    .alert-msg {
      font-size: .85rem;
      color: #463545;
      margin-bottom: .7rem;
    }
    .alert-actions {
      display: flex;
      justify-content: flex-end;
      gap: .4rem;
    }
    .btn-solid,
    .btn-ghost {
      font-size: .8rem;
      padding: .4rem .75rem;
      border-radius: 999px;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }
    .btn-solid {
      background: var(--cor-magenta);
      color: #fff;
    }
    .btn-ghost {
      background: transparent;
      color: var(--cor-magenta);
      border: 1px solid rgba(125,47,89,.5);
    }

    @media (min-width: 720px) {
      header {
        padding-inline: 2.5rem;
      }
      main {
        padding-top: 2rem;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo-area">
    <div class="logo-mark"></div>
    <div>
      <span class="logo-text-main">Mostre</span><span class="logo-text-sub">Aki</span>
    </div>
  </div>

  <div class="header-right">
    <button id="btnAbrirLogin" type="button">Entrar</button>
    <span id="authText" title="Sair da conta">Sair</span>
    <div id="userCircle" title="Minha conta"></div>
  </div>
</header>

<main>
  <h1>Teste de Login MostreAki</h1>
  <p class="desc">
    Este é um ambiente de <b>teste</b> só para verificar o comportamento do botão <b>Entrar</b>,
    do <b>user circle</b> e do modal de login com Firebase Auth.
  </p>
</main>

<!-- MODAL LOGIN -->
<div class="modal-backdrop" id="authModal">
  <div class="modal">
    <button class="close" onclick="fecharModal()">×</button>
    <h2>Entrar na sua conta</h2>
    <p>Use o e-mail e senha cadastrados para acessar sua conta MostreAki.</p>

    <div class="field">
      <label for="email">E-mail</label>
      <input type="email" id="email" autocomplete="email" placeholder="voce@exemplo.com">
    </div>

    <div class="field">
      <label for="senha">Senha</label>
      <input type="password" id="senha" autocomplete="current-password" placeholder="Sua senha">
      <div class="field-inline">
        <input type="checkbox" id="chkMostrarSenha">
        <label for="chkMostrarSenha">Mostrar senha</label>
      </div>
    </div>

    <button id="btnEntrar" type="button">Entrar</button>

    <div class="modal-links">
      <a href="/recuperar-senha.html">Esqueci minha senha</a>
      <a href="/cadastro.html">Criar nova conta</a>
    </div>
  </div>
</div>

<!-- ALERTA -->
<div id="alert">
  <div class="alert-box">
    <div class="alert-title" id="alertTitle">Aviso</div>
    <div class="alert-msg" id="alertMsg"></div>
    <div class="alert-actions" id="alertActions"></div>
  </div>
</div>

<!-- Firebase + Script -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword,
    sendEmailVerification, updateProfile
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore, collection, addDoc, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import {
    getStorage
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  const app = initializeApp({
    apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
    authDomain: "mostreaki-2025.firebaseapp.com",
    projectId: "mostreaki-2025",
    storageBucket: "mostreaki-2025.firebasestorage.app",
    messagingSenderId: "748712068097",
    appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
  });

  const auth = getAuth(app);
  const db   = getFirestore(app);
  const storage = getStorage(app);

  /* helpers */
  const $ = (id) => document.getElementById(id);
  const modal = $("authModal");
  const btnAbrir = $("btnAbrirLogin");
  const authText = $("authText");
  const userCircle = $("userCircle");

  function abrirModal() {
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
  window.fecharModal = function() {
    modal.style.display = "none";
    document.body.style.overflow = "";
  };

  btnAbrir.addEventListener("click", abrirModal);
  modal.addEventListener("click", e => {
    if (e.target === modal) fecharModal();
  });
  window.addEventListener("keydown", e => {
    if (e.key === "Escape" && modal.style.display === "flex") fecharModal();
  });

  /* alerta brand */
  const alertBG = $("alert");
  const alertTitle = $("alertTitle");
  const alertMsg = $("alertMsg");
  const alertActions = $("alertActions");

  function showAlert({ title = "Aviso", html = "", actions = [{ text: "Fechar", kind: "solid" }] }) {
    alertTitle.textContent = title;
    alertMsg.innerHTML = html;
    alertActions.innerHTML = "";
    actions.forEach(a => {
      const b = document.createElement("button");
      b.className = a.kind === "ghost" ? "btn-ghost" : "btn-solid";
      b.textContent = a.text;
      b.onclick = () => {
        if (a.onClick) a.onClick();
        closeAlert();
      };
      alertActions.appendChild(b);
    });
    alertBG.style.display = "flex";
  }
  function closeAlert() {
    alertBG.style.display = "none";
  }

  /* mostrar senha */
  (function wireShowPassword() {
    const input = $("senha"), chk = $("chkMostrarSenha");
    if (!input || !chk) return;
    const apply = () => { input.type = chk.checked ? "text" : "password"; };
    chk.addEventListener("change", apply);
  })();

  /* bloqueio progressivo */
  const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
  const emailValido = v => emailRe.test(v);

  function getState() {
    const now = Date.now();
    const s = JSON.parse(sessionStorage.getItem("loginState") || "{}");
    if (!s.lockUntil) s.lockUntil = 0;
    if (!s.failCount) s.failCount = 0;
    if (!s.blockMult) s.blockMult = 1;
    if (now > s.lockUntil) s.lockUntil = 0;
    return s;
  }
  function setState(s) {
    sessionStorage.setItem("loginState", JSON.stringify(s));
  }
  function isLocked() {
    const s = getState();
    return s.lockUntil && Date.now() < s.lockUntil;
  }
  function lockMore() {
    const s = getState();
    const base = 30000;
    s.blockMult = Math.min(s.blockMult * 2, 8);
    s.lockUntil = Date.now() + base * s.blockMult;
    setState(s);
  }
  function incFail() {
    const s = getState();
    s.failCount = (s.failCount || 0) + 1;
    if (s.failCount >= 5) {
      s.failCount = 0;
      lockMore();
    }
    setState(s);
  }
  function resetFails() {
    setState({ failCount: 0, blockMult: 1, lockUntil: 0 });
  }
  function showLockMsg() {
    const s = getState();
    const secs = Math.ceil((s.lockUntil - Date.now()) / 1000);
    showAlert({
      title: "Muitas tentativas",
      html: `Aguarde <b>${secs}s</b> para tentar novamente.`
    });
  }

  // LOG de login
  async function logLogin(email, status, errorCode = null) {
    try {
      await addDoc(collection(db, "logs_login"), {
        email,
        status,
        errorCode,
        timestamp: serverTimestamp(),
        userAgent: navigator.userAgent
      });
    } catch (e) {
      console.error("Erro ao registrar log:", e);
    }
  }

  // Atualizar foto de perfil (se tiver)
  async function updateFotoPerfil(user, photoURL) {
    if (photoURL) {
      try {
        await updateProfile(user, { photoURL });
        localStorage.setItem("fotoPerfil", photoURL);
      } catch (e) {
        console.error("Erro ao atualizar foto de perfil:", e);
      }
    }
  }

  async function loginEmailSenha() {
    if (isLocked()) return showLockMsg();

    const email = $("email").value.trim();
    const senha = $("senha").value;

    if (!email) {
      incFail();
      await logLogin(email, "erro", "email_vazio");
      return showAlert({ title: "E-mail vazio", html: "Digite seu e-mail para continuar." });
    }
    if (!emailValido(email)) {
      incFail();
      await logLogin(email, "erro", "email_invalido");
      return showAlert({ title: "E-mail inválido", html: "Revise o endereço digitado." });
    }
    if (!senha) {
      incFail();
      await logLogin(email, "erro", "senha_vazia");
      return showAlert({ title: "Senha vazia", html: "Digite sua senha para continuar." });
    }

    try {
      const cred = await signInWithEmailAndPassword(auth, email, senha);

      if (!cred.user.emailVerified) {
        await sendEmailVerification(cred.user);
        await logLogin(email, "email_nao_verificado");
        showAlert({
          title: "Confirme seu e-mail",
          html: `Seu e-mail ainda não foi verificado.<br>Reenviamos o link para <b>${email}</b>. 
                 Verifique sua caixa de entrada (ou spam) e tente novamente após confirmar.`
        });
        return;
      }

      resetFails();
      await logLogin(email, "sucesso");
      await updateFotoPerfil(cred.user, cred.user.photoURL);
      fecharModal();
      // na página de teste vamos só recarregar:
      location.reload();

    } catch (e) {
      incFail();
      await logLogin(email, "erro", e.code);
      const codes = ["auth/invalid-credential", "auth/wrong-password", "auth/user-not-found"];
      if (codes.includes(e.code)) {
        if (isLocked()) return showLockMsg();
        return showAlert({
          title: "Não conseguimos entrar",
          html: "E-mail e/ou senha incorretos. Você pode tentar novamente ou recuperar a senha.",
          actions: [
            { text: "Recuperar senha", kind: "ghost", onClick: () => location.href = "/recuperar-senha.html" },
            { text: "Cadastrar",       kind: "ghost", onClick: () => location.href = "/cadastro.html" },
            { text: "Fechar",          kind: "solid" }
          ]
        });
      }
      if (e.code === "auth/too-many-requests") {
        lockMore();
        return showLockMsg();
      }
      if (e.code === "auth/invalid-email") {
        return showAlert({ title: "E-mail inválido", html: "Revise o endereço digitado." });
      }
      showAlert({ title: "Erro", html: `Erro inesperado (${e.code}). Tente novamente.` });
    }
  }

  $("btnEntrar").onclick = loginEmailSenha;
  document.addEventListener("keydown", e => {
    if (e.key === "Enter" && modal.style.display === "flex") loginEmailSenha();
  });

  // Estado de auth: mostrar/ocultar Entrar, Sair e avatar
  onAuthStateChanged(auth, (user) => {
    const fotoURL = localStorage.getItem("fotoPerfil");
    if (user) {
      if (fotoURL) {
        userCircle.style.backgroundImage = `url('${fotoURL}')`;
        userCircle.textContent = "";
      } else {
        const nome = (user.displayName || user.email || "?").trim();
        userCircle.textContent = nome.charAt(0).toUpperCase();
        userCircle.style.backgroundImage = "";
      }
      userCircle.style.display = "flex";
      authText.style.display = "inline";
      btnAbrir.style.display = "none";
    } else {
      userCircle.style.display = "none";
      authText.style.display  = "none";
      btnAbrir.style.display  = "inline-block";
    }
  });

  // sair
  authText.addEventListener("click", async () => {
    try {
      await signOut(auth);
      await logLogin("desconhecido", "logout");
      localStorage.removeItem("fotoPerfil");
      location.reload();
    } catch (e) {
      showAlert({ title: "Sair", html: "Não foi possível sair. Tente de novo." });
    }
  });

  // opcional: clicar no avatar leva para /minha-conta
  userCircle.addEventListener("click", () => {
    location.href = "/minha-conta.html";
  });

</script>

</body>
</html>
