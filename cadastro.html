<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro – MostreAki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --fundo: #92a9a6;
      --fundo-card: #cfe0dd;
      --bordo: #7d2f59;
      --bordo-escuro: #5b123a;
      --verde-escuro: #003735;
      --texto: #23313a;
      --grad1: #d9d9d9;
      --grad2: #af91a1;
      --radius-pill: 999px;
      --shadow-soft: 0 4px 10px rgba(0,0,0,.18);
      --shadow-light: 0 2px 6px rgba(0,0,0,.12);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--fundo);
      color: var(--texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: var(--bordo);
      text-decoration: none;
    }

    /* ===== TOPBAR ===== */
    header {
      background: #c6d7d4;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: .4rem .9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: .45rem;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: linear-gradient(145deg,#cee3f2,#cfcfcf);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--bordo);
      box-shadow: var(--shadow-light);
    }

    .brand-text {
      font-weight: 800;
      font-size: 1.3rem;
      color: var(--verde-escuro);
    }

    .brand-text span {
      color: var(--bordo);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: .6rem;
    }

    .btn-login {
      padding: .45rem 1.1rem;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg,var(--bordo),var(--bordo-escuro));
      color: #fff;
      font-weight: 600;
      box-shadow: var(--shadow-soft);
      font-size: .9rem;
    }

    .user-circle {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: var(--bordo);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: .95rem;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      box-shadow: var(--shadow-light);
    }

    .burger {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid var(--bordo);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
    }

    .burger span,
    .burger span::before,
    .burger span::after {
      display: block;
      width: 18px;
      height: 2px;
      border-radius: 999px;
      background: var(--bordo);
      position: absolute;
      transition: .2s ease;
    }

    .burger span::before {
      content: "";
      transform: translateY(-5px);
    }

    .burger span::after {
      content: "";
      transform: translateY(5px);
    }

    .topbar-strip {
      height: 4px;
      background: var(--bordo);
    }

    nav#menu {
      display: none;
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      padding: .9rem 1rem 1.2rem;
    }

    nav#menu.open {
      display: block;
    }

    .menu-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: .55rem;
    }

    .menu-link {
      width: 210px;
      max-width: 92vw;
      align-self: center;
      white-space: nowrap;
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      border-radius: 999px;
      padding: .55rem 1rem;
      text-align: center;
      color: var(--bordo);
      text-decoration: none;
      font-weight: 600;
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      font-size: .95rem;
    }

    /* ===== MAIN / CARD ===== */
    main {
      flex: 1;
      padding: 1.6rem .85rem 2.2rem;
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    .page-title {
      font-size: 2rem;
      color: var(--verde-escuro);
      margin-bottom: .4rem;
      font-weight: 800;
    }

    .page-sub {
      max-width: 620px;
      font-size: 1rem;
      color: #20313a;
      line-height: 1.5;
      margin-bottom: 1.6rem;
    }

    .card {
      background: #e2eeeb;
      border-radius: 24px;
      padding: 1.4rem 1.2rem 1.8rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0,0,0,.05);
    }

    @media (min-width: 768px) {
      .card {
        padding: 1.8rem 2rem 2.1rem;
      }
    }

    h2.section-title {
      font-size: 1.35rem;
      color: var(--verde-escuro);
      margin-bottom: .4rem;
    }

    p.section-text {
      font-size: .98rem;
      color: #3c4a52;
      margin-bottom: 1.2rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 1rem;
    }

    @media (min-width: 700px) {
      .form-grid {
        grid-template-columns: minmax(0,1.1fr) minmax(0,1.1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }

    .field label {
      font-size: .9rem;
      font-weight: 600;
      color: var(--verde-escuro);
    }

    .field small {
      font-size: .78rem;
      color: #55636b;
    }

    .input,
    .input-readonly {
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      padding: .6rem .85rem;
      font-size: .95rem;
      background: #f6fbfa;
      outline: none;
      transition: border-color .15s, box-shadow .15s, background .15s;
      width: 100%;
    }

    .input:focus {
      border-color: var(--bordo);
      box-shadow: 0 0 0 2px rgba(125,47,89,.25);
      background: #ffffff;
    }

    .input-readonly {
      background: #e8f0ee;
      color: #5c6a72;
    }

    .slug-preview {
      font-size: .8rem;
      color: #44545c;
      margin-top: -0.25rem;
    }

    .slug-preview code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .78rem;
      background: rgba(0,0,0,.04);
      padding: .05rem .35rem;
      border-radius: 999px;
    }

    .btn-primary,
    .btn-ghost,
    .btn-outline {
      border-radius: var(--radius-pill);
      padding: .7rem 1.4rem;
      font-size: .95rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .4rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(180deg,var(--bordo),var(--bordo-escuro));
      color: #fff;
      box-shadow: var(--shadow-soft);
      width: 100%;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(0,0,0,.18);
      color: var(--bordo);
      width: 100%;
      background: linear-gradient(180deg,#f7f7f7,#e4dde6);
      box-shadow: var(--shadow-light);
    }

    .btn-google-icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .9rem;
    }

    .or-row {
      text-align: center;
      margin: 1.1rem 0 .8rem;
      font-size: .85rem;
      color: #6a777f;
      position: relative;
    }

    .or-row::before,
    .or-row::after {
      content: "";
      position: absolute;
      height: 1px;
      background: rgba(0,0,0,.12);
      top: 50%;
      width: 33%;
    }

    .or-row::before { left: 0; }
    .or-row::after { right: 0; }

    .terms {
      margin-top: .9rem;
      font-size: .8rem;
      color: #5a676f;
    }

    .help-text {
      margin-top: .7rem;
      font-size: .85rem;
    }

    /* ===== ALERTA BRAND ===== */
    #alert {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    #alertPanel {
      background: #f6fbfa;
      border-radius: 18px;
      max-width: 360px;
      width: 92vw;
      padding: 1.1rem 1.2rem 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(0,0,0,.12);
    }

    #alertTitle {
      font-weight: 700;
      color: var(--verde-escuro);
      margin-bottom: .4rem;
      font-size: 1.05rem;
    }

    #alertMsg {
      font-size: .9rem;
      color: #34424a;
      margin-bottom: .9rem;
    }

    #alertActions {
      display: flex;
      gap: .5rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .btn-solid {
      border-radius: var(--radius-pill);
      padding: .45rem 1.1rem;
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg,var(--bordo),var(--bordo-escuro));
      color: #fff;
      font-weight: 600;
      font-size: .9rem;
    }

    .btn-ghost {
      border-radius: var(--radius-pill);
      padding: .45rem 1.1rem;
      border: 1px solid rgba(0,0,0,.15);
      cursor: pointer;
      background: #ffffff;
      color: var(--bordo);
      font-weight: 600;
      font-size: .9rem;
    }

    /* ===== FOOTER ===== */
    footer {
      margin-top: auto;
      background: #c6d7d4;
      padding-top: 1.1rem;
    }

    .footer-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 .9rem 1rem;
      font-size: .8rem;
      color: #37454d;
      display: flex;
      flex-direction: column;
      gap: .3rem;
    }

    footer img {
      display: block;
      max-width: 140px;
      margin-bottom: .4rem;
    }

    .footer-strip {
      height: 4px;
      background: var(--bordo);
      margin-top: .4rem;
    }

    @media (min-width: 720px) {
      .footer-inner {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar-inner">
      <a href="index.html" class="brand">
        <div class="brand-logo">↑</div>
        <div class="brand-text">Mostre<span>Aki</span></div>
      </a>
      <div class="topbar-right">
        <button id="btnAbrirLogin" class="btn-login" type="button" onclick="location.href='index.html'">
          Entrar
        </button>
        <div id="userCircle" class="user-circle" title="Minha conta"></div>
        <button class="burger" type="button" onclick="toggleMenu()">
          <span></span>
        </button>
      </div>
    </div>
    <div class="topbar-strip"></div>
    <nav id="menu">
      <div class="menu-inner">
        <a href="index.html#sobre" class="menu-link">Sobre</a>
        <a href="minha-conta.html" class="menu-link">Minha Conta</a>
        <a href="planos.html" class="menu-link">Planos</a>
        <a href="parceiros.html" class="menu-link">Parceiros</a>
        <a href="servicos-adicionais.html" class="menu-link">Serviços Adicionais</a>
        <a href="instrucoes.html" class="menu-link">Instruções</a>
        <a href="contato.html" class="menu-link">Contato</a>
      </div>
    </nav>
  </header>

  <!-- ALERTA BRAND -->
  <div id="alert">
    <div id="alertPanel">
      <div id="alertTitle">Aviso</div>
      <div id="alertMsg"></div>
      <div id="alertActions"></div>
    </div>
  </div>

  <main>
    <div class="shell">
      <h1 class="page-title">Criar conta</h1>
      <p class="page-sub">
        Cadastre-se para gerenciar sua assinatura, catálogo digital e receber suporte do MostreAki.
        O nome de usuário será usado como <b>slug</b> nos links públicos.
      </p>

      <section class="card">
        <h2 class="section-title">Dados de acesso</h2>
        <p class="section-text">
          Preencha seu nome de usuário, WhatsApp e escolha se prefere criar a conta com
          <b>e-mail e senha</b> ou entrar com o <b>Google</b>.
        </p>

        <form id="formCadastro" autocomplete="off">
          <div class="form-grid">
            <div class="field">
              <label for="username">Nome de usuário (slug)</label>
              <input id="username" class="input" type="text" maxlength="40"
                     placeholder="ex: lamaggie, doceria-da-lu" required>
              <div class="slug-preview">
                Seu link ficará assim:
                <code>mostreaki.com.br/cat/<span id="slugPreview">slug-exemplo</span></code>
              </div>
              <small>Esse será o identificador do seu catálogo e álbum digital.</small>
            </div>

            <div class="field">
              <label for="whats">WhatsApp / celular</label>
              <input id="whats" class="input" type="tel"
                     placeholder="(99) 99999-9999" required>
              <small>Usado apenas para contato e suporte. Não compartilhamos com terceiros.</small>
            </div>

            <div class="field">
              <label for="email">E-mail de acesso</label>
              <input id="email" class="input" type="email"
                     placeholder="voce@exemplo.com" required>
            </div>

            <div class="field">
              <label for="senha">Senha</label>
              <input id="senha" class="input" type="password" minlength="6" required>
              <small>Mínimo de 6 caracteres.</small>
            </div>
          </div>

          <div class="terms">
            Ao criar sua conta, você concorda com o uso do seu e-mail apenas para
            autenticação, avisos importantes e comunicação sobre sua assinatura.
          </div>

          <div style="margin-top:1.2rem; display:flex; flex-direction:column; gap:.6rem;">
            <button id="btnCriarEmail" class="btn-primary" type="submit">
              Criar conta com e-mail
            </button>
          </div>
        </form>

        <div class="or-row">ou</div>

        <button id="btnGoogle" class="btn-outline" type="button">
          <span class="btn-google-icon">G</span>
          <span>Continuar com Google</span>
        </button>

        <p class="help-text">
          Já tem cadastro? <a href="index.html"><b>Entrar</b></a>
        </p>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-inner">
      <div>
        <!-- se tiver logo em SVG/PNG pode colocar aqui -->
        <!-- <img src="logo-mostreaki-footer.svg" alt="MostreAki"> -->
        <div><b>MostreAki</b> &copy; <span id="anoFooter"></span></div>
      </div>
      <div>
        <span>suporte@mostreaki.com.br</span>
      </div>
    </div>
    <div class="footer-strip"></div>
  </footer>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      updateProfile,
      sendEmailVerification,
      GoogleAuthProvider,
      signInWithPopup
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      doc,
      setDoc,
      getDocs,
      query,
      where,
      collection,
      serverTimestamp,
      limit
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    });

    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $  = (id) => document.getElementById(id);
    const formCadastro = $("formCadastro");
    const usernameInput = $("username");
    const whatsInput = $("whats");
    const emailInput = $("email");
    const senhaInput = $("senha");
    const slugPreview = $("slugPreview");
    const btnGoogle = $("btnGoogle");
    const btnAbrirLogin = $("btnAbrirLogin");
    const userCircle = $("userCircle");
    const alertBG = $("alert");
    const alertTitle = $("alertTitle");
    const alertMsg = $("alertMsg");
    const alertActions = $("alertActions");

    function showAlert({ title = "Aviso", html = "", actions = [{ text: "Fechar", kind: "solid" }] }) {
      alertTitle.textContent = title;
      alertMsg.innerHTML = html;
      alertActions.innerHTML = "";
      actions.forEach(a => {
        const b = document.createElement("button");
        b.className = a.kind === "ghost" ? "btn-ghost" : "btn-solid";
        b.textContent = a.text;
        b.onclick = () => {
          if (a.onClick) a.onClick();
          closeAlert();
        };
        alertActions.appendChild(b);
      });
      alertBG.style.display = "flex";
    }

    function closeAlert() {
      alertBG.style.display = "none";
    }

    alertBG.addEventListener("click", e => {
      if (e.target === alertBG) closeAlert();
    });

    // ===== MENU =====
    window.toggleMenu = function () {
      const menu = document.getElementById("menu");
      menu.classList.toggle("open");
    };

    // ===== SLUGIFY =====
    function slugify(value) {
      return value
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .substring(0, 40);
    }

    usernameInput.addEventListener("input", () => {
      const slug = slugify(usernameInput.value || "");
      slugPreview.textContent = slug || "slug-exemplo";
    });

    // verifica se já existe alguma conta com a mesma slug
    async function slugJaExiste(slug) {
      const q = query(
        collection(db, "usuarios"),
        where("catalogoSlug", "==", slug),
        limit(1)
      );
      const snap = await getDocs(q);
      return !snap.empty;
    }

    async function criarDocsBasicos({ uid, email, slug, username, whats }) {
      const agora = serverTimestamp();

      await setDoc(doc(db, "usuarios", uid), {
        email,
        username,
        whats,
        catalogoSlug: slug,
        catalogoAtivo: false,
        albumAtivo: false,
        fotoPerfil: "",
        createdAt: agora,
        updatedAt: agora
      }, { merge: true });

      await setDoc(doc(db, "catalogos", slug), {
        ownerUid: uid,
        catalogoAtivo: false,
        createdAt: agora,
        updatedAt: agora
      }, { merge: true });
    }

    // ===== CADASTRO COM E-MAIL =====
    formCadastro.addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = usernameInput.value.trim();
      const whats = whatsInput.value.trim();
      const email = emailInput.value.trim();
      const senha = senhaInput.value;

      const slug = slugify(username);

      if (!username || !whats || !email || !senha) {
        return showAlert({ title: "Campos obrigatórios", html: "Preencha todos os campos para continuar." });
      }
      if (!slug || slug.length < 3) {
        return showAlert({
          title: "Nome de usuário inválido",
          html: "Escolha um nome de usuário com pelo menos 3 letras/números."
        });
      }
      if (await slugJaExiste(slug)) {
        return showAlert({
          title: "Slug já usada",
          html: `O identificador <b>${slug}</b> já está em uso. Tente outra combinação.`
        });
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        await updateProfile(cred.user, { displayName: username });
        await criarDocsBasicos({
          uid: cred.user.uid,
          email,
          slug,
          username,
          whats
        });
        await sendEmailVerification(cred.user);

        showAlert({
          title: "Conta criada!",
          html: `Enviamos um e-mail de confirmação para <b>${email}</b>.<br>
                 Confirme o endereço e depois clique em <b>Entrar</b> na página inicial.`,
          actions: [
            { text: "Ir para página inicial", kind: "solid", onClick: () => location.href = "index.html" }
          ]
        });

      } catch (err) {
        console.error(err);
        let msg = "Não foi possível criar a conta. Tente novamente.";
        if (err.code === "auth/email-already-in-use") {
          msg = "Este e-mail já está em uso. Tente entrar ou recuperar a senha.";
        } else if (err.code === "auth/weak-password") {
          msg = "A senha é muito fraca. Use pelo menos 6 caracteres.";
        }
        showAlert({ title: "Erro ao cadastrar", html: msg });
      }
    });

    // ===== GOOGLE SIGN-IN =====
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    btnGoogle.addEventListener("click", async () => {
      const username = usernameInput.value.trim();
      const whats = whatsInput.value.trim();
      const slug = slugify(username);

      if (!username || !whats) {
        return showAlert({
          title: "Informe os dados",
          html: "Para continuar com o Google, preencha o nome de usuário e o WhatsApp."
        });
      }
      if (!slug || slug.length < 3) {
        return showAlert({
          title: "Nome de usuário inválido",
          html: "Escolha um nome de usuário com pelo menos 3 letras/números."
        });
      }
      if (await slugJaExiste(slug)) {
        return showAlert({
          title: "Slug já usada",
          html: `O identificador <b>${slug}</b> já está em uso. Tente outra combinação.`
        });
      }

      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        await updateProfile(user, { displayName: username });
        await criarDocsBasicos({
          uid: user.uid,
          email: user.email,
          slug,
          username,
          whats
        });

        showAlert({
          title: "Conta conectada!",
          html: "Login com Google realizado com sucesso. Vamos para a sua conta.",
          actions: [
            { text: "Ir para Minha Conta", kind: "solid", onClick: () => location.href = "minha-conta.html" }
          ]
        });

      } catch (err) {
        console.error(err);
        if (err.code === "auth/popup-closed-by-user") return;
        showAlert({
          title: "Erro ao entrar com Google",
          html: "Não foi possível concluir o login com Google. Tente novamente."
        });
      }
    });

    // ===== ESTADO DE AUTH NO HEADER =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const nome = (user.displayName || user.email || "?").trim();
        userCircle.textContent = nome.charAt(0).toUpperCase();
        userCircle.style.display = "flex";
        btnAbrirLogin.style.display = "none";
        userCircle.onclick = () => location.href = "minha-conta.html";
      } else {
        userCircle.style.display = "none";
        btnAbrirLogin.style.display = "inline-block";
      }
    });

    // ano footer
    document.getElementById("anoFooter").textContent = new Date().getFullYear();
  </script>
</body>
</html>
