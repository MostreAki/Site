<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Entrar – MostreAki</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root {
      --bg: #aabcbb;
      --header-footer: #cde0e0;
      --bordo: #7d2f59;
      --texto: #003735;
      --grad1: #d9d9d9;
      --grad2: #af91a1;
      --card: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #cfe0e0, #92a9a6);
      font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== Header MostreAki ===== */
    header {
      background: var(--header-footer);
      border-bottom: 3px solid var(--bordo);
      padding: .4rem .9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    header img {
      height: 55px;
      max-width: 190px;
      object-fit: contain;
      display: block;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: .75rem;
    }

    .header-auth-label {
      font-size: .85rem;
      color: var(--texto);
      cursor: pointer;
      display: none;
    }

    .user-circle {
      background: var(--bordo);
      color: #fff;
      font-weight: 600;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      display: none;
      align-items: center;
      justify-content: center;
      background-size: cover;
      background-position: center;
      font-size: .9rem;
      cursor: pointer;
      flex: 0 0 34px;
    }

    .hamburger {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid var(--bordo);
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      padding: 0;
    }
    .hamburger span {
      display: block;
      width: 60%;
      height: 3px;
      border-radius: 999px;
      background: var(--bordo);
    }

    /* ===== Menu lateral ===== */
    .menu-overlay {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .15);
      display: none;
      justify-content: flex-end;
      z-index: 999;
    }
    .menu-overlay.show { display: flex; }

    .menu-panel {
      width: 280px;
      max-width: 90vw;
      background: #92a9a6;
      box-shadow: -4px 0 12px rgba(0, 0, 0, .09);
      height: 100%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: .55rem;
    }

    .menu-link {
      width: 210px;
      max-width: 92vw;
      align-self: center;
      white-space: nowrap;
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      border-radius: 999px;
      padding: .55rem 1rem;
      text-align: center;
      color: var(--bordo);
      text-decoration: none;
      font-weight: 600;
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      font-size: .95rem;
    }
    .menu-link:hover {
      filter: brightness(1.03);
      transform: translateY(-1px);
    }

    /* ===== Main ===== */
    main {
      flex: 1;
      max-width: min(1100px, 94vw);
      margin: 2.2rem auto 2.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-wrapper {
      width: 100%;
      max-width: 460px;
    }

    .page-title {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 0 0 .3rem;
      color: var(--texto);
      text-align: center;
    }
    .page-sub {
      font-size: .9rem;
      color: #214b4a;
      margin: 0 0 1.4rem;
      text-align: center;
    }

    .card {
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.16);
      padding: 1.4rem 1.6rem 1.6rem;
      border: 2px solid rgba(125,47,89,0.25);
    }

    .card h2 {
      font-size: 1.1rem;
      margin: 0 0 .8rem;
      color: var(--texto);
      text-align: left;
    }

    .field-group {
      margin-bottom: 1rem;
    }
    .field-group label {
      display: block;
      font-size: .9rem;
      margin-bottom: .25rem;
      color: #234;
    }
    .field-group input[type="email"],
    .field-group input[type="password"] {
      width: 100%;
      padding: .55rem .75rem;
      border-radius: 10px;
      border: 1px solid #c3c9cf;
      font-size: .9rem;
      outline: none;
      background: #f7f8fa;
    }

    .show-pass-row {
      display: flex;
      align-items: center;
      gap: .4rem;
      margin-top: -.3rem;
      margin-bottom: .6rem;
      font-size: .8rem;
      color: #445;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .4rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: .9rem;
      font-weight: 600;
      padding: .55rem 1.2rem;
      text-decoration: none;
      transition: .18s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      border: 2px solid rgba(125,47,89,0.4);
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
      width: 100%;
      justify-content: center;
    }
    .btn-primary:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
    }

    .btn-google {
      background: #ffffff;
      color: #444;
      border-radius: 999px;
      border: 1px solid #d0d7df;
      padding: .55rem 1.1rem;
      font-size: .9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .55rem;
      width: 100%;
      margin-top: .6rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }
    .btn-google img {
      width: 18px;
      height: 18px;
    }
    .btn-google:hover {
      background: #f5f7fa;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 1rem 0 .8rem;
      font-size: .8rem;
      color: #667;
    }
    .divider span {
      flex: 1;
      height: 1px;
      background: #d0d6dd;
    }
    .divider b {
      margin: 0 .6rem;
      font-weight: 500;
    }

    .links-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .82rem;
      margin-top: .8rem;
      flex-wrap: wrap;
      gap: .4rem .6rem;
    }
    .links-row a {
      color: var(--bordo);
      text-decoration: none;
      font-weight: 600;
    }
    .links-row a:hover {
      text-decoration: underline;
    }

    .hint {
      font-size: .8rem;
      color: #566;
      margin-top: .2rem;
    }

    /* ===== Alert brand ===== */
    .alert-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    .alert-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      max-width: 460px;
      width: 100%;
      box-shadow: 0 22px 70px rgba(0,0,0,.25);
      border: 2px solid #cde0e0;
    }
    .alert-head {
      background: linear-gradient(90deg,#cde0e0,#af91a1);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .alert-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #FA1E39;
    }
    .alert-title {
      color: #003735;
      font-weight: 700;
      font-size: .98rem;
    }
    .alert-body {
      padding: 16px;
      color: #223;
      font-size: .9rem;
    }
    .alert-actions {
      padding: 10px 16px 14px;
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
      background: #f7faf9;
    }
    .btn-alert-primary {
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      border-radius: 999px;
      border: 2px solid rgba(125,47,89,0.4);
      font-size: .85rem;
      font-weight: 600;
      padding: .45rem 1rem;
      cursor: pointer;
    }
    .btn-alert-ghost {
      background: transparent;
      color: var(--bordo);
      border-radius: 999px;
      border: 1px dashed rgba(125,47,89,0.7);
      font-size: .85rem;
      font-weight: 600;
      padding: .45rem .9rem;
      cursor: pointer;
    }

    footer {
      background: var(--header-footer);
      padding: 1rem;
      font-size: .85rem;
      text-align: center;
      color: #444;
      margin-top: auto;
      border-top: 3px solid var(--bordo);
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" aria-label="Voltar para a página inicial">
      <img src="logomarca.svg" alt="MostreAki">
    </a>

    <div class="header-right">
      <div id="authText" class="header-auth-label" title="Clique para sair">
        Sair
      </div>
      <div id="userCircle" class="user-circle" title="Minha conta"></div>

      <button class="hamburger" type="button" onclick="toggleMenu()" aria-label="Abrir menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <!-- Menu lateral -->
  <nav id="menu" class="menu-overlay" aria-label="Menu principal">
    <div class="menu-panel">
      <a class="menu-link" href="index.html">Início</a>
      <a class="menu-link" href="planos.html">Planos</a>
      <a class="menu-link" href="parceiros.html">Templates de Parceiros</a>
      <a class="menu-link" href="servicos-adicionais.html">Serviços Adicionais</a>
      <a class="menu-link" href="instrucoes.html">Instruções</a>
      <a class="menu-link" href="sobre.html">Sobre o MostreAki</a>
      <a class="menu-link" href="contato.html">Contato</a>
    </div>
  </nav>

  <!-- ALERTA -->
  <div id="alert" class="alert-bg" role="alertdialog" aria-modal="true">
    <div class="alert-card">
      <div class="alert-head">
        <div class="alert-dot"></div>
        <div id="alertTitle" class="alert-title">Aviso</div>
      </div>
      <div id="alertMsg" class="alert-body">Mensagem.</div>
      <div id="alertActions" class="alert-actions"></div>
    </div>
  </div>

  <main>
    <div class="login-wrapper">
      <h1 class="page-title">Entrar no MostreAki</h1>
      <p class="page-sub">
        Acesse sua conta para gerenciar sua assinatura, catálogo e presença digital.
      </p>

      <article class="card">
        <h2>Login com e-mail</h2>

        <div class="field-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" autocomplete="email" />
        </div>

        <div class="field-group">
          <label for="senha">Senha</label>
          <input type="password" id="senha" autocomplete="current-password" />
        </div>

        <div class="show-pass-row">
          <input type="checkbox" id="chkMostrarSenha" />
          <label for="chkMostrarSenha">Mostrar senha</label>
        </div>

        <button class="btn btn-primary" type="button" id="btnEntrarEmail">
          Entrar
        </button>

        <div class="links-row">
          <a href="recuperar-senha.html">Esqueci minha senha</a>
          <span>Não tem conta? <a href="cadastro.html">Cadastrar</a></span>
        </div>

        <div class="divider">
          <span></span><b>ou</b><span></span>
        </div>

        <button class="btn-google" type="button" id="btnGoogle">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
          <span>Entrar com Google</span>
        </button>

        <p class="hint">
          Se for seu primeiro acesso com Google, vamos pedir seu nome de usuário e WhatsApp
          na próxima tela para criar sua slug e vincular sua conta.
        </p>
      </article>
    </div>
  </main>

  <footer>
    MostreAki &copy; 2025 — Fortalecendo a identidade da sua marca no universo digital.
  </footer>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      sendEmailVerification
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      doc,
      getDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const $ = (id) => document.getElementById(id);

    const menu = $("menu");
    window.toggleMenu = function () {
      if (!menu) return;
      menu.classList.toggle("show");
    };
    if (menu) {
      menu.addEventListener("click", (e) => {
        if (e.target === menu) menu.classList.remove("show");
      });
    }

    const alertBG = $("alert");
    const alertTitle = $("alertTitle");
    const alertMsg = $("alertMsg");
    const alertActions = $("alertActions");

    function showAlert({ title = "Aviso", html = "", actions = [{ text: "Fechar", kind: "primary" }] }) {
      alertTitle.textContent = title;
      alertMsg.innerHTML = html;
      alertActions.innerHTML = "";
      actions.forEach(a => {
        const btn = document.createElement("button");
        btn.className = a.kind === "ghost" ? "btn-alert-ghost" : "btn-alert-primary";
        btn.textContent = a.text;
        btn.onclick = () => {
          if (a.onClick) a.onClick();
          closeAlert();
        };
        alertActions.appendChild(btn);
      });
      alertBG.style.display = "flex";
    }
    function closeAlert() { alertBG.style.display = "none"; }
    alertBG.addEventListener("click", (e) => {
      if (e.target === alertBG) closeAlert();
    });

    const userCircle = $("userCircle");
    const authText = $("authText");

    /* ===== Mostrar senha ===== */
    (function wireShowPassword() {
      const input = $("senha"), chk = $("chkMostrarSenha");
      if (!input || !chk) return;
      const apply = () => { input.type = chk.checked ? "text" : "password"; };
      chk.addEventListener("change", apply);
    })();

    /* ===== Anti força-bruta (lock progressivo) ===== */
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    const emailValido = v => emailRe.test(v);

    function getState() {
      const now = Date.now();
      const s = JSON.parse(sessionStorage.getItem('loginState') || '{}');
      if (!s.lockUntil) s.lockUntil = 0;
      if (!s.failCount) s.failCount = 0;
      if (!s.blockMult) s.blockMult = 1;
      if (now > s.lockUntil) s.lockUntil = 0;
      return s;
    }
    function setState(s) {
      sessionStorage.setItem('loginState', JSON.stringify(s));
    }
    function isLocked() {
      const s = getState();
      return s.lockUntil && Date.now() < s.lockUntil;
    }
    function lockMore() {
      const s = getState();
      const base = 30000; // 30s
      s.blockMult = Math.min(s.blockMult * 2, 8);
      s.lockUntil = Date.now() + base * s.blockMult;
      setState(s);
    }
    function incFail() {
      const s = getState();
      s.failCount = (s.failCount || 0) + 1;
      if (s.failCount >= 5) {
        s.failCount = 0;
        lockMore();
      }
      setState(s);
    }
    function resetFails() {
      setState({ failCount: 0, blockMult: 1, lockUntil: 0 });
    }
    function showLockMsg() {
      const s = getState();
      const secs = Math.ceil((s.lockUntil - Date.now()) / 1000);
      showAlert({
        title: "Muitas tentativas",
        html: `Aguarde <b>${secs}s</b> para tentar novamente.`
      });
    }

    function hasProfileData(data) {
      if (!data) return false;
      const slug = data.slug || data.username || data.catalogoSlug;
      const cel = data.celular || data.whatsapp || data.telefone;
      return !!(slug && cel);
    }

    async function checkProfileAndRedirect(user) {
      try {
        const userDocRef = doc(db, "usuarios", user.uid);
        const snap = await getDoc(userDocRef);
        const data = snap.exists() ? snap.data() : null;

        if (hasProfileData(data)) {
          // perfil completo → segue para Minha Conta
          window.location.href = "minha-conta.html";
        } else {
          // falta slug / celular → finalizar cadastro Google
          window.location.href = "login-google.html";
        }
      } catch (e) {
        console.error("Erro ao checar perfil:", e);
        // Em caso de erro, levar para login-google pra garantir que complete.
        window.location.href = "login-google.html";
      }
    }

    /* ===== Estado de auth global nessa página ===== */
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        if (userCircle) userCircle.style.display = "none";
        if (authText) authText.style.display = "none";
        return;
      }

      // Já logado → verifica perfil e redireciona
      checkProfileAndRedirect(user);

      // (UI visual, mesmo que só apareça rápido)
      if (userCircle) {
        const letra = (user.displayName || user.email || "?").trim().charAt(0).toUpperCase();
        userCircle.textContent = letra;
        userCircle.style.display = "flex";
      }
      if (authText) authText.style.display = "inline";
    });

    if (authText) {
      authText.addEventListener("click", async () => {
        try {
          await signOut(auth);
          localStorage.removeItem("fotoPerfil");
          localStorage.removeItem("catalogoSlug");
          window.location.href = "index.html";
        } catch (e) {
          showAlert({
            title: "Erro ao sair",
            html: "Não foi possível encerrar a sessão. Tente novamente."
          });
        }
      });
    }

    /* ===== Login com e-mail/senha ===== */
    const btnEntrarEmail = $("btnEntrarEmail");
    if (btnEntrarEmail) {
      btnEntrarEmail.addEventListener("click", async () => {
        if (isLocked()) return showLockMsg();

        const email = $("email").value.trim();
        const senha = $("senha").value;

        if (!email) {
          incFail();
          return showAlert({ title: "E-mail vazio", html: "Digite seu e-mail para continuar." });
        }
        if (!emailValido(email)) {
          incFail();
          return showAlert({ title: "E-mail inválido", html: "Revise o endereço digitado." });
        }
        if (!senha) {
          incFail();
          return showAlert({ title: "Senha vazia", html: "Digite sua senha para continuar." });
        }

        try {
          const cred = await signInWithEmailAndPassword(auth, email, senha);
          const user = cred.user;

          if (!user.emailVerified) {
            await sendEmailVerification(user);
            await signOut(auth);
            incFail(); // conta como falha até confirmar
            return showAlert({
              title: "Confirme seu e-mail",
              html: `Seu e-mail ainda não foi verificado.<br>
                     Enviamos novamente o link para <b>${email}</b>.<br>
                     Confirme e depois retorne para fazer login.`
            });
          }

          resetFails();
          await checkProfileAndRedirect(user);

        } catch (e) {
          console.error(e);
          incFail();

          const codes = ["auth/invalid-credential", "auth/wrong-password", "auth/user-not-found"];
          if (codes.includes(e.code)) {
            if (isLocked()) return showLockMsg();
            return showAlert({
              title: "Não conseguimos entrar",
              html: "E-mail e/ou senha incorretos. Você pode tentar novamente ou recuperar a senha.",
              actions: [
                { text: "Recuperar senha", kind: "ghost", onClick: () => window.location.href = "recuperar-senha.html" },
                { text: "Cadastrar", kind: "ghost", onClick: () => window.location.href = "cadastro.html" },
                { text: "Fechar", kind: "primary" }
              ]
            });
          }

          if (e.code === "auth/too-many-requests") {
            lockMore();
            return showLockMsg();
          }

          if (e.code === "auth/invalid-email") {
            return showAlert({ title: "E-mail inválido", html: "Revise o endereço digitado." });
          }

          showAlert({ title: "Erro", html: `Erro inesperado (${e.code || "desconhecido"}). Tente novamente.` });
        }
      });

      // Enter para enviar
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const active = document.activeElement;
          if (active && (active.id === "email" || active.id === "senha")) {
            btnEntrarEmail.click();
          }
        }
      });
    }

    /* ===== Login com Google ===== */
    const btnGoogle = $("btnGoogle");
    if (btnGoogle) {
      btnGoogle.addEventListener("click", async () => {
        if (isLocked()) return showLockMsg();

        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          resetFails();
          await checkProfileAndRedirect(user);
        } catch (e) {
          console.error(e);
          // usuário fechou popup
          if (e.code === "auth/popup-closed-by-user") {
            return; 
          }
          incFail();
          showAlert({
            title: "Não foi possível entrar com Google",
            html: "Tente novamente ou use o login por e-mail e senha."
          });
        }
      });
    }
  </script>
</body>
</html>
