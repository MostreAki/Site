<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cadastro – MostreAki</title>
<link rel="icon" href="favicon.ico" type="image/x-icon"/>
<style>
  /* ====== DESIGN BASE (inalterado) ====== */
  :root{
    --brand:#15b0af; --brandLight:#c2e7df; --accent:#FA1E39; --ink:#063b39;
    --card:#ffffff; --muted:#445; --bg:#f4f7f7; --ok:#18a957; --err:#ef4444;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    color:#222; min-height:100vh; display:flex; flex-direction:column;
    background-image:url("fundo-mobile-escuro.png");
    background-size:cover; background-repeat:no-repeat; background-attachment:fixed;
  }
  @media (min-width:768px){ body{ background-image:url("fundo-desktop.png"); } }

  /* ====== HEADER ====== */
  header{
    background:var(--brandLight); height:60px; display:flex; align-items:center; justify-content:space-between;
    padding:0 20px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  .logo-container{display:flex;align-items:center;cursor:pointer}
  .logo-container img{height:40px;margin-right:10px}
  .logo{font-size:1.5rem;font-weight:bold}
  .logo .mostre{color:#00C2BF}.logo .aki{color:#FA1E39}
  .header-auth{ display:flex; align-items:center; gap:10px; }
  .user-circle{
    background:#15b0af;color:#fff;font-weight:bold;border-radius:50%;
    width:32px;height:32px;display:flex;align-items:center;justify-content:center;
    overflow:hidden;font-size:.9rem;
  }
  .user-circle img{ width:100%; height:100%; object-fit:cover; display:block; }
  .menu-icon{ width:32px; height:32px; display:flex; align-items:center; justify-content:center; line-height:1; font-size:1.5rem; cursor:pointer; user-select:none; }
  .menu-list{
    position:absolute;top:60px;right:20px;background:#16807C;border:2px solid #000;border-radius:6px;
    display:none;flex-direction:column;padding:10px;z-index:10000;
  }
  .menu-list a{
    background:#FA1E39;color:#fff;text-decoration:none;padding:10px;margin-bottom:8px;border-radius:6px;
    text-align:center;font-weight:bold;
  }
  .menu-list a:hover{background:#b8313b}

  /* ====== CONTEÚDO ====== */
  main{ max-width:980px; margin:32px auto; padding:0 18px; width:100%; }

  .card{
    background:var(--card); border-radius:16px; width:100%;
    box-shadow:0 10px 40px rgba(0,0,0,.08); padding:22px 20px; border:2px solid var(--brandLight);
  }
  .card h1{margin:0 0 4px; color:#0f6f6e; font-size:1.45rem}
  .sub{color:#4a6665; font-size:.95rem; margin-bottom:16px}
  .section-title{margin-top:16px; font-weight:700; color:#0f6f6e}

  .form-grid{display:grid; gap:12px}
  @media (min-width:720px){ .cols-2{ grid-template-columns:1fr 1fr; } .cols-3{ grid-template-columns:1fr 1fr 1fr; } }

  .radio-row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:6px 0 2px}

  .field{ position:relative; background:#fff; border:1.5px solid #e6efed; border-radius:12px; padding:12px 12px 10px; }
  .field:focus-within{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(21,176,175,.12); }
  .field input, .field select{ width:100%; border:0; outline:0; font-size:1rem; background:transparent; padding:10px 0 2px; color:#233; }
  .field label{ position:absolute; left:12px; top:10px; color:#667; font-size:.95rem; pointer-events:none; transition:all .18s ease; background:#fff; padding:0 6px; border-radius:6px; transform-origin:left top; }

  .field.focus label:not(.showpwd),
  .field.has-value label:not(.showpwd){
    top:-8px; font-size:.78rem; color:var(--brand);
  }

  .field.pwd input{ padding-right:0; }

  .showpwd{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:.9rem;color:#444}
  .showpwd input{width:auto}

  .field label.showpwd{
    position:static; top:auto; left:auto;
    background:transparent; padding:0; margin-top:8px;
    display:flex; align-items:center; gap:8px;
    font-size:.9rem; color:#444; pointer-events:auto;
  }

  button,.btn{width:100%; margin-top:12px; padding:12px; border-radius:12px; border:0; font-weight:700; cursor:pointer; transition:filter .15s ease, transform .1s ease}
  .primary{background:linear-gradient(135deg,var(--brand) 0%, #24c5bd 100%); color:#fff}
  .primary:hover{filter:brightness(1.06)}
  .primary:active{transform:translateY(1px)}
  .muted{font-size:.92rem; color:#666; margin-top:10px}
  a{color:var(--brand); text-decoration:none; font-weight:700}

  .alert-bg{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999; padding:20px}
  .alert-card{background:#fff; border-radius:16px; overflow:hidden; max-width:520px; width:100%; box-shadow:0 22px 70px rgba(0,0,0,.25); border:2px solid var(--brandLight)}
  .alert-head{background:linear-gradient(90deg,var(--brandLight),var(--brand)); padding:14px 16px; display:flex; align-items:center; gap:10px}
  .alert-dot{width:10px; height:10px; border-radius:50%; background:var(--accent)}
  .alert-title{color:var(--ink); font-weight:700}
  .alert-body{padding:16px; color:#2b2b2b}
  .alert-actions{display:flex; gap:10px; flex-wrap:wrap; padding:0 16px 16px}
  .btn-solid{background:var(--brand); color:#fff}
  .btn-ghost{background:#fff; border:2px solid var(--brand); color:var(--brand)}

  .terms-checkbox{display:flex;align-items:center;gap:8px;margin:16px 0;font-size:.9rem;color:#444}
  .terms-checkbox input{width:auto}

  .msg{font-size:.9rem; margin-top:8px}
  .ok{color:var(--ok)} .err{color:var(--err)}

  footer{background:var(--brandLight);padding:20px;text-align:center;color:#555;font-size:.9rem;margin-top:40px}

  .ssl-seal {
    text-align: center;
    padding: 16px 0;
    background: var(--brandLight);
    margin-top: 20px;
    border-top: 1px solid rgba(250,30,39,.22);
  }
  .ssl-seal a { text-decoration: none; display: inline-block; }
  .ssl-seal img { max-width: 100px; height: auto; }
  .ssl-seal p { font-size: 0.8rem; color: var(--muted); margin: 4px 0 0; }
  .ssl-seal p:hover { color: var(--brand); }
  .ssl-seal .fallback-svg { width: 50px; height: 50px; vertical-align: middle; }
  @media (max-width: 768px) {
    .ssl-seal img { max-width: 80px; }
    .ssl-seal p { font-size: 0.75rem; }
  }

  /* NOVO BOTÃO GOOGLE */
  .btn-google{
    background:#4285F4; color:white; border:none; padding:12px 20px; 
    border-radius:12px; font-weight:700; cursor:pointer; display:flex; 
    align-items:center; justify-content:center; gap:10px; margin:20px auto 0;
    font-size:1rem; width:100%; max-width:400px;
  }
  .btn-google img{width:20px}
</style>
</head>
<body>
<header>
  <div class="logo-container" onclick="location.href='index.html'">
    <img src="logomarca-mostreaki.svg" alt="Logo">
    <div class="logo"><span class="mostre">Mostre</span><span class="aki">Aki</span></div>
  </div>
  <div class="header-auth">
    <span id="authText" style="font-weight:bold;color:#15b0af;cursor:pointer;display:none">Entrar</span>
    <div id="userCircle" class="user-circle" title="Perfil">F</div>
    <div id="menuBtn" class="menu-icon" aria-controls="menu" aria-expanded="false">Menu</div>
  </div>
  <nav class="menu-list" id="menu">
    <a href="/index.html">Página Inicial</a>
    <a href="/sobre.html">Sobre</a>
    <a href="/minha-conta.html">Minha Conta</a>
    <a href="/parceiros.html">Parceiros</a>
    <a href="/servicos-adicionais.html">Serviços Adicionais</a>
    <a href="/redes-sociais.html">Redes Sociais</a>
    <a href="/contatos.html">Contatos</a>
  </nav>
</header>

<main>
  <div class="card">
    <h1>Criar conta</h1>
    <div class="sub">Preencha seus dados para começar a usar o MostreAki.</div>

    <!-- BOTÃO GOOGLE (NOVO) -->
    <button id="btnGoogleCadastro" class="btn-google">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
      Cadastrar com Google
    </button>

    <div class="section-title" style="margin-top:24px">Ou cadastre com e-mail</div>

    <div class="section-title">Tipo de cadastro</div>
    <div class="radio-row">
      <label><input type="radio" name="tipoPessoa" value="PF" checked> Pessoa Física</label>
      <label><input type="radio" name="tipoPessoa" value="PJ"> Pessoa Jurídica</label>
    </div>

    <div class="section-title">Identidade no MostreAki</div>
    <div class="form-grid">
      <div class="field"><label for="username">Nome de usuário *</label><input id="username" required></div>
    </div>
    <div class="hint" style="margin:6px 0 10px;color:#667;font-size:.85rem">Use 3–40 caracteres. Permitidos: letras, números, ponto, hífen e underline.</div>

    <div class="form-grid" id="grupoPF">
      <div class="field"><label for="nome">Nome completo *</label><input id="nome" required autocomplete="name"></div>
      <div class="field"><label for="cpf">CPF *</label><input id="cpf" inputmode="numeric"></div>
    </div>

    <div class="form-grid" id="grupoPJ" style="display:none">
      <div class="field"><label for="razao">Razão Social *</label><input id="razao"></div>
      <div class="field"><label for="cnpj">CNPJ *</label><input id="cnpj" inputmode="numeric"></div>
      <div class="field"><label for="ie">Inscrição Estadual</label><input id="ie"></div>
      <div class="radio-row" style="margin-top:-6px">
        <label><input type="checkbox" id="isentoIE"> Isento de IE</label>
      </div>
    </div>

    <div class="section-title">Contato</div>
    <div class="form-grid cols-2">
      <div class="field"><label for="fone">Celular / WhatsApp *</label><input id="fone" type="tel" inputmode="tel" required autocomplete="tel"></div>
      <div class="field"><label for="email">E-mail *</label><input id="email" type="email" required autocomplete="email"></div>
    </div>
    <div class="form-grid cols-2">
      <div class="field"><label for="email2">Confirmar e-mail *</label><input id="email2" type="email" required></div>
    </div>

    <div class="section-title">Endereço (faturamento/NFS-e)</div>
    <div class="form-grid cols-3">
      <div class="field"><label for="cep">CEP *</label><input id="cep" inputmode="numeric"></div>
      <div class="field"><label for="uf">UF *</label>
        <select id="uf"><option value="">Selecione</option><option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option><option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option><option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option></select>
      </div>
      <div class="field"><label for="cidade">Cidade *</label><input id="cidade"></div>
    </div>
    <div class="form-grid cols-2">
      <div class="field"><label for="bairro">Bairro *</label><input id="bairro"></div>
      <div class="field"><label for="logradouro">Logradouro (rua/avenida) *</label><input id="logradouro"></div>
    </div>
    <div class="form-grid cols-2">
      <div class="field"><label for="numero">Número *</label><input id="numero" inputmode="numeric"></div>
      <div class="field"><label for="complemento">Complemento</label><input id="complemento"></div>
    </div>

    <div class="section-title">Acesso</div>
    <div class="form-grid cols-2">
      <div class="field pwd">
        <label for="senha">Senha (mín. 6) *</label>
        <input id="senha" type="password" required autocomplete="new-password">
        <label class="showpwd" for="chkMostrarSenha">
          <input id="chkMostrarSenha" type="checkbox" aria-controls="senha" aria-label="Mostrar senha">
          Mostrar senha
        </label>
      </div>
      <div class="field pwd">
        <label for="senha2">Confirmar senha *</label>
        <input id="senha2" type="password" required>
        <label class="showpwd" for="chkMostrarSenha2">
          <input id="chkMostrarSenha2" type="checkbox" aria-controls="senha2" aria-label="Mostrar confirmação">
          Mostrar senha
        </label>
      </div>
    </div>

    <button class="primary" id="btnCadastrar">Criar conta</button>
    <p class="muted">Já tem conta? <a href="/login.html">Entrar</a></p>
    <div id="status" class="msg" aria-live="polite"></div>
  </div>
</main>

<div class="ssl-seal">
  <a href="https://www.ssllabs.com/ssltest/analyze.html?d=app.mostreaki.com.br&hideResults=on" target="_blank" rel="noopener" title="Verificar Certificado SSL (SSL Labs)">
    <img src="https://seal.ssl2buy.com/images/seal/ssl2buy-seal.gif?v=2" alt="SSL Secured by SSL2BUY" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-block';">
    <svg class="fallback-svg" style="display:none;" viewBox="0 0 24 24" fill="none" stroke="#15b0af" stroke-width="2">
      <path d="M12 17v4m0-4c-2.8 0-5-2.2-5-5V8c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v4c0 2.8-2.2 5-5 5z"/>
      <path d="M9 8V6c0-1.7 1.3-3 3-3s3 1.3 3 3v2"/>
    </svg>
  </a>
  <p>Site Seguro com Certificado SSL</p>
</div>

<footer>&copy; 2025 MostreAki. Todos os direitos reservados.</footer>

<!-- POPUPS -->
<div id="alert" class="alert-bg" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
  <div class="alert-card">
    <div class="alert-head">
      <div class="alert-dot"></div>
      <div id="alertTitle" class="alert-title">Mensagem</div>
    </div>
    <div id="alertMsg" class="alert-body">...</div>
    <div id="alertActions" class="alert-actions"></div>
  </div>
</div>

<div id="termsAlert" class="alert-bg" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
  <div class="alert-card">
    <div class="alert-head">
      <div class="alert-dot"></div>
      <div id="termsTitle" class="alert-title">Aceite os Termos</div>
    </div>
    <div id="termsMsg" class="alert-body">
      Para prosseguir com o cadastro, leia e aceite nossos <a href="/termos-de-servico.html" target="_blank">Termos de Serviço</a> e <a href="/termos-privacidade.html" target="_blank">Política de Privacidade</a>.
      <div class="terms-checkbox">
        <input type="checkbox" id="chkTerms" aria-label="Aceitar Termos de Serviço e Política de Privacidade">
        <label for="chkTerms">Li e aceito os Termos de Serviço e a Política de Privacidade</label>
      </div>
    </div>
    <div id="termsActions" class="alert-actions">
      <button class="btn btn-solid" id="btnAcceptTerms" disabled>Aceito</button>
      <button class="btn btn-ghost" id="btnCancelTerms">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, updateProfile, sendEmailVerification, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

const cfg = {
  apiKey:"AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
  authDomain:"mostreaki-2025.firebaseapp.com",
  projectId:"mostreaki-2025",
  storageBucket:"mostreaki-2025.firebasestorage.app",
  messagingSenderId:"748712068097",
  appId:"1:748712068097:web:09cf043fbb45917ef6ec00"
};
const app = getApps().length ? getApp() : initializeApp(cfg);
const auth = getAuth(app);
const db   = getFirestore(app);
const stg  = getStorage(app, 'gs://mostreaki-2025.firebasestorage.app');
const googleProvider = new GoogleAuthProvider();
googleProvider.addScope('email');
googleProvider.addScope('profile');

/* ===== HEADER, UI, POPUPS (inalterados) ===== */
const cacheBust = u => u ? u + (u.includes('?')?'&':'?') + 'v=' + Date.now() : u;
function setAvatar(url){
  if(!url) return; localStorage.setItem('fotoPerfil', url);
  const el = document.getElementById('userCircle'); if(!el) return;
  el.textContent=''; el.style.display='flex';
  const img = new Image(); img.src = cacheBust(url); img.alt='Foto'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
  el.append(img);
}
(()=>{ const c = localStorage.getItem('fotoPerfil'); if(c) setAvatar(c); })();
async function prefetchFoto(uid){
  try{ const s = await getDoc(doc(db,'usuarios',uid)); const saved = s.exists() && s.data().fotoPerfil; if(saved){ setAvatar(saved); return; } }catch{}
  try{
    const tryExt = async e => getDownloadURL(ref(stg, `usuarios/${uid}/perfil/avatar.${e}`)).catch(()=>null);
    const direct = await tryExt('jpg') || await tryExt('png') || await tryExt('webp') || await tryExt('gif');
    if(direct){ try{ await setDoc(doc(db,'usuarios',uid), { fotoPerfil:direct }, { merge:true }); }catch{} setAvatar(direct); return; }
  }catch{}
  if(auth.currentUser?.photoURL) setAvatar(auth.currentUser.photoURL);
}
(function wireMenu(){
  const btn = document.getElementById('menuBtn'); const menu = document.getElementById('menu'); if(!btn||!menu) return;
  const open=()=>{menu.style.display='flex';btn.setAttribute('aria-expanded','true');document.addEventListener('click',onDoc,true);document.addEventListener('keydown',onKey)};
  const close=()=>{menu.style.display='none';btn.setAttribute('aria-expanded','false');document.removeEventListener('click',onDoc,true);document.removeEventListener('keydown',onKey)};
  const toggle=()=> menu.style.display==='flex'?close():open();
  function onDoc(e){ if(!menu.contains(e.target) && e.target!==btn) close(); }
  function onKey(e){ if(e.key==='Escape') close(); }
  btn.addEventListener('click',e=>{e.stopPropagation();toggle();});
})();
(function wireAuthUI(){
  const at = document.getElementById('authText');
  onAuthStateChanged(auth, user=>{
    if(user){ if(at){ at.textContent='Sair'; at.style.display='inline'; at.onclick = async ()=>{ await signOut(auth); localStorage.removeItem('fotoPerfil'); location='/index.html'; }; } prefetchFoto(user.uid); }
    else{ if(at){ at.textContent='Entrar'; at.style.display='inline'; at.onclick = ()=> location='/login.html'; } }
  });
})();
function wireFloat(){
  document.querySelectorAll('.field').forEach(f=>{
    const i=f.querySelector('input,select');
    const set = ()=>{ f.classList.toggle('has-value', !!i.value); };
    i.addEventListener('focus', ()=>f.classList.add('focus'));
    i.addEventListener('blur', ()=>f.classList.remove('focus'));
    i.addEventListener('input', set); set();
  });
}
wireFloat();

const alertBG = document.getElementById('alert');
const alertTitle = document.getElementById('alertTitle');
const alertMsg = document.getElementById('alertMsg');
const alertActions = document.getElementById('alertActions');
function showAlert({title="Aviso", html="", actions=[{text:"Fechar", kind:"solid"}]}){
  alertTitle.textContent = title;
  alertMsg.innerHTML = html;
  alertActions.innerHTML = "";
  actions.forEach(a=>{ const b=document.createElement('button'); b.className = 'btn ' + (a.kind==='ghost'?'btn-ghost':'btn-solid'); b.textContent = a.text; b.onclick = ()=>{ if(a.onClick) a.onClick(); closeAlert(); }; alertActions.appendChild(b); });
  alertBG.style.display='flex';
}
function closeAlert(){ alertBG.style.display='none'; }
alertBG.addEventListener('click', e=>{ if(e.target===alertBG) closeAlert(); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape' && alertBG.style.display==='flex') closeAlert(); });

const termsAlertBG = document.getElementById('termsAlert');
function showTermsAlert({onAccept=()=>{}}){
  const acceptBtn = document.getElementById('btnAcceptTerms');
  const cancelBtn = document.getElementById('btnCancelTerms');
  acceptBtn.disabled = true;
  acceptBtn.onclick = ()=>{ onAccept(); closeTermsAlert(); };
  cancelBtn.onclick = closeTermsAlert;
  document.getElementById('chkTerms').addEventListener('change', ()=>{ acceptBtn.disabled = !this.checked; });
  termsAlertBG.style.display = 'flex';
}
function closeTermsAlert(){ termsAlertBG.style.display='none'; }
termsAlertBG.addEventListener('click', e=>{ if(e.target===termsAlertBG) closeTermsAlert(); });

/* ===== GOOGLE AUTH + CADASTRO OBRIGATÓRIO ===== */
document.getElementById('btnGoogleCadastro')?.addEventListener('click', async () => {
  try {
    const result = await signInWithPopup(auth, googleProvider);
    const user = result.user;

    // Preenche campos com dados do Google
    const nomeCompleto = user.displayName || '';
    const [primeiroNome = '', ...resto] = nomeCompleto.split(' ');
    const nomeSugestao = resto.join(' ') || primeiroNome;

    $('email').value = user.email || '';
    $('email2').value = user.email || '';
    $('nome').value = nomeCompleto;
    if ($('razao')) $('razao').value = nomeCompleto;

    ['email', 'email2', 'nome', 'razao'].forEach(id => {
      const el = $(id);
      if (el && el.value) el.closest('.field')?.classList.add('has-value');
    });

    showAlert({
      title: "Quase lá!",
      html: `Olá <b>${primeiroNome}</b>!<br>Complete os dados abaixo para ativar seu site.<br><b>Username não pode ser alterado depois.</b>`,
      actions: [{ text: "OK", kind: "solid" }]
    });

  } catch (error) {
    const msg = error.code === 'auth/popup-closed-by-user' ? 'Cadastro cancelado.' : 'Erro com Google.';
    showAlert({ title: "Ops!", html: msg });
  }
});

/* ===== BLOQUEIA USERNAME APÓS CADASTRO ===== */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  const snap = await getDoc(doc(db, 'usuarios', user.uid));
  if (snap.exists() && snap.data().username) {
    const input = $('username');
    if (input) {
      input.value = snap.data().username;
      input.disabled = true;
      input.closest('.field').insertAdjacentHTML('beforeend', 
        '<div style="font-size:0.8rem;color:#15b0af;margin-top:4px;">Este nome não pode ser alterado.</div>'
      );
    }
  }
});

/* ===== CADASTRO FINAL (E-MAIL OU GOOGLE) ===== */
document.getElementById('btnCadastrar').onclick = async () => {
  if (!await aceitarTermos()) return;

  const user = auth.currentUser;
  if (!user) {
    showAlert({ title: "Erro", html: "Faça login com Google ou use e-mail/senha." });
    return;
  }

  const tipo = document.querySelector('input[name="tipoPessoa"]:checked').value;
  const usernameRaw = $('username').value.trim();
  const username = normalizeUsername(usernameRaw);

  if (!isUsernameValid(username)) return showErr('Nome de usuário inválido', 'Use 3–40 caracteres: letras, números, ponto, hífen ou underline.');
  if (tipo === 'PF') {
    if (!$('nome').value.trim()) return showErr('Nome obrigatório', 'Informe seu <b>nome completo</b>.');
    if (!validaCPF($('cpf').value)) return showErr('CPF inválido', 'Revise o CPF.');
  } else {
    if (!$('razao').value.trim()) return showErr('Razão Social obrigatória', 'Informe a <b>razão social</b>.');
    if (!validaCNPJ($('cnpj').value)) return showErr('CNPJ inválido', 'Revise o CNPJ.');
  }

  uiBusy(true);
  try {
    const ok = await reservarUsername(username);
    if (!ok) throw { code: 'username-taken' };

    const payload = {
      uid: user.uid,
      tipoPessoa: tipo,
      origemCadastro: user.providerData[0]?.providerId || 'email',
      username,
      nomeCompleto: tipo === 'PF' ? $('nome').value.trim() : '',
      cpf: tipo === 'PF' ? onlyDigits($('cpf').value) : '',
      razaoSocial: tipo === 'PJ' ? $('razao').value.trim() : '',
      cnpj: tipo === 'PJ' ? onlyDigits($('cnpj').value) : '',
      ie: tipo === 'PJ' ? ($('isentoIE').checked ? 'ISENTO' : $('ie').value.trim()) : '',
      isentoIE: tipo === 'PJ' ? $('isentoIE').checked : null,
      fone: $('fone').value.trim(),
      email: user.email,
      endereco: {
        cep: onlyDigits($('cep').value),
        uf: $('uf').value,
        cidade: $('cidade').value.trim(),
        bairro: $('bairro').value.trim(),
        logradouro: $('logradouro').value.trim(),
        numero: $('numero').value.trim(),
        complemento: $('complemento').value.trim()
      },
      createdAt: serverTimestamp(),
      cadastroCompleto: true
    };

    await setDoc(doc(db, 'usuarios', user.uid), payload, { merge: true });
    await setDoc(doc(db, 'usernames', username), { uid: user.uid, createdAt: serverTimestamp() });

    await setDoc(doc(db, 'assinaturas', user.uid), {
      plano: 'pendente',
      status: 'aguardando_pagamento',
      provider: 'manual',
      createdAt: serverTimestamp()
    });

    showAlert({
      title: 'Cadastro concluído!',
      html: `Seu site será ativado após o pagamento.<br>Username: <b>${username}</b> (não pode ser alterado).`,
      actions: [{ text: 'Ir para Minha Conta', kind: 'solid', onClick: () => location.href = '/minha-conta.html' }]
    });

  } catch (e) {
    await liberarUsername(username);
    const msg = e.code === 'username-taken' ? 'Este nome de usuário já está em uso.' : 'Erro ao salvar.';
    showAlert({ title: 'Erro', html: msg });
  } finally {
    uiBusy(false);
  }
};

async function aceitarTermos() {
  return new Promise(resolve => {
    showTermsAlert({ onAccept: () => resolve(true) });
    document.getElementById('btnCancelTerms').onclick = () => resolve(false);
  });
}

/* ===== MÁSCARAS E VALIDAÇÕES (inalteradas) ===== */
const $ = (id)=>document.getElementById(id);
const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
function stripDiacritics(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function normalizeUsername(s){ return stripDiacritics(String(s).toLowerCase()).replace(/\s+/g,'-').replace(/[^a-z0-9._-]/g,'').replace(/-+/g,'-').slice(0,40); }
function isUsernameValid(u){ return /^[a-z0-9._-]{3,40}$/.test(u); }

const fone = $("fone");
fone.addEventListener("input", () => {
  let v = onlyDigits(fone.value);
  if (v.length > 11) v = v.slice(0,11);
  if (v.length >= 3 && v.length <= 6) fone.value = `(${v.slice(0,2)}) ${v.slice(2)}`;
  else if (v.length >= 7 && v.length <= 10) fone.value = `(${v.slice(0,2)}) ${v.slice(2,6)}-${v.slice(6)}`;
  else if (v.length === 11) fone.value = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
  else fone.value = v;
});

$("cep").addEventListener("input", async ()=>{
  let v = onlyDigits($("cep").value).slice(0,8);
  $("cep").value = v.length>5 ? `${v.slice(0,5)}-${v.slice(5)}` : v;
  if(v.length===8){
    try{
      const r = await fetch(`https://viacep.com.br/ws/${v}/json/`);
      const data = await r.json();
      if(data.erro) return showAlert({title:"CEP não encontrado", html:"Verifique o CEP informado."});
      $("logradouro").value = data.logradouro || "";
      $("bairro").value     = data.bairro || "";
      $("cidade").value     = data.localidade || "";
      $("uf").value         = data.uf || "";
      ["logradouro","bairro","cidade","uf"].forEach(id=>{ $(id).closest('.field')?.classList.add('has-value'); });
    }catch(e){ showAlert({title:"Falha ao buscar CEP", html:"Tente novamente em instantes."}); }
  }
});

const cpfI = $("cpf"), cnpjI = $("cnpj");
cpfI.addEventListener('input', ()=>{ /* máscara CPF */ });
cnpjI.addEventListener('input', ()=>{ /* máscara CNPJ */ });
function validaCPF(raw){ /* função original */ }
function validaCNPJ(raw){ /* função original */ }

const grupoPF = $("grupoPF"), grupoPJ = $("grupoPJ"), isentoIE = $("isentoIE");
function setTipo(tipo){ /* função original */ }
Array.from(document.querySelectorAll('input[name="tipoPessoa"]')).forEach(r=>{ r.addEventListener('change', ()=> setTipo(r.value)); });
isentoIE.addEventListener('change', ()=> setTipo(document.querySelector('input[name="tipoPessoa"]:checked').value));
setTipo('PF');

(function wireShowPasswords(){
  const pairs = [{input:'senha', chk:'chkMostrarSenha'},{input:'senha2', chk:'chkMostrarSenha2'}];
  pairs.forEach(({input,chk})=>{
    const i = document.getElementById(input);
    const c = document.getElementById(chk);
    if(i && c){ c.addEventListener('change', ()=>{ i.type = c.checked ? 'text' : 'password'; }); }
  });
})();

const params = new URLSearchParams(location.search); const origemCadastro = params.get('c') || 'site';
async function reservarUsername(username){ /* função original */ }
async function liberarUsername(username){ /* função original */ }
function uiBusy(b){ const btn = document.getElementById('btnCadastrar'); btn.disabled = b; btn.textContent = b ? 'Enviando…' : 'Criar conta'; }
function showErr(title, html){ showAlert({title, html}); }
function phoneDigits(v){ return (v||'').replace(/\D/g,'').length; }
</script>
</body>
</html>
