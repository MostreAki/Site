<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Catálogo Digital – MostreAki</title>
<style>
  :root{
    --bg:#0b0c10; --ink:#eaf0f6; --brand:#26c281;
    --head:#111318; --foot:#111318; --box:#111318;
    --ink-dim:#9aa7b2; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink); background:var(--bg);
  }
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;background:var(--head);padding:16px;border-radius:16px;box-shadow:var(--shadow)}
  .brand{display:flex;align-items:center;gap:12px;min-width:0}
  .logoWrap{
    width:64px;height:64px;border-radius:14px;overflow:hidden;
    background:#0f1318;border:1px solid #263041;flex:0 0 auto;
  }
  .logoWrap img{width:100%;height:100%;object-fit:contain;background:#0f1318}
  h1{font-size:clamp(18px,3.5vw,32px);margin:0;color:var(--ink)}
  .sub{color:var(--ink-dim);font-size:13px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--brand);color:#002b1a;border:0;padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(38,194,129,.3)}
  .btn.secondary{background:#222a33;color:var(--ink)}
  .config{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--box);padding:14px;border-radius:16px;margin:16px 0}
  .config label{display:grid;gap:6px;font-size:13px;color:var(--ink-dim)}
  .config input{background:#0f1318;color:var(--ink);border:1px solid #1f2430;padding:11px 12px;border-radius:12px;font-size:15px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  /* 3 por linha no mobile, 4 no desktop */
  .card{grid-column:span 4;background:var(--box);border:1px solid #1a1f27;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  @media(min-width:900px){ .card{grid-column:span 3} }
  .media{position:relative;aspect-ratio:1/1;display:grid;place-items:center;background:linear-gradient(180deg,#1b222b,#131821)}
  .media input[type=file]{display:none}
  .upload-hint{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.55);color:#fff;font-size:12px;padding:6px 8px;border-radius:10px}
  .media img{width:100%;height:100%;object-fit:cover}
  .img-fallback{display:grid;place-items:center;width:100%;height:100%;color:#6d7a86}
  .img-fallback svg{opacity:.6}
  .body{padding:12px;display:grid;gap:10px}
  .title input,.price-qty input{
    background:#0f1318;color:var(--ink);border:1px solid #1f2430;padding:9px 10px;border-radius:10px;font-weight:600;width:100%
  }
  .title{display:grid;gap:6px}
  .price-qty{display:grid;grid-template-columns:1fr 0.8fr;gap:8px}
  .actions{display:flex;gap:8px}
  .wapp{flex:1;background:var(--brand);color:#002b1a;border:0;padding:clamp(8px,2.5vw,12px);border-radius:12px;font-weight:800;cursor:pointer}
  .remove{background:#1f252e;color:#b2bdc7;border:0;padding:clamp(8px,2.5vw,12px);border-radius:12px;cursor:pointer}
  .foot{color:var(--ink-dim);font-size:12px;text-align:center;margin:20px 0}
  .accent{color:var(--brand)}
  .galleryNote{background:var(--foot);padding:12px;border-radius:12px;color:var(--ink-dim);font-size:12px}
</style>

<script type="module">
  /* ========== 1) TEMA: puxa do query/localStorage e aplica em CSS e body ========== */
  (function applyTheme(){
    const P = new URLSearchParams(location.search);
    const pick = (k, fb)=> (P.get(k) ?? localStorage.getItem(k) ?? fb);
    const theme = {
      bg:   pick('bg',   '#0b0c10'),
      text: pick('text', '#eaf0f6'),
      btn:  pick('btn',  '#26c281'),
      head: pick('head', '#111318'),
      foot: pick('foot', '#111318'),
      box:  pick('box',  '#111318')
    };
    const root = document.documentElement;
    root.style.setProperty('--bg',   theme.bg);
    root.style.setProperty('--ink',  theme.text);
    root.style.setProperty('--brand',theme.btn);
    root.style.setProperty('--head', theme.head);
    root.style.setProperty('--foot', theme.foot);
    root.style.setProperty('--box',  theme.box);
    // aplica direto no body (garante que não “volte” para preto)
    document.addEventListener('DOMContentLoaded',()=>{ document.body.style.background = theme.bg; });
  })();

  /* ========== 2) Firebase (CDN v9) ========== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // TODO: COLE SUA CONFIG AQUI
  const firebaseConfig = {
    apiKey: "COLAR_AQUI",
    authDomain: "COLAR_AQUI.firebaseapp.com",
    projectId: "COLAR_AQUI",
    storageBucket: "COLAR_AQUI.appspot.com",
    messagingSenderId: "COLAR_AQUI",
    appId: "COLAR_AQUI"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const st  = getStorage(app);

  /* ========== 3) DOM refs ========== */
  const grid = document.getElementById('grid');
  const tpl  = document.getElementById('cardTpl');
  const storeNameEl = document.getElementById('storeName');
  const whatsEl     = document.getElementById('whatsNumber');
  const logoImg     = document.getElementById('logoImg');
  const logoPick    = document.getElementById('logoPick');

  const fmtBRL = new Intl.NumberFormat('pt-BR', {style:'currency',currency:'BRL'});
  const toCents = str => parseInt((str||'').replace(/[^\d]/g,'')||'0',10);
  const centsToBRL = c => fmtBRL.format((c||0)/100);

  /* ========== 4) Helpers Firebase ========== */
  const P = new URLSearchParams(location.search);
  const uid   = (P.get('uid')   || '').trim();
  const store = (P.get('store') || 'minha-loja').trim();

  function catDocRef(){ return doc(db, 'catalogos', `${uid}__${store}`); }
  function pathFor(fileName){ return `catalogos/${uid}/${store}/${fileName}`; }

  async function uploadImage(file, fileName){
    const r = ref(st, pathFor(fileName));
    await uploadBytes(r, file, {contentType:file.type});
    return await getDownloadURL(r);
  }

  /* ========== 5) Cards ========== */
  function newCard(prefill={}){
    const node = tpl.content.firstElementChild.cloneNode(true);
    const file = node.querySelector('[data-file]');
    const img  = node.querySelector('[data-img]');
    const fallback = node.querySelector('[data-fb]');
    const name = node.querySelector('[data-name]');
    const price= node.querySelector('[data-price]');
    const qty  = node.querySelector('[data-qty]');
    const btnWa= node.querySelector('[data-wa]');
    const btnRm= node.querySelector('[data-rm]');

    name.value  = prefill.name || 'Produto';
    price.value = centsToBRL(prefill.price_cents ?? 0);
    qty.value   = prefill.qty || 1;

    if (prefill.imageURL){
      img.src = prefill.imageURL; img.hidden=false; fallback.hidden=true;
    }

    node.querySelector('.media').addEventListener('click', ()=> file.click());
    file.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      // preview imediato
      const reader = new FileReader();
      reader.onload = ()=>{ img.src=reader.result; img.hidden=false; fallback.hidden=true; };
      reader.readAsDataURL(f);
      // upload
      try{
        const url = await uploadImage(f, `items/${Date.now()}_${f.name}`);
        img.dataset.remote = url;
      }catch(err){ alert('Falha ao subir imagem do item. Verifique Storage/regras.'); console.error(err); }
    });

    price.addEventListener('input', e=>{
      e.target.value = centsToBRL(toCents(e.target.value));
    });

    btnWa.addEventListener('click', ()=>{
      const n=name.value.trim()||'Produto';
      const c=toCents(price.value); const q=parseInt(qty.value||'1',10);
      const total=centsToBRL(c*q);
      const waNumber=whatsEl.value.replace(/\D/g,'');
      const msg = `Olá, vim do catálogo *${storeNameEl.value.trim()}*%0A`+
                  `Produto: *${encodeURIComponent(n)}*%0A`+
                  `Preço: *${encodeURIComponent(centsToBRL(c))}*%0A`+
                  `Quantidade: *${q}*%0A`+
                  `Total: *${encodeURIComponent(total)}*`;
      window.open(`https://wa.me/${waNumber}?text=${msg}`,'_blank');
    });

    btnRm.addEventListener('click', ()=> node.remove());
    grid.appendChild(node);
  }

  /* ========== 6) Logo ========== */
  document.getElementById('btnLogo').addEventListener('click', ()=> logoPick.click());
  logoPick.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    // preview sem distorcer (object-fit:contain já cuida)
    const reader=new FileReader();
    reader.onload=()=>{ logoImg.src=reader.result; };
    reader.readAsDataURL(f);
    // upload
    try{
      const url = await uploadImage(f, `logo_${Date.now()}_${f.name}`);
      logoImg.dataset.remote = url;
    }catch(err){ alert('Falha ao subir logo. Verifique Storage/regras.'); console.error(err); }
  });

  /* ========== 7) Toolbar ========== */
  document.getElementById('btnAdd').addEventListener('click', ()=> newCard());

  document.getElementById('btnExport').addEventListener('click', ()=>{
    const data = collectData();
    download('catalogo-monstreaqui.json', JSON.stringify(data,null,2));
  });

  document.getElementById('btnSave').addEventListener('click', async ()=>{
    try{
      const payload = collectData();
      payload.updatedAt = serverTimestamp();
      await setDoc(catDocRef(), payload, {merge:true});
      // redireciona para visualização “limpa”
      const q = new URLSearchParams({ uid, store });
      location.href = `/catalogo-view.html?${q}`;
    }catch(err){
      alert('Falha ao salvar no Firestore. Verifique credenciais e regras.');
      console.error(err);
    }
  });

  function collectData(){
    const items = [...grid.querySelectorAll('[data-card]')].map(card=>{
      const name = card.querySelector('[data-name]').value.trim();
      const price_cents = toCents(card.querySelector('[data-price]').value);
      const qty = parseInt(card.querySelector('[data-qty]').value||'1',10);
      const img = card.querySelector('[data-img]');
      const imageURL = img.dataset.remote || null; // se já subiu
      return { name, price_cents, qty, imageURL };
    });
    const theme = {
      bg: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim(),
      text: getComputedStyle(document.documentElement).getPropertyValue('--ink').trim(),
      btn: getComputedStyle(document.documentElement).getPropertyValue('--brand').trim(),
      head:getComputedStyle(document.documentElement).getPropertyValue('--head').trim(),
      foot:getComputedStyle(document.documentElement).getPropertyValue('--foot').trim(),
      box: getComputedStyle(document.documentElement).getPropertyValue('--box').trim(),
    };
    return {
      uid, store,
      storeName: storeNameEl.value.trim(),
      whatsapp: whatsEl.value.replace(/\D/g,''),
      logoURL: logoImg.dataset.remote || null,
      theme, items
    };
  }

  function download(filename, text){
    const blob = new Blob([text],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename; a.click();
    URL.revokeObjectURL(a.href);
  }

  /* ========== 8) Se já existir catálogo, carregar ========== */
  (async function boot(){
    // sementes visuais iniciais
    ['Pôster Espiral','Camisa MostreAki','Adesivo Hiperbóreo'].forEach((n,i)=>newCard({name:n,price_cents:[6900,9900,1900][i],qty:[1,1,2][i]}));
    if (!uid || !store) return;
    try{
      const snap = await getDoc(catDocRef());
      if (snap.exists()){
        const data = snap.data();
        storeNameEl.value = data.storeName || 'Minha Loja';
        whatsEl.value     = data.whatsapp || '';
        if (data.logoURL){ logoImg.src = data.logoURL; logoImg.dataset.remote = data.logoURL; }
        // tema salvo (sobrepõe o que veio por query)
        const t = data.theme||{};
        const root=document.documentElement;
        for (const [k,v] of Object.entries({bg:t.bg,text:t.text,btn:t.btn,head:t.head,foot:t.foot,box:t.box})){
          if (v){ root.style.setProperty(`--${k==='text'?'ink':k}`, v); }
        }
        document.body.style.background = getComputedStyle(root).getPropertyValue('--bg').trim();
        // itens
        grid.innerHTML='';
        (data.items||[]).forEach(it=> newCard(it));
      }
    }catch(e){ console.warn('Não foi possível carregar catálogo existente:', e); }
  })();
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logoWrap">
          <img id="logoImg" alt="Logo da loja"/>
        </div>
        <div style="min-width:0">
          <h1 id="title">Catálogo Digital</h1>
          <div class="sub">Editor – adicione itens, salve e visualize</div>
        </div>
      </div>
      <div class="toolbar">
        <input id="logoPick" type="file" accept="image/*" hidden>
        <button id="btnLogo" class="btn secondary">+ Adicionar logo</button>
        <button id="btnAdd" class="btn">+ Adicionar item</button>
        <button id="btnExport" class="btn secondary">Exportar JSON</button>
        <button id="btnSave" class="btn">Salvar & Visualizar</button>
      </div>
    </header>

    <section class="config" aria-label="Configurações do catálogo">
      <label>Nome da loja
        <input id="storeName" type="text" value="Minha Loja"/>
      </label>
      <label>WhatsApp (apenas números, com DDI/DDD – ex: 55XXXXXXXXXXX)
        <input id="whatsNumber" type="tel" value="5599999999999"/>
      </label>
    </section>

    <div class="galleryNote">Dica: toque na imagem do item para enviar uma foto (ela será enviada ao Storage). O botão WhatsApp monta a mensagem automaticamente. Use <b>Salvar & Visualizar</b> para gerar o link compartilhável.</div>

    <section class="grid" id="grid"></section>
    <p class="foot">© 2025 MostreAki.</p>
  </div>

  <template id="cardTpl">
    <article class="card" data-card>
      <label class="media" aria-label="Imagem do produto">
        <input type="file" accept="image/*" data-file/>
        <img data-img hidden alt="Imagem do produto"/>
        <div class="img-fallback" data-fb>
          <svg width="50" height="50" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a3 3 0 1 0 0 6a3 3 0 0 0 0-6m0-6a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9s-4.03-9-9-9m0 16a7 7 0 1 1 0-14a7 7 0 0 1 0 14"/></svg>
        </div>
        <div class="upload-hint">Enviar foto</div>
      </label>
      <div class="body">
        <div class="title">
          <input type="text" placeholder="Nome do produto" value="Produto" data-name/>
        </div>
        <div class="price-qty">
          <input type="text" inputmode="decimal" placeholder="Preço (R$)" value="R$ 0,00" data-price/>
          <input type="number" min="1" step="1" value="1" data-qty/>
        </div>
        <div class="actions">
          <button class="wapp" data-wa>Chamar no WhatsApp</button>
          <button class="remove" data-rm>Remover</button>
        </div>
      </div>
    </article>
  </template>
</body>
</html>
