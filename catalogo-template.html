<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo Digital – MostreAki</title>
  <style>
    :root{
      --bg: #0b0c10;
      --panel: #111318;
      --ink: #eaf0f6;
      --ink-dim:#9aa7b2;
      --brand:#26c281;
      --brand-ink:#002b1a;
      --accent:#ffd166;
      --danger:#ff6b6b;
      --muted:#22262f;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(120deg,#0b0c10,#0e1016 30%,#0b0c10 70%);
      color:var(--ink)
    }
    .wrap{max-width:1100px; margin:40px auto; padding:0 20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:24px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:42px; height:42px; display:grid; place-items:center; background: radial-gradient(120% 120% at 30% 30%, #35e39b, #158a5a 60%, #0a3a28 100%); border-radius:50%; box-shadow:var(--shadow)}
    .logo svg{fill:white}
    h1{font-size: clamp(20px, 2.6vw, 30px); margin:0}
    .sub{color:var(--ink-dim); font-size:14px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .btn{background:var(--brand); color:#001b12; border:0; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; box-shadow: 0 6px 18px rgba(38,194,129,.3)}
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:#222a33; color:var(--ink)}

    .config{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px;
      background:var(--muted); padding:14px; border-radius:var(--radius); margin-bottom:18px
    }
    .config label{display:grid; gap:6px; font-size:13px; color:var(--ink-dim)}
    .config input, .config select{
      background:#0f1318; color:var(--ink); border:1px solid #1f2430;
      padding:10px 12px; border-radius:12px; font-size:14px
    }

    /* ====== GRID: 3 no mobile / 4 no desktop ====== */
    .grid{display:grid; gap:16px; grid-template-columns: repeat(3, 1fr)}
    @media (min-width: 992px){
      .grid{grid-template-columns: repeat(4, 1fr)}
    }

    .card{background:var(--panel); border:1px solid #1a1f27; border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column}
    .media{position:relative; aspect-ratio: 1 / 1; display:grid; place-items:center; background:linear-gradient(180deg,#1b222b,#131821)}
    .media input[type=file]{display:none}
    .upload-hint{position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,.55); color:#fff; font-size:12px; padding:6px 8px; border-radius:10px}
    .media img{max-width:100%; max-height:100%; object-fit:cover; width:100%; height:100%}
    .img-fallback{display:grid; place-items:center; width:100%; height:100%; color:#6d7a86}
    .img-fallback svg{opacity:.6}

    .body{padding:14px; display:grid; gap:10px}
    .title{display:grid; gap:6px}
    .title input{background:#0f1318; color:var(--ink); border:1px solid #1f2430; padding:9px 10px; border-radius:10px; font-weight:600}

    .price-qty{display:grid; grid-template-columns: 1fr 100px; gap:8px}
    .price-qty input{background:#0f1318; color:var(--ink); border:1px solid #1f2430; padding:9px 10px; border-radius:10px; font-weight:600}

    .actions{display:flex; gap:8px; margin-top:6px}
    .wapp{flex:1; background:var(--brand); color:var(--brand-ink); border:0; padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer}
    .wapp:hover{filter:brightness(1.05)}
    .remove{background:#1f252e; color:#b2bdc7; border:0; padding:10px 12px; border-radius:12px; cursor:pointer}
    .remove:hover{background:#232a35}

    .add{border:2px dashed #2a3340; background:#11141b; color:#7b8a96; border-radius:var(--radius); display:grid; place-items:center; aspect-ratio:1/1}
    .add button{background:#11141b; border:0; color:#9fb5c2; cursor:pointer}
    .foot{color:#7b8a96; font-size:12px; text-align:center; margin:20px 0}
    .accent{color:var(--accent)}
  </style>

  <!-- Tema vindo do CrieAki (cores e, opcionalmente, imagem de fundo) -->
  <script>
    (function applyTheme(){
      const qs = new URLSearchParams(location.search);
      const pick = (k, fb)=> qs.get(k) || localStorage.getItem(k) || fb;

      const theme = {
        bgColor:        pick('bg','#0b0c10'),
        bgImg:          pick('bgimg',''),            // URL de imagem de fundo (prioridade)
        bgFit:          pick('bgfit','cover'),       // cover | contain
        textColor:      pick('text','#eaf0f6'),
        btnColor:       pick('btn','#26c281'),
        headerColor:    pick('head','#111318'),
        footerColor:    pick('foot','#111318'),
        containerColor: pick('box','#111318')
      };

      const root = document.documentElement;
      root.style.setProperty('--panel', theme.containerColor);
      root.style.setProperty('--ink', theme.textColor);
      root.style.setProperty('--brand', theme.btnColor);

      // Aplica fundo (prioriza imagem, senão cor/gradiente)
      if (theme.bgImg) {
        document.body.style.backgroundImage = `url("${theme.bgImg}")`;
        document.body.style.backgroundSize  = theme.bgFit || 'cover';
        document.body.style.backgroundRepeat = 'no-repeat';
        document.body.style.backgroundPosition = 'center center';
        document.body.style.backgroundColor = '#000';
      } else {
        document.body.style.background = theme.bgColor;
      }
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 0-7.07 17.07l.7-.7A9 9 0 1 1 19.64 5.87l.7-.7A10 10 0 0 0 12 2Zm0 4a6 6 0 1 0 4.24 10.24l-.71-.71A5 5 0 1 1 12 7V6Z"/></svg>
        </div>
        <div>
          <h1>Catálogo Digital <span class="accent">MostreAki</span></h1>
          <div class="sub">Template base – imagens, preço, quantidade e botão WhatsApp <span id="uidBadge"></span></div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnAdd" class="btn">+ Adicionar item</button>
        <button id="btnExport" class="btn secondary">Exportar JSON</button>
      </div>
    </header>

    <!-- Configurações rápidas + editor de fundo -->
    <section class="config" aria-label="Configurações do catálogo">
      <label>Nome da loja
        <input id="storeName" type="text" value="Minha Loja" />
      </label>

      <label>WhatsApp (apenas números, com DDI/DDD – ex: 55XXXXXXXXXXX)
        <input id="whatsNumber" type="tel" value="5599999999999" />
      </label>

      <label>Fundo (cor/gradiente)
        <input id="bgEditor" type="text" placeholder="#101820 ou linear-gradient(...)" />
      </label>

      <label>Fundo (imagem)
        <input id="bgImage" type="file" accept="image/*" />
      </label>

      <label>Ajuste da imagem de fundo
        <select id="bgFit">
          <option value="cover">cover (recomendado)</option>
          <option value="contain">contain</option>
        </select>
      </label>

      <label>Aplicar fundo
        <button id="applyBg" class="btn secondary">Aplicar</button>
      </label>
    </section>

    <!-- Grade de produtos -->
    <section class="grid" id="grid"></section>

    <p class="foot">Dica: clique na imagem de cada item para <strong>enviar uma foto</strong>. O botão de WhatsApp monta a mensagem automaticamente.</p>
  </div>

  <template id="cardTpl">
    <article class="card" data-card>
      <label class="media" aria-label="Imagem do produto">
        <input type="file" accept="image/*" data-file />
        <img data-img hidden alt="Imagem do produto"/>
        <div class="img-fallback" data-fallback>
          <svg width="50" height="50" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a3 3 0 1 0 0 6a3 3 0 0 0 0-6m0-6a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9s-4.03-9-9-9m0 16a7 7 0 1 1 0-14a7 7 0 0 1 0 14"/></svg>
        </div>
        <div class="upload-hint">Enviar foto</div>
      </label>
      <div class="body">
        <div class="title">
          <input type="text" placeholder="Nome do produto" value="Produto" data-name />
        </div>
        <div class="price-qty">
          <input type="text" inputmode="decimal" placeholder="Preço (R$)" value="R$ 0,00" data-price />
          <input type="number" min="1" step="1" value="1" data-qty />
        </div>
        <div class="actions">
          <button class="wapp" data-wa>Chamar no WhatsApp</button>
          <button class="remove" data-remove>Remover</button>
        </div>
      </div>
    </article>
  </template>

  <script>
    // ===== Config local do template =====
    const grid = document.getElementById('grid');
    const tpl = document.getElementById('cardTpl');
    const storeNameEl = document.getElementById('storeName');
    const whatsEl = document.getElementById('whatsNumber');
    const uidBadge = document.getElementById('uidBadge');

    // Editor de fundo
    const bgEditor = document.getElementById('bgEditor');
    const bgImage  = document.getElementById('bgImage');
    const bgFitSel = document.getElementById('bgFit');
    const applyBg  = document.getElementById('applyBg');

    // Preenche editor com o que veio por query/localStorage
    (function hydrateBgEditors(){
      const qs = new URLSearchParams(location.search);
      const get = (k)=> qs.get(k) || localStorage.getItem(k) || '';
      const bg  = get('bg');
      const bgimg = get('bgimg');
      const bgfit = get('bgfit') || 'cover';
      if (bg) bgEditor.value = bg;
      bgFitSel.value = bgfit;
      // se vier bgimg por URL, já estará aplicado pelo tema
    })();

    const fmtBRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const toCents = (str) => {
      if (!str) return 0;
      const only = (''+str).replace(/[^0-9]/g,'');
      return parseInt(only || '0', 10);
    }
    const centsToBRL = (c) => fmtBRL.format((c||0)/100);

    function applyBackground({ bg, bgimg, bgfit }){
      try {
        if (bg) localStorage.setItem('bg', bg);
        if (bgimg) localStorage.setItem('bgimg', bgimg);
        if (bgfit) localStorage.setItem('bgfit', bgfit);
      } catch {}
      if (bgimg) {
        document.body.style.backgroundImage = `url("${bgimg}")`;
        document.body.style.backgroundSize  = bgfit || 'cover';
        document.body.style.backgroundRepeat = 'no-repeat';
        document.body.style.backgroundPosition = 'center center';
        document.body.style.backgroundColor = '#000';
      } else if (bg) {
        document.body.style.backgroundImage = 'none';
        document.body.style.background = bg;
      }
    }

    if (applyBg) {
      applyBg.addEventListener('click', ()=>{
        const bg = bgEditor?.value.trim();
        const bgfit = bgFitSel?.value || 'cover';
        if (bgImage?.files && bgImage.files[0]) {
          const f = bgImage.files[0];
          const url = URL.createObjectURL(f); // preview local
          applyBackground({ bgimg:url, bgfit });
        } else {
          applyBackground({ bg, bgfit });
        }
      });
    }

    function newCard(prefill={}){
      const node = tpl.content.firstElementChild.cloneNode(true);
      const file = node.querySelector('[data-file]');
      const img = node.querySelector('[data-img]');
      const fallback = node.querySelector('[data-fallback]');
      const name = node.querySelector('[data-name]');
      const price = node.querySelector('[data-price]');
      const qty = node.querySelector('[data-qty]');
      const btnWa = node.querySelector('[data-wa]');
      const btnRemove = node.querySelector('[data-remove]');

      name.value = prefill.name || 'Produto';
      const cents = prefill.cents ?? 0;
      price.value = centsToBRL(cents);
      qty.value = prefill.qty || 1;

      node.querySelector('.media').addEventListener('click', () => file.click());

      file.addEventListener('change', async (e)=>{
        const f = e.target.files?.[0];
        if(!f) return;
        // preview rápido
        const reader = new FileReader();
        reader.onload = () => {
          img.src = reader.result;
          img.hidden = false;
          fallback.hidden = true;
        };
        reader.readAsDataURL(f);

        // sobe pro Storage e troca pela URL final
        try {
          const url = await window.MOSTREAKI_UPLOAD?.(f);
          if (url) img.src = url;
        } catch (err) {
          console.error('Falha no upload:', err);
        }
      });

      price.addEventListener('input', (e)=>{
        const cents = toCents(e.target.value);
        e.target.value = centsToBRL(cents);
      });

      btnWa.addEventListener('click', async ()=>{
        const n = name.value.trim()||'Produto';
        const c = toCents(price.value);
        const q = parseInt(qty.value||'1',10);
        const total = centsToBRL(c*q);
        const store = storeNameEl.value.trim();
        const waNumber = whatsEl.value.replace(/\D/g,'');
        const msg = `Olá, vim do catálogo *${store}*%0A`+
                    `Produto: *${encodeURIComponent(n)}*%0A`+
                    `Preço: *${encodeURIComponent(centsToBRL(c))}*%0A`+
                    `Quantidade: *${q}*%0A`+
                    `Total: *${encodeURIComponent(total)}*`;
        const url = `https://wa.me/${waNumber}?text=${msg}`;
        window.open(url, '_blank');

        // salva item no Firestore
        try {
          await window.MOSTREAKI_SAVE_ITEM?.({
            name: n,
            price_cents: c,
            qty: q,
            image_url: img?.src || null
          });
        } catch (err) {
          console.error('Falha ao salvar item:', err);
        }
      });

      btnRemove.addEventListener('click', ()=> node.remove());

      grid.appendChild(node);
    }

    document.getElementById('btnAdd').addEventListener('click', ()=> newCard());
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const data = [...grid.querySelectorAll('[data-card]')].map(card=>{
        const name = card.querySelector('[data-name]').value.trim();
        const priceCents = toCents(card.querySelector('[data-price]').value);
        const qty = parseInt(card.querySelector('[data-qty]').value||'1',10);
        const img = card.querySelector('[data-img]');
        return { name, price_cents: priceCents, qty, image_data: img?.src||null };
      });
      const json = JSON.stringify({
        store: storeNameEl.value.trim(),
        whatsapp: whatsEl.value.trim(),
        items: data
      }, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'catalogo-mostreaki.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Sementes de exemplo
    [
      { name:'Pôster Espiral', cents: 6900, qty:1 },
      { name:'Camisa MostreAki', cents: 9900, qty:1 },
      { name:'Adesivo Hiperbóreo', cents: 1900, qty:2 }
    ].forEach(seed=> newCard(seed));
  </script>

  <!-- Firebase (CDN modular) + integração MostreAki -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // === CONFIG DO TEU PROJETO ===
    const firebaseConfig = {
      apiKey: "AIzaSyBrkUtwP4T77oXE22OjOFVhfEUlJ7yctiE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.appspot.com",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const storage = getStorage(app);

    await signInAnonymously(auth);

    const uid = new URLSearchParams(location.search).get('uid') || localStorage.getItem('userUid') || null;
    if (uid) localStorage.setItem('userUid', uid);

    // hidrata perfil
    if (uid) {
      try {
        const snap = await getDoc(doc(db, "usuarios", uid));
        if (snap.exists()) {
          const data = snap.data();
          const storeNameEl = document.getElementById('storeName');
          const whatsEl     = document.getElementById('whatsNumber');

          if (data?.nome) {
            storeNameEl.value = data.nome;
            localStorage.setItem('userName', data.nome);
          }
          if (data?.whatsapp) {
            whatsEl.value = String(data.whatsapp).replace(/\D/g,'');
            localStorage.setItem('whatsNumber', whatsEl.value);
          }
        }
      } catch (e) {
        console.error("Erro ao buscar perfil:", e);
      }
    }

    // mostra UID no subtítulo
    const badge = document.getElementById('uidBadge');
    if (badge && uid) badge.innerHTML = ` · UID: <span style="color:#9aa7b2">${uid}</span>`;

    // helpers globais
    window.MOSTREAKI_UPLOAD = async function(file) {
      const who = uid || 'public';
      const path = `usuarios/${who}/catalog/${Date.now()}-${file.name}`;
      const ref = sRef(storage, path);
      await uploadBytes(ref, file);
      return await getDownloadURL(ref);
    };

    window.MOSTREAKI_SAVE_ITEM = async function(fields) {
      const who = uid || 'public';
      const col = collection(db, 'usuarios', who, 'items');
      await addDoc(col, { ...fields, createdAt: serverTimestamp() });
    };
  </script>
</body>
</html>
