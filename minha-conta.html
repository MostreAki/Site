<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Minha Conta ‚Äì MostreAki</title>
  <style>
    :root{ --brand:#15b0af; --brandLight:#c2e7df; --ink:#083f3e; --danger:#d73e45; }

    *{box-sizing:border-box}
    body{
      margin:0;
      /* Fundo padr√£o MostreAki: imagem + fixo */
      background-image:url("fundo-mobile-mostreaki.png");
      background-size:cover;background-repeat:no-repeat;background-attachment:fixed;
      font:16px/1.4 system-ui,Segoe UI,Roboto,Arial;
      color:#0b3e3c;
    }
    @media (min-width:768px){
      body{ background-image:url("fundo-desktop-mostreaki.png"); }
    }

    /* ===== Header alinhado ao padr√£o ===== */
    header{
      position:sticky;top:0;z-index:1000;
      background:#c2e7df; /* mesmo tom das outras p√°ginas */
      display:flex;align-items:center;gap:12px;
      padding:10px 16px;border-bottom:1px solid #bfe3da
    }
    header .logo{
      display:flex;align-items:center;gap:10px;font-weight:800;color:#0b3e3c;
      cursor:pointer;
    }
    /* Marca color MostreAki */
    .logo .mostreaki{color:#FA1E39}

    .user-wrap{margin-left:auto;display:flex;align-items:center;gap:10px}
    .user-circle{
      width:56px;height:56px;border-radius:50%;overflow:hidden;display:none;
      border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.15)
    }

    /* ===== √çcone hamb√∫rguer com cor de brand ===== */
    .menu-icon{width:36px;height:26px;position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .menu-icon span{
      position:absolute;width:24px;height:3px;background:var(--brand);border-radius:3px;
      transition:filter .15s ease;
    }
    .menu-icon span:nth-child(1){top:2px}
    .menu-icon span:nth-child(2){top:11px}
    .menu-icon span:nth-child(3){bottom:2px}
    .menu-icon:hover span{filter:brightness(.9)}

    nav#menu{
      display:none;position:absolute;right:12px;top:64px;background:#fff;
      border:1px solid #e8f2ef;border-radius:12px;box-shadow:0 18px 50px rgba(0,0,0,.12);
      padding:10px 12px;gap:8px;flex-direction:column
    }
    nav#menu a{
      padding:10px 12px;border-radius:8px;text-decoration:none;
      color:#0b3e3c;background:#FA1E39; /* como nas outras p√°ginas */
      color:#fff;font-weight:700;text-align:center;
    }
    nav#menu a:hover{background:#b8313b}

    a.btn.ghost{border:2px solid var(--brand);color:var(--brand);background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;text-decoration:none}

    /* ===== Layout principal: containers flutuantes ===== */
    main.container{max-width:980px;margin:22px auto;padding:0 16px}

    /* T√≠tulo em cart√£o branco isolado (padr√£o unificado) */
    .section-title{
      background:#fff;border:1px solid #e7f3f1;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:16px 18px;margin:0 0 18px 0;text-align:center;
    }
    .section-title h2{color:#0b3e3c;margin:0;font-size:1.8rem}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:#fff;border:1px solid #e7f3f1;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .card .head{padding:14px 16px;border-bottom:1px solid #e7f3f1;font-weight:700;color:#0b3e3c}
    .card .body{padding:16px}

    label{display:block;margin:10px 0 6px;color:#124b49;font-weight:600}
    input[type="text"],input[type="file"]{width:100%;padding:10px 12px;border:1px solid #cfe9e3;border-radius:10px}
    #fotoPreview{display:block;margin-top:10px;max-width:180px;border-radius:12px}

    .row-btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.save{background:var(--brand);color:#fff}
    .btn.remove{background:var(--danger);color:#fff}
    .btn.link{background:#0b3e3c;color:#fff;text-decoration:none;display:inline-flex;align-items:center}

    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid #e8f2ef}
    .chip.sem-plano{background:#fff;color:#666}
    .chip.pendente{background:#fff7e6;color:#a36b00;border-color:#f7dfb6}
    .chip.ativo{background:#e8fff6;color:#0a7a58;border-color:#b9f0dc}
    .chip.cancelamento_solicitado{background:#fff1f1;color:#a72d2d;border-color:#f3c3c3}
    .chip.cancelado{background:#f1f3f4;color:#666}

    .help{font-size:.85rem;color:#567;margin-top:2px}
    .alerta-login{display:none;margin:14px auto;max-width:980px;background:#fffbe6;border:1px solid #ffe8a3;border-radius:12px;padding:10px 14px;color:#7a5600}

    @media(max-width:860px){.grid{grid-template-columns:1fr}}

    /* ===== Modal de autentica√ß√£o (mesmo padr√£o, com checkbox "Mostrar senha") ===== */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .modal-card{
      background:#fff;width:100%;max-width:420px;border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;border:2px solid var(--brandLight);
    }
    .modal-head{
      background:linear-gradient(90deg,var(--brandLight),var(--brand));
      padding:16px 18px;color:#0b4d4c;display:flex;align-items:center;justify-content:space-between;
    }
    .modal-head h2{font-size:1.1rem;color:#063b39}
    .modal-close{background:transparent;border:none;font-size:22px;line-height:1;cursor:pointer;color:#063b39}
    .modal-body{padding:18px}
    .modal-body p.muted{color:#555;margin-bottom:10px}
    label{display:block;margin:10px 0 6px;color:#333}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
    .primary{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:12px;font-weight:bold;cursor:pointer;width:100%;margin-top:12px}
    .muted{font-size:.9rem;color:#666;margin-top:10px}
    .muted a{color:var(--brand);text-decoration:none;font-weight:bold}

    .pwd-wrap{position:relative}
    .showpwd{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:.9rem;color:#444}
    .showpwd input{width:auto}

    /* ===== Apar√™ncia para campos somente leitura ===== */
    input[readonly]{
      background:#f7f7f7!important;
      color:#6b6b6b!important;
      cursor:not-allowed!important;
    }
    .lock-note{font-size:.82rem;color:#6b6b6b;margin-top:4px}
  </style>
</head>
<body>

  <!-- ===== MODAL: LOGIN EMBUTIDO ===== -->
  <div id="authModal" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h2 id="authTitle">Entrar no MostreAki</h2>
        <button class="modal-close" onclick="fecharModal()" aria-label="Fechar">√ó</button>
      </div>
      <div class="modal-body">
        <label for="email">E-mail</label>
        <input id="email" type="email" autocomplete="username" required
               pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$" placeholder="voce@exemplo.com">

        <label for="senha">Senha</label>
        <div class="pwd-wrap">
          <input id="senha" type="password" autocomplete="current-password" required>
          <!-- Checkbox que substitui o "olho" -->
          <label class="showpwd" for="chkMostrarSenha">
            <input id="chkMostrarSenha" type="checkbox" aria-controls="senha" aria-label="Mostrar senha">
            Mostrar senha
          </label>
        </div>

        <button class="primary" id="btnEntrar">Entrar</button>

        <div class="muted" style="text-align:center;margin-top:6px">
          Esqueceu a senha? <a href="/recuperar-senha.html">Recuperar senha</a>
        </div>
        <p class="muted">N√£o tem conta? <a href="/cadastro.html">Cadastre-se</a></p>
      </div>
    </div>
  </div>

  <header>
    <div class="logo" onclick="location.href='index.html'">
      <img src="/logo.svg" alt="" height="28">
      <span class="mostreaki">MostreAki</span>
    </div>
    <div class="user-wrap">
      <div id="userCircle" class="user-circle"></div>
      <a id="authText" href="/login.html" class="btn ghost" style="text-decoration:none">Entrar</a>
      <div id="menuBtn" class="menu-icon" aria-label="Abrir menu" role="button" tabindex="0">
        <span></span><span></span><span></span>
      </div>
      <nav id="menu">
        <a href="/index.html">P√°gina Inicial</a>
        <a href="/sobre.html">Sobre</a>
        <a href="/planos.html">Planos</a>
        <a href="/parceiros.html">Parceiros</a>
        <a href="/servicos-adicionais.html">Servi√ßos Adicionais</a>
        <a href="/redes-sociais.html">Redes Sociais</a>
        <a href="/contatos.html">Contatos</a>
      </nav>
    </div>
  </header>

  <div id="alertaLogin" class="alerta-login">‚ö†Ô∏è Voc√™ precisa estar logado para acessar a p√°gina Minha Conta. Redirecionando‚Ä¶</div>

  <main class="container">
    <!-- T√çTULO EM CONTAINER BRANCO ISOLADO -->
    <div class="section-title"><h2>Minha Conta</h2></div>

    <div class="grid">
      <!-- PERFIL / REDES -->
      <section class="card">
        <div class="head">Perfil e Redes</div>
        <div class="body">
          <label for="nomeCompleto">Nome completo</label>
          <input id="nomeCompleto" type="text" placeholder="Seu nome e sobrenome">

          <label for="username">Nome de usu√°rio</label>
          <!-- Campo bloqueado para o cliente -->
          <input id="username" type="text" placeholder="ex.: joao-silva" readonly aria-readonly="true" title="Bloqueado para edi√ß√£o. Entre em contato com o suporte para alterar.">
          <div class="lock-note">üîí Bloqueado para edi√ß√£o (apenas o suporte poder√° fazer a altera√ß√£o).</div>

          <label for="foto" style="margin-top:12px">Foto de Perfil</label>
          <input id="foto" type="file" accept="image/*">
          <img id="fotoPreview" alt="Preview">

          <label style="margin-top:12px">Instagram</label><input id="instagram" type="text" placeholder="@seuusuario">
          <label>Facebook</label><input id="facebook" type="text" placeholder="link da p√°gina">
          <label>WhatsApp</label><input id="whatsapp" type="text" placeholder="55DDD999999999">
          <label>YouTube</label><input id="youtube" type="text" placeholder="link do canal">

          <div class="row-btns">
            <button id="btnSalvar" class="btn save">Salvar altera√ß√µes</button>
            <button id="btnExcluirFoto" class="btn remove">Remover foto</button>
            <!-- EDITAR CAT√ÅLOGO: s√≥ aparece se assinatura ATIVA + cat√°logo ativo -->
            <a id="btnEditarCatalogo" class="btn link" style="display:none" href="#">‚úèÔ∏è Editar cat√°logo</a>
          </div>
          <div id="catalogoInfo" class="help" style="display:none;margin-top:6px"></div>
        </div>
      </section>

      <!-- ASSINATURA -->
      <section class="card">
        <div class="head">Assinatura</div>
        <div class="body">
          <div id="statusChip" class="chip sem-plano">Sem plano</div>
          <p id="planoLabel" style="margin:10px 0 6px">Plano atual: ‚Äî</p>
          <small id="assinaturaMeta" style="color:#557"></small>
          <div class="row-btns" style="margin-top:14px">
            <button id="btnAssinar"  class="btn save">Assinar</button>
            <button id="btnAlterar"  class="btn ghost" style="display:none">Alterar plano</button>
            <button id="btnCancelar" class="btn remove" style="display:none">Cancelar plano</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== SCRIPTS ===== -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, sendEmailVerification } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    const cfg = {
      apiKey: 'AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE',
      authDomain: 'mostreaki-2025.firebaseapp.com',
      projectId: 'mostreaki-2025',
      storageBucket: 'mostreaki-2025.firebasestorage.app',
      messagingSenderId: '748712068097',
      appId: '1:748712068097:web:09cf043fbb45917ef6ec00'
    };
    const app = getApps().length ? getApp() : initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const storage = getStorage(app, 'gs://mostreaki-2025.firebasestorage.app');

    const $ = s => document.querySelector(s);
    const cacheBust = u => u ? u + (u.includes('?')?'&':'?') + 'v=' + Date.now() : u;

    /* ====== Modal Login ====== */
    const modal = document.getElementById('authModal');
    function abrirModal(){ if(modal){ modal.style.display='flex'; document.body.style.overflow='hidden'; } }
    window.fecharModal = function(){ if(modal){ modal.style.display='none'; document.body.style.overflow=''; } };
    modal?.addEventListener('click', e=>{ if(e.target===modal) fecharModal(); });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal?.style.display==='flex') fecharModal(); });

    // Mostrar senha (checkbox)
    (function wireShowPassword(){
      const input = document.getElementById('senha'), chk = document.getElementById('chkMostrarSenha');
      if(!input || !chk) return;
      const apply = ()=>{ input.type = chk.checked ? 'text' : 'password'; };
      chk.addEventListener('change', apply);
    })();

    // Login e valida√ß√£o b√°sica
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    const emailValido = v => emailRe.test(v);
    async function loginEmailSenha(){
      const email = document.getElementById("email").value.trim();
      const senha = document.getElementById("senha").value;

      if(!email) return alert("Digite seu e-mail.");
      if(!emailValido(email)) return alert("E-mail inv√°lido.");
      if(!senha) return alert("Digite sua senha.");

      try{
        const cred = await signInWithEmailAndPassword(auth, email, senha);
        if(!cred.user.emailVerified){
          try{ await sendEmailVerification(cred.user); }catch{}
          alert("E-mail n√£o verificado. Reenviamos o link.");
          return;
        }
        fecharModal();
        // mant√©m fluxo normal do onAuthStateChanged
      }catch(e){
        const codes = ["auth/invalid-credential","auth/wrong-password","auth/user-not-found"];
        if(codes.includes(e.code)) return alert("E-mail e/ou senha incorretos.");
        if(e.code==="auth/too-many-requests") return alert("Muitas tentativas. Tente mais tarde.");
        if(e.code==="auth/invalid-email") return alert("E-mail inv√°lido.");
        alert("Erro ao entrar. Tente novamente.");
      }
    }
    document.getElementById("btnEntrar").onclick = loginEmailSenha;

    /* MENU (preservado) */
    (function wireMenu(){
      const btn=document.getElementById('menuBtn'), menu=document.getElementById('menu');
      if(!btn || !menu) return;
      const open=()=>{ menu.style.display='flex'; document.addEventListener('click', onDoc, true); document.addEventListener('keydown', onKey) };
      const close=()=>{ menu.style.display='none'; document.removeEventListener('click', onDoc, true); document.removeEventListener('keydown', onKey) };
      const toggle=()=> (menu.style.display==='flex'?close():open());
      function onDoc(e){ if(!menu.contains(e.target) && e.target!==btn) close(); }
      function onKey(e){ if(e.key==='Escape') close(); }
      btn.addEventListener('click', toggle);
    })();

    /* ===== AVATAR (preservado) ===== */
    function setAvatar(url){
      if(!url) return;
      localStorage.setItem('fotoPerfil', url);
      const el = document.getElementById('userCircle'); if(!el) return;
      el.textContent = ''; el.style.display='flex';
      const img = new Image();
      img.src = cacheBust(url); img.alt='Foto'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
      el.append(img);
      const prev = $('#fotoPreview'); if(prev) prev.src = url;
    }
    (()=>{ const c = localStorage.getItem('fotoPerfil'); if(c) setAvatar(c); })();

    async function prefetchFoto(uid){
      const tryExt = e => getDownloadURL(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)).catch(()=>null);
      const direct = await tryExt('jpg') || await tryExt('png') || await tryExt('webp') || await tryExt('gif');
      if(direct){ setAvatar(direct); try{ await setDoc(doc(db,'usuarios',uid), { fotoPerfil:direct }, { merge:true }); }catch{} }
    }
    function extFromType(t){ return (t?.split('/')[1]||'jpg').replace('jpeg','jpg'); }
    async function previewImagem(ev, uid){
      const file = ev.target.files?.[0]; if(!file) return;
      $('#fotoPreview').src = URL.createObjectURL(file);
      const ext = extFromType(file.type);
      const storageRef = ref(storage, `usuarios/${uid}/perfil/avatar.${ext}`);
      await uploadBytes(storageRef, file, { contentType:file.type });
      const url = await getDownloadURL(storageRef);
      await setDoc(doc(db,'usuarios',uid), { fotoPerfil:url }, { merge:true });
      for(const e of ['jpg','png','webp','gif']) if(e!==ext) try{ await deleteObject(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)); }catch{}
      setAvatar(url);
      alert('Foto atualizada com sucesso!');
    }
    async function removerFoto(uid){
      let removed=false;
      for(const e of ['jpg','png','webp','gif']){ try{ await deleteObject(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)); removed=true; }catch{} }
      await setDoc(doc(db,'usuarios',uid),{ fotoPerfil:'' },{ merge:true });
      localStorage.removeItem('fotoPerfil');
      $('#fotoPreview').src=''; $('#userCircle').style.display='none';
      alert(removed? 'Foto removida.' : 'Nenhuma foto encontrada para remover.');
    }

    /* ======== BLOQUEIO DE USERNAME ======== */
    // Mant√©m o valor original carregado do Firestore e ignora qualquer tentativa de mudan√ßa.
    let ORIGINAL_USERNAME = '';

    /* ===== PERFIL (preservado com bloqueio de username) ===== */
    function slugify(v){
      return v.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9-_.]/g,'-')
        .replace(/-{2,}/g,'-').replace(/^[-_.]+|[-_.]+$/g,'');
    }
    async function salvar(uid){
      const nomeCompleto = $('#nomeCompleto').value.trim();

      // username fica SEMPRE o original; ignoramos o campo da tela
      const username = ORIGINAL_USERNAME;

      const data={
        nomeCompleto,
        // username e catalogoSlug N√ÉO s√£o atualizados aqui para impedir altera√ß√£o pelo cliente
        instagram: $('#instagram').value.trim(),
        facebook : $('#facebook').value.trim(),
        whatsapp : $('#whatsapp').value.trim(),
        youtube  : $('#youtube').value.trim(),
        updatedAt: serverTimestamp()
      };
      await setDoc(doc(db,'usuarios',uid), data, { merge:true });
      alert('Dados salvos! (nome de usu√°rio permanece bloqueado)');
      wireCatalogo(uid);
    }
    async function carregar(uid){
      const s = await getDoc(doc(db,'usuarios',uid));
      if(!s.exists()) return;
      const d=s.data();

      // Guarda e renderiza o username original
      ORIGINAL_USERNAME = (d.username || d.catalogoSlug || '').trim();
      $('#username').value     = ORIGINAL_USERNAME;
      $('#username').readOnly  = true;
      $('#username').setAttribute('aria-readonly','true');
      $('#username').title = 'Bloqueado para edi√ß√£o. Entre em contato com o suporte para alterar.';

      $('#nomeCompleto').value = d.nomeCompleto || '';
      $('#instagram').value    = d.instagram || '';
      $('#facebook').value     = d.facebook  || '';
      $('#whatsapp').value     = d.whatsapp  || '';
      $('#youtube').value      = d.youtube   || '';
    }

    /* ===== Assinaturas (preservado) ===== */
    const PLANOS = { basico:'Plano B√°sico', essencial:'Plano Intermedi√°rio', avancado:'Plano Avan√ßado', light:'Plano Light', trial:'Plano Trial', };
    const STATUS_LABEL = {
      'sem-plano':'Sem plano','pendente':'Pendente','ativo':'Ativo',
      'cancelamento_solicitado':'Cancelamento solicitado','cancelado':'Cancelado'
    };
    function renderAssinatura(data){
      const status = data?.status || 'sem-plano';
      const plano  = data?.plano  || null;
      const chip = document.getElementById('statusChip'); chip.className='chip '+status; chip.textContent = STATUS_LABEL[status]||'‚Äî';
      document.getElementById('planoLabel').textContent = 'Plano atual: ' + (plano? PLANOS[plano] : '‚Äî');
      const meta=[]; if(data?.createdAt?.toDate) meta.push('In√≠cio: ' + data.createdAt.toDate().toLocaleDateString());
      if(data?.updatedAt?.toDate) meta.push('Atualizado: ' + data.updatedAt.toDate().toLocaleString());
      document.getElementById('assinaturaMeta').textContent = meta.join(' ¬∑ ');
      const btnAssinar=document.getElementById('btnAssinar'),
            btnAlterar=document.getElementById('btnAlterar'),
            btnCancelar=document.getElementById('btnCancelar');
      if(status==='sem-plano' || !plano){
        btnAssinar.style.display='inline-block'; btnAlterar.style.display='none'; btnCancelar.style.display='none';
      }else if(status==='ativo' || status==='pendente'){
        btnAssinar.style.display='none'; btnAlterar.style.display='inline-block'; btnCancelar.style.display='inline-block';
      }else{
        btnAssinar.style.display='inline-block'; btnAlterar.style.display='none'; btnCancelar.style.display='none';
      }
    }
    async function ensureAssinaturaDoc(uid){
      const r = await getDoc(doc(db,'assinaturas',uid));
      if(!r.exists()){
        await setDoc(doc(db,'assinaturas',uid), {
          status:'sem-plano', plano:null, provider:'mercado_pago',
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        }, { merge:true });
      }
    }
    async function setAssinatura(uid, patch){
      await setDoc(doc(db,'assinaturas',uid), { updatedAt:serverTimestamp(), ...patch }, { merge:true });
    }
    function wireAssinatura(uid){
      onSnapshot(doc(db,'assinaturas',uid), snap=>{
        renderAssinatura(snap.exists()? snap.data() : { status:'sem-plano' });
      });
      document.getElementById('btnAssinar').onclick = ()=> location.href='/planos.html';
      document.getElementById('btnAlterar').onclick = ()=> location.href='/planos.html';
      document.getElementById('btnCancelar').onclick = async ()=>{
        if(!confirm('Confirmar cancelamento do plano?')) return;
        await setAssinatura(uid,{ status:'cancelamento_solicitado' });
        alert('Cancelamento solicitado. Entraremos em contato.');
      };
    }
    async function aplicarParametrosURL(uid){
      const p = new URLSearchParams(location.search);
      const status = p.get('status'); const plano = p.get('plano');
      if(!status && !plano) return;
      const patch = {};
      if(['pendente','ativo','cancelado'].includes(status)) patch.status = status;
      if(['basico','essencial','avancado','light','trial].includes(plano)) patch.plano = plano;
      if(Object.keys(patch).length) await setAssinatura(uid, patch);
      history.replaceState({}, '', location.pathname);
    }

    /* ===== Cat√°logo (preservado) ===== */
    async function wireCatalogo(uid){
      const btn  = document.getElementById('btnEditarCatalogo');
      const info = document.getElementById('catalogoInfo');
      btn.style.display='none'; info.style.display='none'; info.textContent='';

      // assinatura ativa?
      const assSnap = await getDoc(doc(db,'assinaturas',uid));
      const ass = assSnap.exists() ? assSnap.data() : null;
      const ativo = ass && String(ass.status||'').toLowerCase()==='ativo';
      if(!ativo){ return; }

      // slug (derivado do username original / catalogoSlug original)
      const uSnap = await getDoc(doc(db,'usuarios',uid));
      const u = uSnap.exists()? uSnap.data() : {};
      const slug = (u.catalogoSlug || u.username || '').trim();
      if(!slug){ return; }

      // config do cat√°logo
      const cfgRef = doc(db,'catalogos',slug,'meta','config');
      try {
        const cfg = await getDoc(cfgRef);
        if(cfg.exists() && cfg.data().ownerUid===uid && cfg.data().catalogoAtivo===true){
          btn.href = `/editar-catalogo.html?c=${encodeURIComponent(slug)}`;
          btn.style.display='inline-flex';
          info.textContent = `Cat√°logo habilitado. Slug: ${slug}`;
          info.style.display='block';
        }
      } catch {}
    }

    /* ===== Auth (preservado) ===== */
    onAuthStateChanged(auth, async (user)=>{
      const a = document.getElementById('authText');
      if(user){
        a.textContent='Sair';
        a.onclick=async(e)=>{ e.preventDefault(); await signOut(auth); localStorage.removeItem('fotoPerfil'); location='/index.html'; };

        document.getElementById('foto').onchange = ev => previewImagem(ev, user.uid);
        document.getElementById('btnSalvar').onclick = () => salvar(user.uid);
        document.getElementById('btnExcluirFoto').onclick = () => removerFoto(user.uid);

        await ensureAssinaturaDoc(user.uid);
        wireAssinatura(user.uid);
        await aplicarParametrosURL(user.uid);

        await carregar(user.uid);
        await prefetchFoto(user.uid);
        await wireCatalogo(user.uid);
      }else{
        // Mant√©m o comportamento original (alerta + esconder conte√∫do + redirecionar)
        document.getElementById('alertaLogin').style.display='block';
        document.querySelector('main.container').style.display='none';
        localStorage.removeItem('fotoPerfil');
        setTimeout(()=> location='/index.html', 4000);

        // E agora o bot√£o "Entrar" abre o modal de login (mesmo padr√£o)
        a.textContent='Entrar';
        a.onclick=(e)=>{ e.preventDefault(); abrirModal(); };
      }
    });
  </script>
</body>
</html>


