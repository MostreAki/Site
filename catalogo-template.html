<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cat√°logo Digital ‚Äî Editor | MostreAki</title>
<style>
  :root{
    --bg:#0b0c10; --panel:#111318; --ink:#eaf0f6; --ink-dim:#9aa7b2;
    --brand:#26c281; --brand-ink:#002b1a; --accent:#ffd166; --muted:#22262f;
    --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#0b0c10}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:52px;height:52px;border-radius:50%;overflow:hidden;background:#0e0;box-shadow:var(--shadow)}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:clamp(18px,2.6vw,28px)}
  .sub{color:var(--ink-dim);font-size:14px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--brand);color:var(--brand-ink);border:0;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(38,194,129,.3)}
  .btn.secondary{background:#222a33;color:var(--ink)}
  .config{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--muted);padding:14px;border-radius:var(--radius);margin-bottom:18px}
  .config label{display:grid;gap:6px;font-size:13px;color:var(--ink-dim)}
  .config input{background:#0f1318;color:var(--ink);border:1px solid #1f2430;padding:11px 12px;border-radius:12px;font-size:15px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media (min-width:520px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (min-width:960px){.grid{grid-template-columns:repeat(4,1fr)}}
  .card{background:var(--panel);border:1px solid #1a1f27;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .media{position:relative;aspect-ratio:1/1;display:grid;place-items:center;background:linear-gradient(180deg,#1b222b,#131821);cursor:pointer}
  .media input[type=file]{display:none}
  .media .hint{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.55);color:#fff;font-size:12px;padding:6px 8px;border-radius:10px}
  .media img{width:100%;height:100%;object-fit:cover}
  .img-fallback{display:grid;place-items:center;width:100%;height:100%;color:#6d7a86}
  .body{padding:12px;display:grid;gap:8px}
  .title input,.price-qty input{background:#0f1318;color:var(--ink);border:1px solid #1f2430;padding:10px;border-radius:10px;font-weight:600}
  .price-qty{display:grid;grid-template-columns:1fr 94px;gap:8px}
  .actions{display:flex;gap:8px;margin-top:6px}
  .wapp{flex:1;background:var(--brand);color:var(--brand-ink);border:0;padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
  .remove{background:#1f252e;color:#b2bdc7;border:0;padding:10px 12px;border-radius:12px;cursor:pointer}
  .foot{color:#7b8a96;font-size:12px;text-align:center;margin:20px 0}
</style>

<script>
  // ===== THEME: l√™ de ?bg, ?text, ?btn, ?head, ?foot, ?box (ou localStorage) =====
  (function applyTheme(){
    const qs = new URLSearchParams(location.search);
    const pick = (k,f)=> qs.get(k) ?? localStorage.getItem(k) ?? f;
    const d = v => {try{return decodeURIComponent(v)}catch{return v}};
    const theme = {
      bg:   d(pick('bg','#0b0c10')), text:d(pick('text','#eaf0f6')),
      btn:  d(pick('btn','#26c281')), head:d(pick('head','#111318')),
      foot: d(pick('foot','#111318')), box:d(pick('box','#111318')),
      bgSize:d(pick('bgSize','cover')), bgRepeat:d(pick('bgRepeat','no-repeat')),
      bgPosition:d(pick('bgPosition','center'))
    };
    const root = document.documentElement;
    root.style.setProperty('--bg', theme.bg);
    root.style.setProperty('--panel', theme.box);
    root.style.setProperty('--ink', theme.text);
    root.style.setProperty('--brand', theme.btn);
    // fundo: aceita cor #xxxxxx ou url(...)
    const isColor = /^#|^rgb|^hsl/i.test(theme.bg);
    document.body.style.background = isColor ? theme.bg : `url(${theme.bg}) ${theme.bgPosition}/${theme.bgSize} ${theme.bgRepeat}`;
  })();
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img id="storeLogo" alt="Logo"/></div>
        <div>
          <h1 id="title">Minha Loja</h1>
          <div class="sub">Editor ‚Äì adicione itens, salve e visualize</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnAddLogo" class="btn secondary">+ Adicionar logo</button>
        <button id="btnAdd" class="btn">+ Adicionar item</button>
        <button id="btnExport" class="btn secondary">Exportar JSON</button>
        <button id="btnPublish" class="btn">Salvar & Visualizar</button>
      </div>
    </header>

    <section class="config" aria-label="Configura√ß√µes do cat√°logo">
      <label>Nome da loja <input id="storeName" type="text" value="Minha Loja"/></label>
      <label>WhatsApp (apenas n√∫meros, com DDI/DDD) <input id="whatsNumber" type="tel" value="5599999999999"/></label>
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>
    <p class="foot">Dica: toque na imagem para enviar. O bot√£o WhatsApp monta a mensagem. ‚ÄúSalvar & Visualizar‚Äù gera um link compartilh√°vel.</p>
  </div>

  <template id="cardTpl">
    <article class="card" data-card>
      <label class="media" aria-label="Imagem do produto">
        <input type="file" accept="image/*" data-file />
        <img data-img hidden alt="Imagem do produto"/>
        <div class="img-fallback" data-fallback>üì∑</div>
        <div class="hint">Enviar foto</div>
      </label>
      <div class="body">
        <div class="title"><input type="text" placeholder="Nome do produto" value="Produto" data-name /></div>
        <div class="price-qty">
          <input type="text" inputmode="decimal" placeholder="Pre√ßo (R$)" value="R$ 0,00" data-price />
          <input type="number" min="1" step="1" value="1" data-qty />
        </div>
        <div class="actions">
          <button class="wapp" data-wa>Chamar no WhatsApp</button>
          <button class="remove" data-remove>Remover</button>
        </div>
      </div>
    </article>
  </template>

  <!-- Firebase SDKs (CDN modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // >>> SEU PROJETO
    const firebaseConfig = {
      apiKey: "AIzaSyBrkUtwP4T77oXE22OjOFVhfEUlJ7yctiE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.appspot.com",
      appId: "1:748712068097:web:09cf043bfb45917ef6ec00",
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const st  = getStorage(app);

    // ====== UI refs
    const grid = document.getElementById('grid');
    const tpl  = document.getElementById('cardTpl');
    const elStore = document.getElementById('storeName');
    const elWhats = document.getElementById('whatsNumber');
    const elLogo  = document.getElementById('storeLogo');
    const elTitle = document.getElementById('title');

    // ====== Util: moeda
    const fmtBRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const toCents = (str)=> parseInt((''+str).replace(/[^\d]/g,'' )||'0',10);
    const centsToBRL = (c)=> fmtBRL.format((c||0)/100);

    // ====== Rascunho local (n√£o some ao recarregar)
    const uid  = new URLSearchParams(location.search).get('uid') || localStorage.getItem('userUid') || 'anon';
    localStorage.setItem('userUid', uid);
    const DRAFT_KEY = `ma_draft_${uid}`;

    const saveDraft = ()=>{
      const items = [...grid.querySelectorAll('[data-card]')].map(card=>({
        name: card.querySelector('[data-name]').value.trim(),
        price_cents: toCents(card.querySelector('[data-price]').value),
        qty: parseInt(card.querySelector('[data-qty]').value||'1',10),
        image_url: card.querySelector('[data-img]')?.src || null
      }));
      const draft = {
        store: elStore.value.trim(),
        whatsapp: elWhats.value.replace(/\D/g,''),
        logoUrl: elLogo.src || null,
        items
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    };
    const loadDraft = ()=>{
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const d = JSON.parse(raw);
        if(d.store) elStore.value = d.store;
        if(d.whatsapp) elWhats.value = d.whatsapp;
        if(d.logoUrl){ elLogo.src = d.logoUrl; elLogo.hidden=false; }
        if(Array.isArray(d.items) && d.items.length){
          d.items.forEach(i=>newCard({name:i.name,cents:i.price_cents,qty:i.qty,src:i.image_url}));
        }
        elTitle.textContent = elStore.value || 'Minha Loja';
      }catch{}
    };

    // ====== Card
    function newCard(prefill={}){
      const node = tpl.content.firstElementChild.cloneNode(true);
      const file = node.querySelector('[data-file]');
      const img  = node.querySelector('[data-img]');
      const fb   = node.querySelector('[data-fallback]');
      const name = node.querySelector('[data-name]');
      const price= node.querySelector('[data-price]');
      const qty  = node.querySelector('[data-qty]');
      const wa   = node.querySelector('[data-wa]');
      const rm   = node.querySelector('[data-remove]');

      name.value  = prefill.name || 'Produto';
      price.value = centsToBRL(prefill.cents??0);
      qty.value   = prefill.qty || 1;
      if(prefill.src){ img.src=prefill.src; img.hidden=false; fb.hidden=true; }

      node.querySelector('.media').addEventListener('click', ()=> file.click());
      file.addEventListener('change', async (e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        // sobe para Storage (gera URL http)
        const path = `catalogos/${uid}/${Date.now()}_${(f.name||'img').replace(/\s+/g,'_')}`;
        const r = ref(st, path);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        img.src = url; img.hidden = false; fb.hidden = true;
        saveDraft();
      });

      price.addEventListener('input', (e)=>{ e.target.value = centsToBRL(toCents(e.target.value)); saveDraft(); });
      name.addEventListener('input', saveDraft);
      qty .addEventListener('input', saveDraft);

      wa.addEventListener('click', ()=>{
        const n=name.value.trim()||'Produto';
        const c=toCents(price.value); const q=parseInt(qty.value||'1',10);
        const total=centsToBRL(c*q);
        const msg=`Ol√°, vim do cat√°logo *${encodeURIComponent(elStore.value.trim())}*%0A`+
                  `Produto: *${encodeURIComponent(n)}*%0A`+
                  `Pre√ßo: *${encodeURIComponent(centsToBRL(c))}*%0A`+
                  `Quantidade: *${q}*%0ATotal: *${encodeURIComponent(total)}*`;
        window.open(`https://wa.me/${elWhats.value.replace(/\D/g,'')}?text=${msg}`,'_blank');
      });

      rm.addEventListener('click', ()=>{ node.remove(); saveDraft(); });

      grid.appendChild(node);
    }

    // ====== Bot√µes
    document.getElementById('btnAdd').addEventListener('click', ()=>{ newCard(); saveDraft(); });
    document.getElementById('btnAddLogo').addEventListener('click', async ()=>{
      const input = document.createElement('input');
      input.type='file'; input.accept='image/*';
      input.onchange = async ev=>{
        const f = ev.target.files?.[0]; if(!f) return;
        const r = ref(st, `logos/${uid}/${Date.now()}_${(f.name||'logo').replace(/\s+/g,'_')}`);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        elLogo.src = url; elLogo.hidden=false; saveDraft();
      };
      input.click();
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const data = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'catalogo-monstreaqui.json'});
      a.click(); URL.revokeObjectURL(a.href);
    });

    // ====== Publish -> Firestore (link curtinho)
    document.getElementById('btnPublish').addEventListener('click', async ()=>{
      // coleta
      const items = [...grid.querySelectorAll('[data-card]')].map(card=>({
        name: card.querySelector('[data-name]').value.trim(),
        price_cents: toCents(card.querySelector('[data-price]').value),
        qty: parseInt(card.querySelector('[data-qty]').value||'1',10),
        image_url: card.querySelector('[data-img]')?.src || null
      }));
      // bloqueia data: (deveria ser http do Storage)
      const hasDataUrl = items.some(i=> i.image_url && i.image_url.startsWith('data:'));
      if(hasDataUrl){ alert('Ainda h√° imagem local (data:). Reenvie e aguarde virar URL http(s).'); return; }

      const qs = new URLSearchParams(location.search);
      const theme = {
        bg: qs.get('bg')||localStorage.getItem('bg')||getComputedStyle(document.documentElement).getPropertyValue('--bg').trim(),
        text:qs.get('text')||localStorage.getItem('text')||'#eaf0f6',
        btn: qs.get('btn')||localStorage.getItem('btn')||'#26c281',
        head:qs.get('head')||localStorage.getItem('head')||'#111318',
        foot:qs.get('foot')||localStorage.getItem('foot')||'#111318',
        box: qs.get('box')||localStorage.getItem('box')||'#111318'
      };

      const payload = {
        uid, store: elStore.value.trim(),
        whatsapp: elWhats.value.replace(/\D/g,''),
        logoUrl: elLogo.src || null,
        theme, items, updated_at: serverTimestamp(), created_at: serverTimestamp()
      };

      try{
        const ref = await addDoc(collection(db,'catalogos'), payload);
        // salva snapshot de rascunho com id (opcional)
        localStorage.setItem(DRAFT_KEY, JSON.stringify({...payload}));
        const view = new URL('catalogo-view.html', location.href);
        view.searchParams.set('id', ref.id);
        try{ await navigator.clipboard.writeText(view.toString()); }catch{}
        window.open(view.toString(), '_blank');
      }catch(e){
        console.error(e);
        alert('Falha ao salvar no Firestore. Verifique credenciais e regras.');
      }
    });

    // ====== Onload
    elStore.addEventListener('input', ()=>{ elTitle.textContent = elStore.value || 'Minha Loja'; saveDraft(); });
    elWhats.addEventListener('input', saveDraft);
    loadDraft();
    if(grid.children.length===0){
      [{name:'P√¥ster Espiral',cents:6900,qty:1},{name:'Camisa MostreAki',cents:9900,qty:1},{name:'Adesivo Hiperb√≥reo',cents:1900,qty:2}]
        .forEach(seed=> newCard(seed));
    }
  </script>
</body>
</html>
