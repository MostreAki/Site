<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo • La Maggiê</title>
  <meta name="theme-color" content="#C46876" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --rose-900:#7A3F46;
      --rose-800:#9C555F;
      --rose-700:#C46876;
      --rose-600:#D97E8B;
      --rose-100:#FBE6EA;

      --ink:#3f2327;
      --muted:#8B6D73;
      --bg:#FFF7F1;
      --panel:#FDEFF2;
      --card:#ffffff;

      --ring:rgba(196,104,118,.28);
      --brand:#C46876;
      --ok:#25D366;

      --logo-size:86%;
      --banner-fit: cover;
      --banner-pos: center;
      --banner-min-h-mobile:160px;
      --banner-min-h-desktop:220px;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:linear-gradient(180deg, #FFF7F1, #FFEFEA 55%, #FFE8E9);
      color:#3f2327;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    }
    a{color:inherit;text-decoration:none}

    /* ====== TOPBAR ====== */
    header.topbar{
      position:sticky;
      top:0;
      z-index:60;
      background:linear-gradient(90deg,var(--rose-900),var(--rose-700));
      border-bottom:1px solid rgba(255,255,255,.10);
      color:#fff;
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:1.06rem;
      color:#fff;
    }
    .brand img{
      width:28px;
      height:28px;
      border-radius:999px;
      object-fit:cover;
      background:#fff;
    }
    .nav{
      display:flex;
      gap:14px;
      align-items:center;
    }
    .nav a{
      color:#fff;
      font-weight:600;
      padding:6px 10px;
      border-radius:10px;
      transition:.15s ease;
    }
    .nav a:hover,
    .nav a.active{
      background:rgba(255,255,255,.18);
    }
    .burger{
      display:none;
      width:38px;
      height:34px;
      border:none;
      background:rgba(255,255,255,.14);
      border-radius:12px;
      color:#fff;
      font-size:20px;
      cursor:pointer;
    }
    @media (max-width:860px){
      .nav{display:none;}
      .burger{display:block;}
    }
    .mobile-menu{
      display:none;
      position:fixed;
      top:62px;
      right:12px;
      background:#fff;
      color:var(--ink);
      border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.25);
      min-width:180px;
      z-index:80;
      padding:10px 6px;
    }
    .mobile-menu a{
      display:block;
      padding:8px 12px;
      border-radius:8px;
      font-weight:600;
    }
    .mobile-menu a:hover{background:rgba(196,104,118,.12);}
    .mobile-menu.show{display:block;}

    main{max-width:1100px;margin:0 auto;padding:28px 16px 90px}

    .hero{display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:6px}
    .logoRing{
      width:140px;height:140px;border-radius:999px;background:#fff;
      display:grid;place-items:center;position:relative;
      box-shadow:0 12px 40px rgba(0,0,0,.18), inset 0 0 0 6px var(--ring)
    }
    .logoRing img{width:var(--logo-size);height:var(--logo-size);object-fit:contain;border-radius:999px}

    .banner{
      width:100%;max-width:980px;min-height:var(--banner-min-h-mobile);border-radius:18px;
      background:linear-gradient(180deg,#FFECEE,#FDE6EA);
      box-shadow:0 20px 60px rgba(0,0,0,.12);
      overflow:hidden;position:relative;
    }
    @media (min-width:860px){.banner{min-height:var(--banner-min-h-desktop)}}
    .banner .slide{
      position:absolute;inset:0;opacity:0;transition:opacity .6s ease;
      display:flex;pointer-events:none;z-index:1;
    }
    .banner .slide.active{opacity:1;pointer-events:auto;z-index:2}
    .banner .slide a{position:absolute;inset:0;display:block;width:100%;height:100%}
    .banner img,.banner video{
      width:100%;height:100%;object-fit:var(--banner-fit);object-position:var(--banner-pos);display:block;
      pointer-events:none;
    }

    .search-bar{
      margin:18px 0;display:flex;gap:10px;
      max-width:980px;justify-content:center;
    }
    .search-input{
      flex:1;padding:10px 14px;border:2px solid rgba(196,104,118,.22);
      border-radius:12px;background:#fff;color:#3f2327;font-size:.95rem;
      outline:none;font-family:Poppins,sans-serif;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .search-input:focus{border-color:var(--rose-700);box-shadow:0 4px 16px rgba(196,104,118,.2)}
    .search-clear{
      display:none;border:0;background:#fff;color:#7A3F46;font-size:18px;
      width:36px;height:36px;border-radius:999px;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.08);align-items:center;justify-content:center;
    }
    .search-clear.show{display:grid}

    .pager{margin-top:18px;display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
    .navbtn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;
      border:2px solid rgba(196,104,118,.22);
      background:rgba(196,104,118,.08);
      color:var(--rose-900);font-weight:800;cursor:pointer
    }
    .navbtn[disabled]{opacity:.45;cursor:not-allowed}
    .navbtn svg{width:18px;height:18px;fill:var(--rose-900)}
    .pageinfo{font-weight:700;color:var(--rose-700)}

    .grid{margin-top:18px;display:grid;gap:16px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (min-width:860px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}

    .card{
      background:linear-gradient(180deg,#ffffff,#FFF4F6);
      border:1px solid rgba(196,104,118,.18);
      border-radius:16px;overflow:hidden;
      box-shadow:0 12px 30px rgba(196,104,118,.15);
      transition:transform .15s ease, box-shadow .15s ease
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 18px 44px rgba(196,104,118,.26)}
    .imgWrap{aspect-ratio:1/1;background:#FBE6EA;display:grid;place-items:center;overflow:hidden;cursor:zoom-in}
    .imgWrap img{width:100%;height:100%;object-fit:cover}

    .info{display:grid;grid-template-columns:1fr;row-gap:6px;align-items:start;padding:10px 12px 12px}
    .nome{font-weight:700;color:var(--ink);margin-bottom:2px;font-size:.98rem}
    .preco{font-weight:800;color:var(--rose-900);font-size:1rem}
    .qtde{color:var(--muted);font-size:.86rem;margin-top:2px}

    .thumbs{display:flex;gap:8px;margin:8px 0 6px}
    .thumbs img{
      width:40px;height:40px;object-fit:cover;border-radius:8px;opacity:.95;
      border:1px solid rgba(196,104,118,.28);cursor:pointer;
      transition:transform .12s ease, opacity .12s ease
    }
    .thumbs img:hover{opacity:1;transform:translateY(-1px)}

    .actions{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .cta{
      display:inline-flex;align-items:center;gap:10px;width:fit-content;
      padding:10px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.10);text-shadow:0 1px 0 rgba(0,0,0,.06);
    }
    .cta-wa{background:var(--ok);color:#fff}
    .cta-ml{background:#FFE600;color:#002E6C}

    .wa-float{
      position:fixed;right:16px;bottom:16px;z-index:60;width:56px;height:56px;border-radius:999px;
      background:var(--ok);display:none;align-items:center;justify-content:center;
      box-shadow:0 12px 32px rgba(37,211,102,.35);
    }
    .wa-float svg{width:28px;height:28px;fill:#fff}

    .muted{margin:22px auto 0;max-width:780px;color:#7F5F65;text-align:center;font-size:.95rem}
    .warn{
      background:#FFF1F2;color:#7A3F46;border:1px solid #FBCFE8;
      padding:12px 14px;border-radius:12px;margin:18px auto;max-width:840px
    }
    footer{
      color:#7A3F46;font-size:.8rem;text-align:center;padding:32px 16px;
      border-top:1px solid rgba(196,104,118,.22)
    }

    /* lightbox */
    .lb-bg{position:fixed;inset:0;z-index:70;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:saturate(120%) blur(2px);padding:16px}
    .lb-card{position:relative;max-width:96vw;max-height:90vh;background:#2b0f14;border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.55);padding:10px}
    .lb-img{display:block;max-width:92vw;max-height:82vh;object-fit:contain;border-radius:10px;background:#3a141b}
    .lb-close{position:absolute;top:8px;right:8px;border:0;width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.12);color:#ffeef2;cursor:pointer;font-size:22px;line-height:36px}
    .lb-arrow{position:absolute;top:50%;transform:translateY(-50%);border:0;width:42px;height:42px;border-radius:999px;background:rgba(255,255,255,.16);color:#ffeef2;cursor:pointer;font-size:22px;line-height:42px}
    .lb-prev{left:8px}.lb-next{right:8px}
    .lb-count{position:absolute;bottom:10px;right:12px;background:rgba(0,0,0,.45);color:#ffeef2;font-size:.85rem;padding:6px 10px;border-radius:10px}
  </style>
</head>
<body>
  <!-- topo -->
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="/">
        <img id="brand-mini" src="" alt="La Maggiê">
        <span>La Maggiê</span>
      </a>
      <nav class="nav">
        <a href="/">Página Inicial</a>
        <a href="/sobre">Sobre</a>
        <a href="/catalogo-lamaggie" class="active">Catálogo</a>
        <a href="/avaliacoes">Avaliações</a>
        <a href="/contato">Contato</a>
      </nav>
      <button class="burger" id="menuBtn" aria-label="menu">☰</button>
    </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="/">Página Inicial</a>
      <a href="/sobre">Sobre</a>
      <a href="/catalogo-lamaggie" class="active">Catálogo</a>
      <a href="/avaliacoes">Avaliações</a>
      <a href="/contato">Contato</a>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="logoRing" id="logoRing">
        <img id="logoImg" alt="Logo" src="" onerror="this.style.display='none'">
      </div>
      <h1 class="title" id="tituloEmpresa">La Maggiê</h1>
      <div class="banner" id="bannerBox"></div>
    </section>

    <div class="search-bar">
      <input id="searchInput" class="search-input" type="text" placeholder="Pesquisar produtos..." aria-label="Pesquisar produtos">
      <button id="searchClear" class="search-clear" aria-label="Limpar pesquisa">×</button>
    </div>

    <div id="pagerTop" class="pager">
      <button class="navbtn btnPrev" onclick="goPrev()" aria-label="Anterior">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        Anterior
      </button>
      <span class="pageinfo">Página 1 de 1</span>
      <button class="navbtn btnNext" onclick="goNext()" aria-label="Próximo">
        Próximo
        <svg viewBox="0 0 24 24"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6z"/></svg>
      </button>
    </div>

    <section class="grid" id="grid"></section>

    <div class="pager" style="margin-top:16px">
      <button class="navbtn btnPrev" onclick="goPrev()" aria-label="Anterior">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        Anterior
      </button>
      <span class="pageinfo">Página 1 de 1</span>
      <button class="navbtn btnNext" onclick="goNext()" aria-label="Próximo">
        Próximo
        <svg viewBox="0 0 24 24"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6z"/></svg>
      </button>
    </div>

    <p class="muted">
      Toque numa imagem para ver a galeria. Clique no WhatsApp para falar direto. Se o item tiver link, aparece o botão Comprar.
    </p>
  </main>

  <a id="waFloat" class="wa-float" href="#" target="_blank" rel="noopener" aria-label="WhatsApp">
    <svg viewBox="0 0 32 32" role="img" aria-hidden="true"><path d="M19.1 17.1c-.3-.2-1.7-.8-2-.9-.3-.1-.5-.2-.7.2-.2.3-.8.9-.9 1.1-.2.2-.3.2-.6.1-.3-.2-1.1-.4-2-1.2-.7-.6-1.2-1.4-1.3-1.6-.1-.3 0-.4.1-.6.1-.1.3-.3.4-.5.1-.2.2-.3.3-.5.1-.2.1-.4 0-.6-.1-.2-.7-1.7-.9-2.3-.2-.5-.5-.4-.7-.4h-.6c-.2 0-.6.1-.9.4-.3.3-1.1 1.1-1.1 2.7 0 1.6 1.1 3.1 1.2 3.3.1.2 2.2 3.4 5.4 4.7.8.4 1.4.6 1.9.8.8.3 1.6.3 2.2.2.7-.1 2-.8 2.2-1.6.3-.8.3-1.5.2-1.6 0-.1-.2-.1-.4-.2zM16 3C9.9 3 5 7.9 5 14c0 2.4.8 4.6 2.1 6.3L6 29l8-1.9c1.5.4 3.1.7 4.7.7 6.1 0 11-4.9 11-11S22.1 3 16 3z"/></svg>
  </a>

  <!-- lightbox -->
  <div id="lbBg" class="lb-bg" role="dialog" aria-modal="true" aria-label="Imagem ampliada">
    <div class="lb-card">
      <button id="lbClose" class="lb-close" aria-label="Fechar">×</button>
      <button id="lbPrev" class="lb-arrow lb-prev" aria-label="Imagem anterior">‹</button>
      <button id="lbNext" class="lb-arrow lb-next" aria-label="Próxima imagem">›</button>
      <img id="lbImg" class="lb-img" alt="">
      <div id="lbCount" class="lb-count">1 / 1</div>
    </div>
  </div>

  <footer>© <span id="ano"></span> La Maggiê · Catálogo</footer>
  <script>document.getElementById('ano').textContent = new Date().getFullYear();</script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, orderBy, onSnapshot, limit as qLimit } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // menu mobile
    const btn = document.getElementById("menuBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    btn?.addEventListener("click", () => {
      mobileMenu.classList.toggle("show");
    });
    document.addEventListener("click", (e) => {
      if (!mobileMenu.contains(e.target) && e.target !== btn) {
        mobileMenu.classList.remove("show");
      }
    });

    const PLACEHOLDER =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <rect width="100%" height="100%" fill="#FBE6EA"/>
          <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" fill="#C46876" font-size="28" font-family="Arial">sem imagem</text>
        </svg>`
      );

    const PER_PAGE = 10;
    let itens = [];
    let filteredItens = [];
    let page = 0;
    let MAX_FOTOS_ITEM = 3;

    function totalPages() { return Math.max(1, Math.ceil(filteredItens.length / PER_PAGE)); }
    function clampPage() { page = Math.min(page, totalPages() - 1); if (page < 0) page = 0; }

    function getSlug() {
      const path = location.pathname;
      let m = path.match(/\/catalogo-([^\/.]+)(?:\.html)?\/?$/i);
      if (m) return m[1];
      const u = new URL(location.href);
      const qsSlug = u.searchParams.get('c') || u.searchParams.get('slug');
      if (qsSlug) return qsSlug.trim();
      const host = location.hostname;
      const first = host.split('.')[0];
      if (first && first !== 'www' && first !== 'mostreaki') {
        return first.toLowerCase();
      }
      return '';
    }
    const slug = getSlug();

    function goPrev() { if (page > 0) { page--; renderPage(); window.scrollTo({ top: 0, behavior: 'smooth' }); } }
    function goNext() { if (page < totalPages() - 1) { page++; renderPage(); window.scrollTo({ top: 0, behavior: 'smooth' }); } }
    window.goPrev = goPrev;
    window.goNext = goNext;

    // lightbox
    const lbBg = document.getElementById('lbBg');
    const lbImg = document.getElementById('lbImg');
    const lbClose = document.getElementById('lbClose');
    const lbPrev = document.getElementById('lbPrev');
    const lbNext = document.getElementById('lbNext');
    const lbCount = document.getElementById('lbCount');
    let LB_GALLERY = [];
    let LB_IDX = 0;

    function showLbImage() {
      lbImg.src = LB_GALLERY[LB_IDX];
      lbCount.textContent = `${LB_IDX + 1} / ${LB_GALLERY.length}`;
    }
    function openLightboxGallery(gal, idx = 0) {
      if (!Array.isArray(gal) || !gal.length) return;
      LB_GALLERY = gal;
      LB_IDX = idx;
      lbBg.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      showLbImage();
    }
    function closeLightbox() {
      lbBg.style.display = 'none';
      document.body.style.overflow = '';
    }
    function lbPrevFn(){ if (LB_GALLERY.length>1){ LB_IDX = (LB_IDX -1 + LB_GALLERY.length) % LB_GALLERY.length; showLbImage(); } }
    function lbNextFn(){ if (LB_GALLERY.length>1){ LB_IDX = (LB_IDX +1) % LB_GALLERY.length; showLbImage(); } }
    lbClose.addEventListener('click', closeLightbox);
    lbBg.addEventListener('click', e => { if (e.target === lbBg) closeLightbox(); });
    lbPrev.addEventListener('click', lbPrevFn);
    lbNext.addEventListener('click', lbNextFn);

    function renderPage() {
      clampPage();
      const start = page * PER_PAGE;
      const slice = filteredItens.slice(start, start + PER_PAGE);
      const gridEl = document.getElementById('grid');

      if (!slice.length) {
        gridEl.innerHTML = `<div class="warn" style="grid-column:1/-1">Nenhum item encontrado.</div>`;
      } else {
        gridEl.innerHTML = slice.map(d => {
          const galAttr = JSON.stringify(d.fotos).replace(/"/g, '&quot;');
          const thumbs = d.fotos.slice(0, MAX_FOTOS_ITEM)
            .map((u, i) => `<img src="${u}" alt="" data-idx="${i}">`).join('');

          const whatsappHref = d.zap || d.whatsappHref || null;

          return `
          <article class="card">
            <div class="imgWrap" data-gal="${galAttr}"> 
              <img loading="lazy" alt="${d.nome}" src="${d.thumb}" onerror="this.src='${PLACEHOLDER}'">
            </div>
            <div class="info">
              <div class="nome">${d.nome}</div>
              <div class="preco">${d.precoBRL}</div>
              <div class="qtde">Estoque: ${d.qtd}</div>
              ${thumbs ? `<div class="thumbs" data-gal="${galAttr}">${thumbs}</div>` : ``}
              <div class="actions">
                ${whatsappHref ? `<a class="cta cta-wa" href="${whatsappHref}" target="_blank" rel="noopener">Chamar no WhatsApp</a>` : ``}
                ${d.mlUrl ? `<a class="cta cta-ml" href="${d.mlUrl}" target="_blank" rel="noopener">Comprar</a>` : ``}
              </div>
            </div>
          </article>`;
        }).join('');
      }

      document.querySelectorAll('.pageinfo').forEach(el => {
        el.textContent = `Página ${Math.min(page + 1, totalPages())} de ${totalPages()}`;
      });
      document.querySelectorAll('.btnPrev').forEach(b => b.disabled = (page <= 0));
      document.querySelectorAll('.btnNext').forEach(b => b.disabled = (page >= totalPages() - 1));

      document.querySelectorAll('.imgWrap, .thumbs').forEach(el => {
        el.addEventListener('click', e => {
          const gal = JSON.parse(el.getAttribute('data-gal') || '[]');
          const idx = e.target.dataset.idx ? Number(e.target.dataset.idx) : 0;
          openLightboxGallery(gal, idx);
        });
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const searchClear = document.getElementById('searchClear');

      function filterItems() {
        const query = searchInput.value.trim().toLowerCase();
        searchClear.classList.toggle('show', query.length > 0);

        if (!query) {
          filteredItens = itens;
        } else {
          const terms = query.split(/\s+/);
          filteredItens = itens.filter(item => {
            const text = (item.nome + ' ' + (item.tags || '')).toLowerCase();
            return terms.every(term => text.includes(term));
          });
        }
        page = 0;
        renderPage();
      }

      searchInput.addEventListener('input', filterItems);
      searchClear.addEventListener('click', () => {
        searchInput.value = '';
        filteredItens = itens;
        searchClear.classList.remove('show');
        page = 0;
        renderPage();
      });
    }

    // helpers de banner
    const mq = window.matchMedia('(max-width: 720px)');
    let BANNER_SLIDES = [];
    let BANNER_IDX = 0;
    let BANNER_TIMER = null;

    function arrayFromAliases(obj, keys) {
      const out = [];
      for (const k of keys) {
        const v = obj[k];
        if (Array.isArray(v)) out.push(...v);
        else if (typeof v === 'string' && v) out.push(v);
      }
      return out;
    }

    function collectBannerUrlsByMode(cfg) {
      const isMob = mq.matches;
      const mobileList = arrayFromAliases(cfg, [
        'bannerMobileUrls','mobileBannerUrls',
        'bannerMobileUrl','bannerMobile1Url','bannerMobile2Url','bannerMobile3Url'
      ]);
      const desktopList = arrayFromAliases(cfg, [
        'bannerDesktopUrls','desktopBannerUrls',
        'bannerDesktopUrl','bannerDesktop1Url','bannerDesktop2Url','bannerDesktop3Url'
      ]);

      let urls = isMob ? mobileList : desktopList;

      if (!urls.length) {
        urls = arrayFromAliases(cfg, [
          'bannerUrls','banners',
          'bannerUrl','banner1Url','banner2Url','banner3Url'
        ]);
      }

      urls = [...new Set(urls.filter(Boolean))].slice(0, 3);
      return urls;
    }

    function collectBannerLinksByMode(cfg) {
      const isMob = mq.matches;
      const mobileLinks = arrayFromAliases(cfg, [
        'bannerMobileLinks','mobileBannerLinks',
        'bannerMobileLink','bannerMobileLink1','bannerMobileLink2','bannerMobileLink3'
      ]);
      const desktopLinks = arrayFromAliases(cfg, [
        'bannerDesktopLinks','desktopBannerLinks',
        'bannerDesktopLink','bannerDesktopLink1','bannerDesktopLink2','bannerDesktopLink3'
      ]);
      let links = isMob ? mobileLinks : desktopLinks;
      if (!links.length) {
        links = arrayFromAliases(cfg, [
          'bannerLinks','bannerLink','bannerLink1','bannerLink2','bannerLink3'
        ]);
      }
      const out = ['', '', ''];
      for (let i=0;i<3;i++){
        const v = links[i];
        out[i] = (typeof v === 'string') ? v.trim() : '';
      }
      return out;
    }

    function effectiveFit(cfg) {
      const isMob = mq.matches;
      const v = isMob ? (cfg.bannerFitMobile || cfg.bannerfitMobile)
                      : (cfg.bannerFitDesktop || cfg.bannerfitDesktop);
      return (v || cfg.bannerFit || 'cover') === 'contain' ? 'contain' : 'cover';
    }

    function effectivePosition(cfg) {
      const isMob = mq.matches;
      return (isMob ? (cfg.bannerPositionMobile || cfg.bannerpositionMobile)
                    : (cfg.bannerPositionDesktop || cfg.bannerpositionDesktop))
             || cfg.bannerPosition || 'center';
    }

    function effectiveMinHeight(cfg) {
      const isMob = mq.matches;
      const px = Number(isMob ? cfg.bannerHeightMobile : cfg.bannerHeightDesktop);
      return Number.isFinite(px) ? Math.max(80, Math.min(800, px)) : null;
    }

    function setupBanners(cfg) {
      const box = document.getElementById('bannerBox');
      if (!box) return;
      box.innerHTML = '';

      const urls = collectBannerUrlsByMode(cfg);
      const links = collectBannerLinksByMode(cfg);
      if (!urls.length) return;

      box.style.setProperty('--banner-fit', effectiveFit(cfg));
      box.style.setProperty('--banner-pos', effectivePosition(cfg));
      const minH = effectiveMinHeight(cfg);
      if (minH) box.style.minHeight = minH + 'px';

      BANNER_SLIDES = urls.map((u, i) => {
        const slide = document.createElement('div');
        slide.className = 'slide' + (i === 0 ? ' active' : '');
        const low = u.toLowerCase();
        const hasLink = (typeof links[i] === 'string' && links[i].trim().length > 0);
        const wrap = hasLink ? Object.assign(document.createElement('a'), { href: links[i], target: '_blank', rel: 'noopener', 'aria-label': 'Ver mais' }) : null;
        const node = (low.endsWith('.mp4') || low.endsWith('.webm'))
          ? (() => { const v = document.createElement('video'); v.src = u; v.muted = true; v.playsInline = true; v.preload = 'none'; if (urls.length === 1) v.autoplay = v.loop = true; return v; })()
          : (() => { const img = new Image(); img.src = u; img.alt = 'Banner'; img.loading = 'lazy'; return img; })();

        if (wrap) { wrap.appendChild(node); slide.appendChild(wrap); }
        else { slide.appendChild(node); }

        box.appendChild(slide);
        return slide;
      });

      if (BANNER_SLIDES.length > 1) {
        const interval = Number(cfg.bannerIntervalMs) || 7000;
        clearInterval(BANNER_TIMER);
        BANNER_TIMER = setInterval(() => {
          const cur = BANNER_SLIDES[BANNER_IDX];
          const nxtIdx = (BANNER_IDX + 1) % BANNER_SLIDES.length;
          const nxt = BANNER_SLIDES[nxtIdx];
          cur.classList.remove('active');
          nxt.classList.add('active');
          BANNER_IDX = nxtIdx;
        }, interval);
      }
    }

    function waLink(phone, text) {
      if (!phone) return null;
      let p = String(phone).replace(/\D/g, '');
      if (p.startsWith('0')) p = p.slice(1);
      if (p.length <= 11 && !p.startsWith('55')) p = '55' + p;
      return `https://wa.me/${p}?text=${encodeURIComponent(text)}`;
    }

    async function carregar() {
      const avisos = document.createElement('div');
      avisos.id = 'avisos';
      const anchor = document.getElementById('pagerTop');
      anchor.parentNode.insertBefore(avisos, anchor);

      if (!slug) {
        avisos.innerHTML = `<div class="warn">Catálogo não encontrado. Informe o slug (?c=slug).</div>`;
        return;
      }

      // 1) tenta catálogo
      const cfgRef1 = doc(db, `catalogos/${slug}/meta/config`);
      const snap1 = await getDoc(cfgRef1);

      // 2) se não tiver, tenta sites/...
      let cfg;
      if (snap1.exists()) {
        cfg = snap1.data();
      } else {
        const cfgRef2 = doc(db, `sites/${slug}/meta/config`);
        const snap2 = await getDoc(cfgRef2);
        if (!snap2.exists()) {
          avisos.innerHTML = `<div class="warn">Configuração não encontrada em catálogo e nem em site.</div>`;
          return;
        }
        cfg = snap2.data();
      }

      // logo do topo
      const topoLogo = document.getElementById('brand-mini');
      if (topoLogo && (cfg.logoUrl || (cfg.site && cfg.site.logoUrl))) {
        topoLogo.src = cfg.logoUrl || cfg.site.logoUrl;
      }

      // hero logo
      if (cfg.logoUrl || (cfg.site && cfg.site.logoUrl)) {
        const el = document.getElementById('logoImg');
        el.src = cfg.logoUrl || cfg.site.logoUrl;
        el.style.display = 'block';
      }

      const nome = cfg.nomeEmpresa || cfg.titulo || 'La Maggiê';
      document.title = `Catálogo • ${nome}`;
      document.getElementById('tituloEmpresa').textContent = nome;

      // banners
      setupBanners(cfg);

      setupSearch();

      if (cfg.catalogoAtivo === false) {
        avisos.innerHTML = `<div class="warn">Este catálogo está desativado no momento.</div>`;
        return;
      }

      // whatsapp flutuante
      const whats = (cfg.whats || '').toString().trim();
      const waFab = document.getElementById('waFloat');
      if (whats) {
        const msg = `Olá! Tenho interesse no catálogo ${nome}.`;
        const link = waLink(whats, msg);
        if (link) { waFab.href = link; waFab.style.display = 'flex'; }
      }

      const limitePublico = Number.isFinite(cfg.limitePublico) ? cfg.limitePublico : null;
      if (Number.isFinite(cfg.maxFotosPorItem)) {
        MAX_FOTOS_ITEM = Math.max(1, Math.min(3, cfg.maxFotosPorItem));
      }

      const colPath = `catalogos/${slug}/itens`;

      const q = query(
        collection(db, colPath),
        orderBy('ordem', 'asc'),
        ...(limitePublico ? [qLimit(limitePublico)] : [])
      );

      onSnapshot(q, snap => {
        const arr = [];
        let idx = 0;
        snap.forEach(docSnap => {
          const d = docSnap.data(); if (d.ativo === false) return;
          idx++;
          const nomeItem = d.nome || `Item ${idx}`;

          let precoBRL = '—';
          if (typeof d.precoCentavos === 'number') {
            precoBRL = (d.precoCentavos / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          } else if (typeof d.preco === 'number') {
            precoBRL = d.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          } else if (typeof d.preco === 'string') {
            const n = Number(d.preco.replace(',', '.')); if (Number.isFinite(n)) precoBRL = n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          }

          const qtd = (typeof d.quantidade === 'number') ? d.quantidade
                    : (typeof d.qtde === 'number') ? d.qtde : '—';

          let fotos = [];
          if (Array.isArray(d.imagens) && d.imagens.length) {
            fotos = d.imagens.filter(Boolean);
          } else {
            fotos = [d.urlImagem, d.urlImagem2, d.urlImagem3].filter(Boolean);
          }
          const gal = fotos.length ? fotos : [PLACEHOLDER];
          const thumb = gal[0];

          const msg = `Olá! Tenho interesse no *${nomeItem}* do catálogo ${nome}.`;
          const zap = waLink(d.whats || whats, msg);

          arr.push({
            nome: nomeItem,
            precoBRL,
            qtd,
            fotos: gal,
            thumb,
            zap,
            mlUrl: d.mlUrl || null,
            tags: (Array.isArray(d.tags) ? d.tags.join(' ') : (d.tags || d.palavrasChave || '')).toString().trim(),
            whatsappHref: zap
          });
        });

        itens = arr;
        filteredItens = itens;
        clampPage();
        renderPage();
      });
    }

    carregar();
  </script>
</body>
</html>
