<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catálogo • MostreAki</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --mk-bg1:#0f6f69;      /* fundo escuro MostreAki */
    --mk-bg2:#179b93;      /* gradiente */
    --mk-card:#f3f5f6;     /* card clarinho */
    --mk-ink:#24423f;      /* texto principal */
    --mk-ink-soft:#5e7b76; /* texto secundário */
    --mk-accent:#1fb394;   /* botões/realces */
    --mk-title:#c6f2e0;    /* sua cor pedida para títulos */
    --mk-shadow: 0 10px 24px rgba(0,0,0,.18), 0 4px 12px rgba(0,0,0,.12);
    --radius: 20px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--mk-ink);
    background: radial-gradient(1200px 600px at 20% -10%, #1aa79f22 0%, #0000 60%),
                linear-gradient(180deg, var(--mk-bg1), var(--mk-bg2));
    min-height:100dvh;
  }

  /* topo */
  .topbar{
    display:flex; align-items:center; gap:14px;
    padding:16px 20px;
    background:linear-gradient(90deg, #b8efe1aa, #b8efe122);
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid #ffffff2e;
    position:sticky; top:0; z-index:50;
  }
  .brand{ display:flex; align-items:center; gap:10px; }
  .brand img{ width:34px; height:34px; border-radius:999px; }
  .brand strong{ font-weight:800; letter-spacing:.2px; color:#ffffff; text-shadow:0 1px 0 #0003; }
  .brand b{ color:#ff4b55 }

  /* cabeçalho do catálogo */
  .hero{
    max-width:1100px; margin:28px auto 16px; padding:0 16px;
    text-align:center; position:relative;
  }
  .banner{
    height:180px; border-radius:var(--radius);
    background:linear-gradient(180deg, #cfeff9, #e8f7ff);
    box-shadow:var(--mk-shadow); overflow:hidden;
    display:grid; place-items:center;
  }
  .logo{
    width:120px; height:120px; border-radius:999px;
    background:#fff; border:6px solid #ffffffcc;
    box-shadow:var(--mk-shadow);
    position:absolute; inset:auto 0 -60px; margin:auto;
    display:grid; place-items:center; overflow:hidden;
  }
  .logo img{ width:100%; height:100%; object-fit:cover; border-radius:50%; }
  .title{
    margin-top:90px;
    font-size:clamp(26px, 4vw, 38px);
    font-weight:800; letter-spacing:.3px;
    color:var(--mk-title);
    text-shadow: 0 4px 16px rgba(0,0,0,.35), 0 1px 0 #0003;
  }
  .subtitle{
    margin:8px 0 6px; color:#e9fbf6; font-weight:600;
    text-shadow:0 1px 0 #0003;
  }

  /* grid de produtos */
  .wrap{ max-width:1100px; margin:18px auto 60px; padding:0 16px; }
  .grid{
    display:grid; gap:16px;
    grid-template-columns:repeat( auto-fill, minmax(240px,1fr) );
  }
  .card{
    background:var(--mk-card); border-radius:18px; overflow:hidden;
    box-shadow:var(--mk-shadow); display:flex; flex-direction:column;
    border:1px solid #e7ebee;
  }
  .thumb{
    aspect-ratio: 4 / 3; /* grande, como no seu mock */
    background:#e7ecef; border-bottom:1px solid #dde3e7;
    display:grid; place-items:center;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; }
  .meta{ padding:12px; display:grid; grid-template-columns:1fr auto; gap:8px 10px; align-items:center; }
  .meta .name{ grid-column:1 / -1; font-weight:700; color:#355a55; }
  .field{ display:flex; align-items:center; gap:6px; font-weight:700; color:#355a55; }
  .field input{
    width:100%; max-width:110px; padding:8px 10px; border-radius:10px;
    border:1px solid #cfd8dd; background:#fff; font:600 14px Poppins, sans-serif; color:#263532;
    outline:none; box-shadow:inset 0 1px 0 #fff;
  }
  .wa{
    width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
    background:#25D366; color:#fff; border:none; cursor:pointer;
    box-shadow: 0 6px 16px rgba(37,211,102,.35);
    transition: transform .08s ease-out;
  }
  .wa:active{ transform: translateY(1px) scale(.98); }
  .wa svg{ width:24px; height:24px; fill:currentColor }

  /* barra de ações */
  .bar{
    max-width:1100px; margin:8px auto 0; padding:0 16px 6px;
    display:flex; gap:10px; justify-content:flex-end; align-items:center;
  }
  .pill{
    border:none; background:var(--mk-accent); color:#fff; font-weight:800;
    padding:10px 14px; border-radius:999px; box-shadow:var(--mk-shadow); cursor:pointer;
  }
  .pill[disabled]{ opacity:.5; cursor:not-allowed; }

  /* rodapé */
  footer{
    color:#cfe9e4; text-align:center; padding:26px 16px 44px;
    background:linear-gradient(180deg, #0e6b65, #0a4e4a);
    border-top:1px solid #ffffff22;
  }
  footer small{ opacity:.9 }
</style>
</head>
<body>

  <!-- Topo simples no padrão MostreAki -->
  <div class="topbar">
    <div class="brand">
      <img src="https://mostreaki.com.br/img/mostreaki-icon.png" alt="">
      <strong>Mostre<b>Aki</b></strong>
    </div>
    <div style="margin-left:auto;color:#eafff9;font-weight:700;">Catálogo</div>
  </div>

  <!-- Hero com banner + logo + títulos -->
  <header class="hero">
    <div class="banner" id="banner">
      <!-- pode trocar por imagem de fundo via JS -->
      <div style="opacity:.35;font-weight:800;font-size:22px;color:#0f6f69">Banner</div>
    </div>
    <div class="logo" id="logo">
      <!-- logo circular -->
      <img id="logoImg" alt="logo">
    </div>
    <div class="title" id="catTitle">Catálogo do Cliente</div>
    <div class="subtitle" id="catSubtitle">Escolha um item e chame no WhatsApp</div>
  </header>

  <!-- Barra de ações (aparece no modo edição) -->
  <div class="bar" id="editBar" hidden>
    <button class="pill" id="saveBtn" disabled>Salvar alterações</button>
  </div>

  <!-- Grid de produtos -->
  <main class="wrap">
    <section class="grid" id="grid"></section>
  </main>

  <footer>
    <small>© <span id="year"></span> MostreAki. Todos os direitos reservados.</small>
  </footer>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, onSnapshot,
      setDoc, updateDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    /* ====== CONFIGURE ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      databaseURL: "https://mostreaki-2025-default-rtdb.firebaseio.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    };

    /* Host dos assets (GitHub Pages, por ex.) */
    const ASSETS_HOST = "https://assets.mostreaki.com.br";
    /* ====== /CONFIGURE ====== */

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(location.search);
    const slug   = params.get("c") || "demo";     // catálogo do cliente
    const editRequested = params.get("edit")==="1";

    const ui = {
      title: document.getElementById('catTitle'),
      subtitle: document.getElementById('catSubtitle'),
      logoImg: document.getElementById('logoImg'),
      banner: document.getElementById('banner'),
      grid: document.getElementById('grid'),
      editBar: document.getElementById('editBar'),
      saveBtn: document.getElementById('saveBtn')
    };

    document.getElementById('year').textContent = new Date().getFullYear();

    /* Util: compõe URL da imagem */
    const imgURL = (file) => `${ASSETS_HOST}/catalogo/${slug}/${file}`;

    /* WhatsApp helper */
    const phoneDigits = (raw) => (raw||"").replace(/\D/g, "");
    const waMessage = (nome, preco, qtd) =>
      `Olá! Tenho interesse no item *${nome}*.\nQtde: ${qtd || 1}\nPreço: R$ ${Number(preco||0).toFixed(2)}`;

    /* Estado de edição pendente */
    const dirty = new Map(); // idDoc -> {preco, quantidade}

    function markDirty(id, payload){
      dirty.set(id, { ...(dirty.get(id)||{}), ...payload });
      ui.saveBtn.disabled = dirty.size===0;
    }

    /* Render de um card */
    function cardTemplate(id, data, config){
      const li = document.createElement('article');
      li.className = 'card';
      li.dataset.id = id;

      const nome = data.nome || 'Produto';
      const preco = Number(data.preco||0);
      const quantidade = Number(data.quantidade||0);
      const img = data.imagem ? imgURL(data.imagem) : `${ASSETS_HOST}/placeholder.webp`;

      li.innerHTML = `
        <div class="thumb"><img src="${img}" alt=""></div>
        <div class="meta">
          <div class="name">${nome}</div>
          <label class="field">Preço
            <input class="in-price" type="number" step="0.01" min="0" value="${preco.toFixed(2)}" ${config.readonly?'disabled':''}>
          </label>
          <button class="wa" title="WhatsApp">
            <svg viewBox="0 0 32 32"><path d="M19.11 17.32c-.27-.14-1.59-.79-1.84-.88-.25-.09-.43-.14-.62.14-.18.27-.71.88-.87 1.06-.16.18-.32.2-.59.07-.27-.14-1.15-.42-2.19-1.34-.81-.72-1.36-1.6-1.52-1.87-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.62-1.49-.85-2.04-.22-.53-.44-.46-.62-.47-.16-.01-.34-.01-.52-.01s-.48.07-.73.34c-.25.27-.96.94-.96 2.29s.99 2.66 1.13 2.84c.14.18 1.94 2.96 4.7 4.15.66.29 1.18.46 1.58.59.66.21 1.26.18 1.73.11.53-.08 1.59-.65 1.82-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32zM16 3C8.83 3 3 8.83 3 16c0 2.29.6 4.44 1.66 6.32L3 29l6.85-1.79C11.8 28.38 13.83 29 16 29c7.17 0 13-5.83 13-13S23.17 3 16 3z"/></svg>
          </button>
          <label class="field">Qtde
            <input class="in-qty" type="number" step="1" min="0" value="${quantidade}" ${config.readonly?'disabled':''}>
          </label>
        </div>
      `;

      // interação
      const inPrice = li.querySelector('.in-price');
      const inQty   = li.querySelector('.in-qty');
      const waBtn   = li.querySelector('.wa');

      waBtn.addEventListener('click', () => {
        const n  = nome;
        const p  = Number(inPrice.value||0);
        const q  = Number(inQty.value||1);
        const msg = encodeURIComponent( waMessage(n, p, q) );
        const phone = phoneDigits(config.whats||'55');
        const url = `https://wa.me/${phone}?text=${msg}`;
        window.open(url, '_blank');
      });

      if(!config.readonly){
        inPrice.addEventListener('input', () => markDirty(id, {preco: Number(inPrice.value||0)}));
        inQty  .addEventListener('input', () => markDirty(id, {quantidade: Number(inQty.value||0)}));
      }

      return li;
    }

    /* Carrega config do catálogo (logo, banner, título, whats) */
    async function loadConfig(){
      const ref = doc(db, "catalogos", slug, "meta", "config");
      const snap = await getDoc(ref);
      const cfg  = snap.exists() ? snap.data() : {};
      // título / subtítulo
      ui.title.textContent = cfg.titulo || "Catálogo do Cliente";
      ui.subtitle.textContent = cfg.subtitulo || "Escolha um item e chame no WhatsApp";
      // logo
      ui.logoImg.src = cfg.logo ? imgURL(cfg.logo) : `${ASSETS_HOST}/logo-placeholder.png`;
      // banner como background opcional
      if(cfg.banner){
        ui.banner.style.background = `center/cover no-repeat url('${imgURL(cfg.banner)}')`;
      }
      return cfg;
    }

    /* Lista itens e renderiza */
    async function boot(){
      const cfg = await loadConfig();

      // quem está logado?
      let canEdit = false;
      let ownerUid = null;

      // meta/owner
      const metaOwnerRef = doc(db, "catalogos", slug, "meta", "owner");
      const ownerSnap = await getDoc(metaOwnerRef);
      if(ownerSnap.exists()) ownerUid = ownerSnap.data().uid || null;

      onAuthStateChanged(auth, (user) => {
        canEdit = !!(user && editRequested && ownerUid && user.uid===ownerUid);
        ui.editBar.hidden = !canEdit;
      });

      // itens
      const itRef = collection(db, "catalogos", slug, "itens");
      const qRef  = query(itRef, orderBy("ordem","asc"));
      const snap  = await getDocs(qRef);

      ui.grid.innerHTML = "";
      snap.forEach(docu => {
        const el = cardTemplate(docu.id, docu.data(), {
          readonly: !editRequested, // edição de inputs (controle fino via canEdit no salvar)
          whats: cfg.whats
        });
        ui.grid.appendChild(el);
      });

      ui.saveBtn.addEventListener('click', async () => {
        if(!canEdit){ alert("Você não tem permissão para salvar este catálogo."); return; }
        ui.saveBtn.disabled = true;
        try{
          const ops = [];
          for(const [id, payload] of dirty.entries()){
            const ref = doc(db, "catalogos", slug, "itens", id);
            ops.push( updateDoc(ref, payload) );
          }
          await Promise.all(ops);
          dirty.clear();
          alert("Catálogo atualizado com sucesso!");
        }catch(e){
          console.error(e);
          alert("Erro ao salvar. Tente novamente.");
        }finally{
          ui.saveBtn.disabled = dirty.size===0;
        }
      });
    }

    boot();
  </script>
</body>
</html>
