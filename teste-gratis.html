<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minha Conta – MostreAki</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root {
      --bg: #aabcbb;
      --header-footer: #cde0e0;
      --bordo: #7d2f59;
      --texto: #003735;
      --grad1: #d9d9d9;
      --grad2: #af91a1;
      --card: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #cfe0e0, #92a9a6);
      font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== Header padrão MostreAki ===== */
    header {
      background: var(--header-footer);
      border-bottom: 3px solid var(--bordo);
      padding: .4rem .9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    header img {
      height: 55px;
      max-width: 190px;
      object-fit: contain;
      display: block;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: .75rem;
    }

    .header-auth-label {
      font-size: .85rem;
      color: var(--texto);
      cursor: pointer;
      display: none; /* será mostrado quando logado */
    }

    .user-circle {
      background: var(--bordo);
      color: #fff;
      font-weight: 600;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      display: none; /* será mostrado quando logado */
      align-items: center;
      justify-content: center;
      background-size: cover;
      background-position: center;
      font-size: .9rem;
      cursor: pointer;
      flex: 0 0 34px;
    }

    .hamburger {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid var(--bordo);
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      padding: 0;
    }

    .hamburger span {
      display: block;
      width: 60%;
      height: 3px;
      border-radius: 999px;
      background: var(--bordo);
    }

    /* ===== Menu lateral (overlay + painel) ===== */
    .menu-overlay {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .15);
      display: none;
      justify-content: flex-end;
      z-index: 999;
    }
    .menu-overlay.show {
      display: flex;
    }

    .menu-panel {
      width: 280px;
      max-width: 90vw;
      background: #92a9a6;
      box-shadow: -4px 0 12px rgba(0, 0, 0, .09);
      height: 100%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: .55rem;
    }

    .menu-link {
      width: 210px;
      max-width: 92vw;
      align-self: center;
      white-space: nowrap;
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      border-radius: 999px;
      padding: .55rem 1rem;
      text-align: center;
      color: var(--bordo);
      text-decoration: none;
      font-weight: 600;
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      font-size: .95rem;
    }
    .menu-link:hover {
      filter: brightness(1.03);
      transform: translateY(-1px);
    }

    /* ===== Main ===== */
    main {
      flex: 1;
      max-width: min(1100px, 94vw);
      margin: 2rem auto 2.6rem;
    }

    .page-title {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: .25rem;
      color: var(--texto);
    }
    .page-sub {
      font-size: .95rem;
      color: #214b4a;
      margin-bottom: 1.8rem;
    }

    .conta-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 1.6rem;
    }

    @media (max-width: 768px) {
      .conta-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.16);
      padding: 1.4rem 1.6rem 1.6rem;
      border: 2px solid rgba(125,47,89,0.25);
    }
    .card h2 {
      font-size: 1.1rem;
      margin: 0 0 .4rem;
      color: var(--texto);
    }
    .card p.desc {
      font-size: .9rem;
      color: #345;
      margin: 0 0 1.2rem;
    }

    .field-group {
      margin-bottom: 1rem;
    }
    .field-group label {
      display: flex;
      align-items: center;
      gap: .4rem;
      font-size: .9rem;
      margin-bottom: .25rem;
      color: #234;
    }
    .lock-icon {
      font-size: .95rem;
      color: var(--bordo);
    }
    .field-group input[type="text"],
    .field-group input[type="email"] {
      width: 100%;
      padding: .55rem .75rem;
      border-radius: 10px;
      border: 1px solid #c3c9cf;
      font-size: .9rem;
      outline: none;
      background: #f7f8fa;
    }
    .field-group input[disabled] {
      color: #667;
      cursor: not-allowed;
    }
    .hint {
      font-size: .8rem;
      color: #566;
      margin-top: .15rem;
    }

    .avatar-wrap {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: .8rem;
    }
    .avatar-preview {
      width: 90px;
      height: 90px;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background: linear-gradient(135deg,#d9d9d9,#af91a1);
      border: 3px solid var(--bordo);
      background-position: center;
      background-size: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 1.3rem;
      flex: 0 0 90px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .4rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: .9rem;
      font-weight: 600;
      padding: .55rem 1.2rem;
      text-decoration: none;
      transition: .18s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      border: 2px solid rgba(125,47,89,0.4);
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }
    .btn-primary:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
    }
    .btn-ghost {
      background: transparent;
      color: var(--bordo);
      border: 1px dashed rgba(125,47,89,0.6);
    }
    .btn-ghost:hover {
      background: rgba(255,255,255,.4);
    }
    .btn-danger {
      background: #fae0e6;
      color: #9a1536;
      border: 2px solid #e38ba3;
    }
    .btn-danger:hover {
      filter: brightness(1.02);
      transform: translateY(-1px);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: .6rem;
      margin-top: .6rem;
    }

    .section-title {
      font-size: .95rem;
      font-weight: 700;
      margin: 1rem 0 .4rem;
      color: #20373a;
    }
    .section-note {
      font-size: .8rem;
      color: #445;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      font-size: .8rem;
      padding: .25rem .55rem;
      border-radius: 999px;
      background: #e8d7e1;
      color: var(--bordo);
      margin-bottom: .4rem;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #47b572;
    }
    .dot.off {
      background: #e03a58;
    }

    /* ===== Alert brand ===== */
    .alert-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    .alert-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      max-width: 460px;
      width: 100%;
      box-shadow: 0 22px 70px rgba(0,0,0,.25);
      border: 2px solid #cde0e0;
    }
    .alert-head {
      background: linear-gradient(90deg,#cde0e0,#af91a1);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .alert-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #FA1E39;
    }
    .alert-title {
      color: #003735;
      font-weight: 700;
      font-size: .98rem;
    }
    .alert-body {
      padding: 16px;
      color: #223;
      font-size: .9rem;
    }
    .alert-actions {
      padding: 10px 16px 14px;
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
      background: #f7faf9;
    }

    footer {
      background: var(--header-footer);
      padding: 1rem;
      font-size: .85rem;
      text-align: center;
      color: #444;
      margin-top: auto;
      border-top: 3px solid var(--bordo);
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" aria-label="Voltar para a página inicial">
      <img src="logo-mostreaki.svg" alt="MostreAki">
    </a>

    <div class="header-right">
      <div id="authText" class="header-auth-label" title="Clique para sair">
        Sair
      </div>
      <div id="userCircle" class="user-circle" title="Minha conta"></div>

      <button class="hamburger" type="button" onclick="toggleMenu()" aria-label="Abrir menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <!-- Menu lateral -->
  <nav id="menu" class="menu-overlay" aria-label="Menu principal">
    <div class="menu-panel">
      <a class="menu-link" href="index.html">Início</a>
      <a class="menu-link" href="planos.html">Planos</a>
      <a class="menu-link" href="parceiros.html">Templates de Parceiros</a>
      <a class="menu-link" href="servicos-adicionais.html">Serviços Adicionais</a>
      <a class="menu-link" href="instrucoes.html">Instruções</a>
      <a class="menu-link" href="sobre.html">Sobre o MostreAki</a>
      <a class="menu-link" href="contato.html">Contato</a>
    </div>
  </nav>

  <!-- ALERTA -->
  <div id="alert" class="alert-bg" role="alertdialog" aria-modal="true">
    <div class="alert-card">
      <div class="alert-head">
        <div class="alert-dot"></div>
        <div id="alertTitle" class="alert-title">Aviso</div>
      </div>
      <div id="alertMsg" class="alert-body">Mensagem.</div>
      <div id="alertActions" class="alert-actions">
        <!-- botões via JS -->
      </div>
    </div>
  </div>

  <main>
    <h1 class="page-title">Minha Conta</h1>
    <p class="page-sub">
      Aqui você gerencia seus dados, assinatura e acessos ao catálogo e álbum da sua marca.
    </p>

    <section class="conta-grid">
      <!-- Dados principais -->
      <article class="card">
        <h2>Dados do titular</h2>
        <p class="desc">Informações básicas vinculadas à sua conta MostreAki.</p>

        <div class="avatar-wrap">
          <div id="avatarPreview" class="avatar-preview">M</div>

          <div>
            <button class="btn btn-primary" type="button" id="btnEscolherFoto">
              Escolher imagem
            </button>
            <input type="file" id="fileFoto" accept="image/*" style="display:none" />
            <div class="hint">
              A foto será usada no círculo de usuário. Tamanho máximo: <b>400 KB</b>.
            </div>
          </div>
        </div>

        <div class="field-group">
          <label for="slug">
            Nome de usuário (slug)
            <span class="lock-icon" title="Campo bloqueado">&#128274;</span>
          </label>
          <input type="text" id="slug" disabled value="carregando..." />
          <div class="hint">
            Para alterar o seu slug, envie uma solicitação para
            <b>mostreaki@mostreaki.com.br</b>. Essa alteração afeta os links públicos do seu site.
          </div>
        </div>

        <div class="field-group">
          <label for="emailConta">E-mail de acesso</label>
          <input type="email" id="emailConta" disabled value="carregando..." />
          <div class="btn-row">
            <button class="btn btn-primary" type="button" id="btnAlterarEmail">
              Alterar e-mail
            </button>
          </div>
          <div class="hint">
            O e-mail é usado para login e comunicações importantes do MostreAki.
          </div>
        </div>
      </article>

      <!-- Assinatura + recursos -->
      <article class="card">
        <h2>Assinatura & recursos</h2>
        <p class="desc">Gerencie sua assinatura e os acessos ao catálogo e álbum digital.</p>

        <!-- Status assinatura -->
        <div class="section-title">Status da assinatura</div>
        <div id="statusAssinatura" class="status-pill">
          <span class="dot" id="dotAssinatura"></span>
          <span id="textoAssinatura">Carregando assinatura...</span>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" type="button" id="btnAlterarPlano">
            Alterar assinatura
          </button>
          <button class="btn btn-danger" type="button" id="btnCancelarPlano">
            Cancelar assinatura
          </button>
        </div>
        <div class="section-note" id="notaLimitesPlano">
          <!-- Atualizado via JS com limites do plano -->
        </div>

        <!-- Catálogo -->
        <div class="section-title" style="margin-top:1.4rem;">Catálogo digital</div>
        <div id="statusCatalogo" class="status-pill">
          <span class="dot off" id="dotCatalogo"></span>
          <span id="textoCatalogo">Verificando acesso ao catálogo...</span>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" id="btnEditarCatalogo" style="display:none;">
            Editar catálogo
          </button>
        </div>
        <div class="section-note">
          O botão "Editar catálogo" só aparece se sua assinatura estiver com o catálogo ativo no Firestore.
        </div>

        <!-- Álbum -->
        <div class="section-title" style="margin-top:1.4rem;">Álbum / Galeria</div>
        <div id="statusAlbum" class="status-pill">
          <span class="dot off" id="dotAlbum"></span>
          <span id="textoAlbum">Verificando acesso ao álbum...</span>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" id="btnEditarAlbum" style="display:none;">
            Editar álbum
          </button>
        </div>
        <div class="section-note">
          Assim como o catálogo, o acesso ao álbum depende da configuração da sua assinatura no Firestore.
        </div>
      </article>
    </section>
  </main>

  <footer>
    MostreAki &copy; 2025 — Fortalecendo a identidade da sua marca no universo digital.
  </footer>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      doc,
      getDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    const app = initializeApp({
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ===== helpers UI ===== */
    const $ = (id) => document.getElementById(id);

    const menu = $("menu");
    window.toggleMenu = function () {
      if (!menu) return;
      menu.classList.toggle("show");
    };

    // fechar menu ao clicar fora do painel
    if (menu) {
      menu.addEventListener("click", (e) => {
        if (e.target === menu) {
          menu.classList.remove("show");
        }
      });
    }

    const alertBG = $("alert");
    const alertTitle = $("alertTitle");
    const alertMsg = $("alertMsg");
    const alertActions = $("alertActions");

    function showAlert({ title = "Aviso", html = "", actions = [{ text: "Fechar" }] }) {
      alertTitle.textContent = title;
      alertMsg.innerHTML = html;
      alertActions.innerHTML = "";
      actions.forEach(a => {
        const btn = document.createElement("button");
        btn.className = "btn " + (a.kind === "danger" ? "btn-danger" : "btn-primary");
        btn.textContent = a.text;
        btn.onclick = () => {
          if (a.onClick) a.onClick();
          closeAlert();
        };
        alertActions.appendChild(btn);
      });
      alertBG.style.display = "flex";
    }
    function closeAlert() {
      alertBG.style.display = "none";
    }
    alertBG.addEventListener("click", (e) => {
      if (e.target === alertBG) closeAlert();
    });

    const userCircle = $("userCircle");
    const authText = $("authText");
    const avatarPreview = $("avatarPreview");
    const fileFoto = $("fileFoto");
    const btnEscolherFoto = $("btnEscolherFoto");

    const slugInput = $("slug");
    const emailConta = $("emailConta");

    const dotAssinatura = $("dotAssinatura");
    const textoAssinatura = $("textoAssinatura");
    const dotCatalogo = $("dotCatalogo");
    const textoCatalogo = $("textoCatalogo");
    const dotAlbum = $("dotAlbum");
    const textoAlbum = $("textoAlbum");
    const btnEditarCatalogo = $("btnEditarCatalogo");
    const btnEditarAlbum = $("btnEditarAlbum");

    const btnAlterarEmail = $("btnAlterarEmail");
    const btnAlterarPlano = $("btnAlterarPlano");
    const btnCancelarPlano = $("btnCancelarPlano");
    const notaLimitesPlano = $("notaLimitesPlano");

    const LIMITES_PLANO = {
      basico: { label: "Básico", limite: 100 },
      intermediario: { label: "Intermediário", limite: 250 },
      avancado: { label: "Avançado", limite: 500 }
    };

    let planoAtualChave = null;

    /* ===== estado de auth ===== */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Não logado: volta para a página inicial
        window.location.href = "index.html";
        return;
      }

      // Preenche e-mail
      emailConta.value = user.email || "";

      // Mostra user-circle e label "Sair"
      if (userCircle) {
        const letra = (user.displayName || user.email || "?").trim().charAt(0).toUpperCase();
        userCircle.textContent = letra;
        userCircle.style.display = "flex";

        // Se já tiver fotoPerfil no localStorage, usa
        const savedFoto = localStorage.getItem("fotoPerfil");
        if (savedFoto) {
          userCircle.style.backgroundImage = `url('${savedFoto}')`;
          avatarPreview.style.backgroundImage = `url('${savedFoto}')`;
          avatarPreview.textContent = "";
        }
      }
      if (authText) {
        authText.style.display = "inline";
      }

      let slug = null;

      try {
        // 1) Lê documento do usuário
        const docRefUsuario = doc(db, "usuarios", user.uid);
        const snapUsuario = await getDoc(docRefUsuario);

        if (snapUsuario.exists()) {
          const data = snapUsuario.data();

          // slug
          if (data.slug) {
            slug = data.slug;
            slugInput.value = data.slug;
          } else {
            slugInput.value = "(definir slug no Firestore)";
          }

          // foto de perfil do Firestore (se existir e ainda não tiver no localStorage)
          if (data.fotoPerfilURL && !localStorage.getItem("fotoPerfil")) {
            localStorage.setItem("fotoPerfil", data.fotoPerfilURL);
            userCircle.style.backgroundImage = `url('${data.fotoPerfilURL}')`;
            avatarPreview.style.backgroundImage = `url('${data.fotoPerfilURL}')`;
            avatarPreview.textContent = "";
          }
        } else {
          slugInput.value = "(usuário sem documento em /usuarios ainda)";
        }

        // 2) Se não tiver slug, não conseguimos seguir com assinatura/catalogo
        if (!slug) {
          dotAssinatura.classList.add("off");
          textoAssinatura.textContent = "Sem assinatura ativa (slug não definido).";
          dotCatalogo.classList.add("off");
          textoCatalogo.textContent = "Catálogo ainda não habilitado (slug não definido).";
          dotAlbum.classList.add("off");
          textoAlbum.textContent = "Álbum ainda não habilitado (slug não definido).";
          return;
        }

        // 3) Lê assinatura em /assinaturas/{slug}
        try {
          const docRefAss = doc(db, "assinaturas", slug);
          const snapAss = await getDoc(docRefAss);

          if (snapAss.exists()) {
            const a = snapAss.data();
            const status = (a.status || "").toLowerCase();
            const plano = (a.plano || a.planos || "").toLowerCase();
            planoAtualChave = plano;

            const infoPlano = LIMITES_PLANO[plano];

            if (status === "ativo") {
              dotAssinatura.classList.remove("off");
              if (infoPlano) {
                textoAssinatura.textContent = `Assinatura ativa – Plano ${infoPlano.label}`;
                notaLimitesPlano.textContent =
                  `Seu plano atual permite até ${infoPlano.limite} produtos no catálogo e até ${infoPlano.limite} itens no álbum.`;
              } else {
                textoAssinatura.textContent = "Assinatura ativa.";
                notaLimitesPlano.textContent =
                  "Seu plano está ativo. Os limites do catálogo e álbum serão configurados de acordo com o plano contratado.";
              }
            } else if (status === "suspenso" || status === "suspensa") {
              dotAssinatura.classList.add("off");
              textoAssinatura.textContent = "Assinatura suspensa.";
              notaLimitesPlano.textContent =
                "Regularize sua assinatura com o intermediador de pagamento para reativar o catálogo e o álbum.";
            } else {
              dotAssinatura.classList.add("off");
              textoAssinatura.textContent = "Sem assinatura ativa.";
              notaLimitesPlano.textContent =
                "Contrate um plano MostreAki para habilitar catálogo digital e álbum da sua marca.";
            }
          } else {
            // não há doc em /assinaturas
            dotAssinatura.classList.add("off");
            textoAssinatura.textContent = "Sem assinatura ativa.";
            notaLimitesPlano.textContent =
              "Contrate um plano MostreAki para habilitar catálogo digital e álbum da sua marca.";
          }
        } catch (errAss) {
          console.error("Erro ao ler assinatura:", errAss);
          dotAssinatura.classList.add("off");
          textoAssinatura.textContent = "Não foi possível carregar os dados da assinatura.";
          notaLimitesPlano.textContent =
            "Tente recarregar a página. Se o problema persistir, fale com o suporte.";
        }

        // 4) Lê config de catálogo/álbum em /catalogos/{slug}/meta/config
        try {
          const docRefCfg = doc(db, "catalogos", slug, "meta", "config");
          const snapCfg = await getDoc(docRefCfg);

          let catAtivo = false;
          let albAtivo = false;

          if (snapCfg.exists()) {
            const cfg = snapCfg.data();
            catAtivo = !!cfg.catalogoAtivo;
            albAtivo = !!cfg.albumAtivo;
          }

          // Atualiza catálogo
          if (catAtivo) {
            dotCatalogo.classList.remove("off");
            if (planoAtualChave && LIMITES_PLANO[planoAtualChave]) {
              const lim = LIMITES_PLANO[planoAtualChave].limite;
              textoCatalogo.textContent = `Catálogo digital ativo – limite de até ${lim} produtos.`;
            } else {
              textoCatalogo.textContent = "Catálogo digital ativo.";
            }
            btnEditarCatalogo.style.display = "inline-flex";
          } else {
            dotCatalogo.classList.add("off");
            textoCatalogo.textContent = "Catálogo ainda não habilitado.";
            btnEditarCatalogo.style.display = "none";
          }

          // Atualiza álbum
          if (albAtivo) {
            dotAlbum.classList.remove("off");
            if (planoAtualChave && LIMITES_PLANO[planoAtualChave]) {
              const lim = LIMITES_PLANO[planoAtualChave].limite;
              textoAlbum.textContent = `Álbum / galeria ativo – limite de até ${lim} itens.`;
            } else {
              textoAlbum.textContent = "Álbum / galeria ativo.";
            }
            btnEditarAlbum.style.display = "inline-flex";
          } else {
            dotAlbum.classList.add("off");
            textoAlbum.textContent = "Álbum ainda não habilitado.";
            btnEditarAlbum.style.display = "none";
          }

        } catch (errCfg) {
          console.error("Erro ao ler config de catálogo/álbum:", errCfg);
          dotCatalogo.classList.add("off");
          textoCatalogo.textContent = "Não foi possível carregar o status do catálogo.";
          dotAlbum.classList.add("off");
          textoAlbum.textContent = "Não foi possível carregar o status do álbum.";
        }

      } catch (e) {
        console.error("Erro ao ler Firestore (bloco geral):", e);
        dotAssinatura.classList.add("off");
        textoAssinatura.textContent = "Não foi possível carregar os dados. Tente novamente.";
        notaLimitesPlano.textContent =
          "Se o erro continuar, entre em contato com o suporte MostreAki.";
      }
    });

    // Sair
    if (authText) {
      authText.addEventListener("click", async () => {
        try {
          await signOut(auth);
          localStorage.removeItem("fotoPerfil");
          window.location.href = "index.html";
        } catch (e) {
          showAlert({
            title: "Erro ao sair",
            html: "Não foi possível encerrar a sessão. Tente novamente."
          });
        }
      });
    }

    // Avatar: escolher arquivo
    if (btnEscolherFoto && fileFoto) {
      btnEscolherFoto.addEventListener("click", () => fileFoto.click());

      fileFoto.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 400 * 1024) {
          showAlert({
            title: "Imagem muito pesada",
            html: "Por favor, escolha uma imagem com até <b>400 KB</b> para o avatar."
          });
          fileFoto.value = "";
          return;
        }

        const user = auth.currentUser;
        if (!user) {
          showAlert({
            title: "Sessão expirada",
            html: "Faça login novamente para alterar sua foto de perfil.",
            actions: [{ text: "Ok" }]
          });
          return;
        }

        try {
          const storageRef = ref(storage, `avatars/${user.uid}.jpg`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);

          localStorage.setItem("fotoPerfil", url);
          userCircle.style.backgroundImage = `url('${url}')`;
          avatarPreview.style.backgroundImage = `url('${url}')`;
          avatarPreview.textContent = "";
          showAlert({
            title: "Foto atualizada",
            html: "Sua foto de perfil foi atualizada com sucesso!"
          });
        } catch (err) {
          console.error(err);
          showAlert({
            title: "Erro ao enviar imagem",
            html: "Não foi possível atualizar sua foto agora. Tente novamente em instantes."
          });
        }
      });
    }

    // Botão alterar e-mail
    if (btnAlterarEmail) {
      btnAlterarEmail.addEventListener("click", () => {
        window.location.href = "alterar-email.html";
      });
    }

    // Botão alterar assinatura
    if (btnAlterarPlano) {
      btnAlterarPlano.addEventListener("click", () => {
        window.location.href = "planos.html#trocar";
      });
    }

    // Botão cancelar assinatura
    if (btnCancelarPlano) {
      btnCancelarPlano.addEventListener("click", () => {
        showAlert({
          title: "Cancelar assinatura",
          html: "O cancelamento é feito pelo intermediador de pagamento (ex: Mercado Pago).<br>Entre em contato pelo WhatsApp ou e-mail <b>mostreaki@mostreaki.com.br</b> para orientações detalhadas.",
          actions: [{ text: "Entendi" }]
        });
      });
    }

    // Editar catálogo
    if (btnEditarCatalogo) {
      btnEditarCatalogo.addEventListener("click", () => {
        window.location.href = "editar-catalogo.html";
      });
    }

    // Editar álbum
    if (btnEditarAlbum) {
      btnEditarAlbum.addEventListener("click", () => {
        window.location.href = "editar-album.html";
      });
    }
  </script>
</body>
</html>
