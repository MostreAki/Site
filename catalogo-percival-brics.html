<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Catálogo – MostreAki</title>
  <style>
    :root{
      --brand:#16b0af; --ink:#083f3e; --bg:#f6fbfa; --line:#e7f3f1;
      --muted:#5b6b6a; --ok:#0a7; --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:#cceee6;display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid #bfe3da}
    header .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    header .logo img{height:40px}
    main{max-width:1100px;margin:22px auto;padding:0 16px}
    .sub{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;background:#e9fbf8;border:1px solid #cfeee9;color:#0b4d4c;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
    .media{position:relative;background:#f2fbf8}
    .media img{width:100%;height:220px;object-fit:cover;display:block}
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:8px;background:#f7fcfb;border-top:1px solid var(--line)}
    .thumbs img{width:100%;height:68px;object-fit:cover;border:1px solid #e3f2ef;border-radius:8px;cursor:pointer}
    .body{padding:12px}
    .title{margin:0 0 6px;font-weight:800}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:.95rem}
    .price{font-weight:900;color:#0b4d4c}
    .qty{font-weight:700}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{--bg:#0f766e;--fg:#fff;--bd:transparent;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:var(--bg);color:var(--fg);font-weight:800;text-decoration:none}
    .btn--ghost{--bg:#fff;--fg:#0f766e;--bd:rgba(15,118,110,.35)}
    .banner{margin:12px 0; border-radius:14px; overflow:hidden; border:1px solid var(--line)}
    .banner img{width:100%; display:block; max-height:280px; object-fit:cover}
    /* Lightbox simples */
    .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:50}
    .lightbox img{max-width:94vw;max-height:90vh;display:block;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .lightbox.on{display:flex}
    footer{color:#567;font-size:.9rem;text-align:center;padding:24px 16px}
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="/logomarca-mostreaki.svg" alt="Logo MostreAki"><b>MostreAki</b></div>
  </header>

  <main>
    <h2 id="catTitle">Catálogo</h2>
    <div class="sub">
      <span class="pill">Slug: <b id="slugLabel">—</b></span>
      <span id="status" class="pill" style="display:none"></span>
    </div>

    <div id="topBanner" class="banner" style="display:none">
      <img id="bannerImg" alt="Banner do catálogo">
    </div>

    <section id="grid" class="grid"></section>
  </main>

  <div id="lb" class="lightbox" aria-hidden="true">
    <img id="lbImg" alt="Visualização ampliada">
  </div>

  <footer>© <span id="ano"></span> MostreAki</footer>

  <!-- Firebase v10.14 (mesma config do editor) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ===== Config (igual ao editor) =====
    const cfg = {
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    };
    const app = getApps().length ? getApp() : initializeApp(cfg);
    const db  = getFirestore(app);

    const $ = s => document.querySelector(s);
    $('#ano').textContent = new Date().getFullYear();

    // ===== Utils =====
    function bust(url){ return url ? url + (url.includes('?')?'&':'?') + 't=' + Date.now() : url; }
    function fmtBRLcent(c){ return 'R$ ' + (c/100).toLocaleString('pt-BR',{minimumFractionDigits:2}); }
    function getSlug(){
      const u = new URL(location.href);
      const byQuery = u.searchParams.get('c') || u.searchParams.get('slug');
      if (byQuery) return byQuery;
      // Suporta /catalogo-<slug>.html
      const m = location.pathname.match(/catalogo-([a-z0-9-]+)\.html$/i);
      return m ? m[1] : '';
    }

    const slug = getSlug();
    $('#slugLabel').textContent = slug || '—';

    // ===== Lightbox simples =====
    const lb = $('#lb'), lbImg = $('#lbImg');
    function openLB(src){ lbImg.src = src; lb.classList.add('on'); lb.setAttribute('aria-hidden','false'); }
    function closeLB(){ lb.classList.remove('on'); lb.setAttribute('aria-hidden','true'); lbImg.src=''; }
    lb.addEventListener('click', closeLB);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeLB(); });

    // ===== Render =====
    function renderItem(id, d){
      const nome  = d.nome || d.titulo || `Item ${id}`;
      const qtd   = typeof d.quantidade==='number' ? d.quantidade : (d.qtde||0);
      const cents = typeof d.precoCentavos==='number' ? d.precoCentavos : (typeof d.preco==='number' ? Math.round(d.preco*100) : 0);
      const ml    = d.mlUrl || '';

      // Imagens por slot fixo (sem arrays)
      const i1 = d.urlImagem  || '';
      const i2 = d.urlImagem2 || '';
      const i3 = d.urlImagem3 || '';
      const gal = [i1,i2,i3].filter(Boolean);
      const thumb = gal[0] || '';

      const el = document.createElement('article');
      el.className = 'card';
      el.innerHTML = `
        <div class="media">
          ${thumb ? `<img class="hero" src="${bust(thumb)}" alt="${nome}">` : `<img class="hero" src="https://via.placeholder.com/800x480?text=Sem+imagem" alt="${nome}">`}
        </div>
        <div class="thumbs">
          ${[i1,i2,i3].map((u,ix)=> u ? `<img data-ix="${ix+1}" data-src="${bust(u)}" alt="Imagem ${ix+1} de ${nome}">` : `<span></span>`).join('')}
        </div>
        <div class="body">
          <h3 class="title">${nome}</h3>
          <div class="meta">
            <span class="price">${fmtBRLcent(cents)}</span>
            <span class="qty">Qtd: ${qtd}</span>
          </div>
          <div class="actions">
            ${ml ? `<a class="btn" href="${ml}" target="_blank" rel="noopener">Comprar no Mercado Livre</a>` : ``}
          </div>
        </div>
      `;

      // troca hero ao clicar em thumb
      el.querySelectorAll('.thumbs img').forEach(img=>{
        img.addEventListener('click', ()=>{
          const hero = el.querySelector('.hero');
          hero.src = img.getAttribute('data-src');
        });
        img.addEventListener('dblclick', ()=>{
          openLB(img.getAttribute('data-src'));
        });
      });
      // hero abre lightbox
      el.querySelector('.hero').addEventListener('click', e=>{
        const src = e.currentTarget.getAttribute('src');
        openLB(src);
      });

      return el;
    }

    async function load(){
      if(!slug){
        $('#status').style.display='inline-flex';
        $('#status').textContent = 'Informe ?c=<slug> ou use catalogo-<slug>.html';
        return;
      }

      // meta/config
      const m = await getDoc(doc(db,'catalogos',slug,'meta','config'));
      if (m.exists()){
        const meta = m.data();
        $('#catTitle').textContent = meta.titulo || meta.nome || `Catálogo – ${slug}`;
        // banner opcional
        const banner = meta.bannerUrl || meta.banner || '';
        if (banner){
          $('#bannerImg').src = bust(banner);
          $('#topBanner').style.display = 'block';
        }
        // se houver flag de ativo
        if (meta.catalogoAtivo === false){
          $('#status').style.display='inline-flex';
          $('#status').textContent = 'Catálogo inativo';
        }
      }

      // itens
      const snap = await getDocs(collection(db,'catalogos',slug,'itens'));
      const grid = $('#grid');
      grid.innerHTML = '';
      // mapeia por id numérico
      const items = [];
      snap.forEach(docu=>{
        const id = docu.id;
        const d  = docu.data();
        items.push({id, d});
      });
      // ordena por ordem -> id
      items.sort((a,b)=>{
        const ao = typeof a.d.ordem==='number'?a.d.ordem:parseInt(a.id,10);
        const bo = typeof b.d.ordem==='number'?b.d.ordem:parseInt(b.id,10);
        return (ao||0)-(bo||0);
      });
      // render
      if (!items.length){
        grid.innerHTML = `<div class="card" style="grid-column:1/-1"><div class="body"><b>Nenhum item encontrado.</b></div></div>`;
        return;
      }
      for (const it of items){
        grid.appendChild(renderItem(it.id, it.d));
      }
    }

    load().catch(err=>{
      console.error(err);
      const grid = $('#grid');
      grid.innerHTML = `<div class="card" style="grid-column:1/-1"><div class="body"><b>Erro ao carregar catálogo.</b> Verifique as regras do Firestore e o slug.</div></div>`;
    });
  </script>
</body>
</html>
