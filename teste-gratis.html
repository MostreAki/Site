<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Grátis – MostreAki</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}

    :root{
      --brand:#15b0af;
      --brandLight:#c2e7df;
      --accent:#FA1E39;
      --ink:#063b39;
      --card:#ffffff;
      --titleAccent:#c6f2e0;
    }

    body{
      background-image:url("fundo-mobile-escuro-mostreaki.png");
      background-size:cover;background-repeat:no-repeat;background-attachment:fixed;
      color:#222;
    }
    @media (min-width:768px){
      body{ background-image:url("fundo-desktop.png"); }
    }

    header{
      background:#c2e7df;height:60px;display:flex;align-items:center;justify-content:space-between;
      padding:0 20px;position:relative;box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .logo-container{display:flex;align-items:center;cursor:pointer}
    .logo-container img{height:40px;margin-right:10px}
    .logo{font-size:1.5rem;font-weight:bold}
    .logo .mostre{color:#00C2BF}.logo .aki{color:#FA1E39}

    .header-auth{display:flex;align-items:center;gap:10px}
    .user-circle{
      background:#15b0af;color:#fff;font-weight:bold;border-radius:50%;
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;
      overflow:hidden;font-size:.9rem;
    }
    .user-circle img{width:100%;height:100%;object-fit:cover;display:block}
    .menu-icon{
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;
      line-height:1;font-size:1.5rem;cursor:pointer
    }
    .menu-list{
      position:absolute;top:60px;right:20px;background:#16807C;border:2px solid #000;
      border-radius:6px;display:none;flex-direction:column;padding:10px;z-index:10000;
    }
    .menu-list a{
      background:#FA1E39;color:#fff;text-decoration:none;padding:10px;margin-bottom:8px;
      border-radius:6px;text-align:center;font-weight:bold;
    }
    .menu-list a:hover{background:#b8313b}

    h1{
      color:var(--titleAccent);font-size:1.9rem;text-align:center;margin:40px 20px;
      text-shadow:0 1px 0 rgba(0,0,0,.2), 0 2px 4px rgba(0,0,0,.25);
    }

    main{
      max-width:600px;margin:0 auto 40px;padding:20px;background:#fff;border-radius:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.1);
    }
    p.lead{
      color:#234;font-size:1.05rem;text-align:center;margin-bottom:20px;
    }
    button.primary{
      background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px;
      font-weight:bold;cursor:pointer;width:100%;font-size:1.05rem;margin-top:20px;
      transition:filter .15s ease, opacity .15s ease;
    }
    button.primary:hover{filter:brightness(.95)}
    button.primary[disabled]{opacity:.7;cursor:not-allowed}
    .note{
      margin:12px 0;padding:12px 14px;background:#f3fbfa;border-left:4px solid var(--brand);
      border-radius:10px;color:#234;font-size:.95rem;
    }
    .alerta-login{
      display:none;margin:14px auto;max-width:600px;background:#fffbe6;border:1px solid #ffe8a3;
      border-radius:12px;padding:10px 14px;color:#7a5600;text-align:center;
    }
    footer{
      background:#c2e7df;padding:20px;text-align:center;color:#555;font-size:.9rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container" onclick="location.href='index.html'">
      <img src="logomarca-mostreaki.svg" alt="Logo">
      <div class="logo"><span class="mostre">Mostre</span><span class="aki">Aki</span></div>
    </div>
    <div class="header-auth">
      <span id="authText" style="font-weight:bold;color:#15b0af;cursor:pointer;display:none">Entrar</span>
      <div id="userCircle" class="user-circle" title="Perfil">F</div>
      <div id="menuBtn" class="menu-icon" aria-controls="menu" aria-expanded="false">☰</div>
    </div>
    <nav class="menu-list" id="menu">
      <a href="/index.html">Página Inicial</a>
      <a href="/sobre.html">Sobre</a>
      <a href="/minha-conta.html">Minha Conta</a>
      <a href="/parceiros.html">Parceiros</a>
      <a href="/servicos-adicionais.html">Serviços Adicionais</a>
      <a href="/redes-sociais.html">Redes Sociais</a>
      <a href="/contatos.html">Contatos</a>
    </nav>
  </header>

  <div id="alertaLogin" class="alerta-login">⚠️ Você precisa estar logado para começar o Trial. Redirecionando…</div>

  <main>
    <p class="lead">Entraremos em contato para entender suas necessidades e criar um site personalizado que você vai amar!</p>
    <div class="note">
      <b>Nota:</b> Após confirmar seu interesse, nossa equipe entrará em contato para criar seu site sob medida, com 7 dias de teste grátis.
    </div>
    <button id="startTrialBtn" class="primary">Começar Teste Grátis</button>
  </main>

  <footer>&copy; 2025 MostreAki. Todos os direitos reservados.</footer>

  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    const cfg = {
      apiKey: 'AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE',
      authDomain: 'mostreaki-2025.firebaseapp.com',
      projectId: 'mostreaki-2025',
      storageBucket: 'mostreaki-2025.firebasestorage.app',
      messagingSenderId: '748712068097',
      appId: '1:748712068097:web:09cf043fbb45917ef6ec00'
    };
    const app = getApps().length ? getApp() : initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const stg = getStorage(app, 'gs://mostreaki-2025.firebasestorage.app');

    const $ = s => document.querySelector(s);
    const toast = (m) => {
      const t = document.createElement('div');
      t.textContent = m;
      t.style.position = 'fixed';
      t.style.top = '16px';
      t.style.right = '16px';
      t.style.background = '#FA1E39';
      t.style.color = '#fff';
      t.style.padding = '12px 14px';
      t.style.borderRadius = '10px';
      t.style.boxShadow = '0 6px 18px rgba(0,0,0,.2)';
      t.style.zIndex = '99999';
      t.style.fontWeight = 'bold';
      document.body.append(t);
      setTimeout(() => t.remove(), 2400);
    };

    /* Avatar */
    function setAvatar(url, nome = '') {
      const el = $('#userCircle'); if (!el) return;
      el.textContent = ''; el.style.display = 'flex';
      if (url) {
        localStorage.setItem('fotoPerfil', url);
        const img = new Image();
        img.src = url; img.alt = 'Foto de Perfil'; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
        el.append(img);
      } else {
        el.textContent = nome ? nome[0].toUpperCase() : 'F';
      }
    }
    async function prefetchFoto(uid) {
      try {
        const userDoc = await getDoc(doc(db, 'usuarios', uid));
        const nome = userDoc.exists() ? userDoc.data().nomeCompleto || '' : '';
        const tryExt = e => getDownloadURL(ref(stg, `usuarios/${uid}/perfil/avatar.${e}`)).catch(() => null);
        const direct = await tryExt('jpg') || await tryExt('png') || await tryExt('webp') || await tryExt('gif');
        if (direct) {
          setAvatar(direct, nome);
        } else {
          setAvatar('', nome);
        }
      } catch (e) {
        console.log('Erro ao carregar foto:', e.message);
        const userDoc = await getDoc(doc(db, 'usuarios', uid));
        const nome = userDoc.exists() ? userDoc.data().nomeCompleto || '' : '';
        setAvatar('', nome);
      }
    }
    (() => { const c = localStorage.getItem('fotoPerfil'); if (c) setAvatar(c); })();

    /* Auth header */
    (function wireAuthUI() {
      const at = $('#authText');
      onAuthStateChanged(auth, async user => {
        if (user) {
          if (at) {
            at.textContent = 'Sair';
            at.style.display = 'inline';
            at.onclick = async () => {
              await auth.signOut();
              localStorage.removeItem('fotoPerfil');
              location = '/index.html';
            };
          }
          await prefetchFoto(user.uid);
        } else {
          if (at) {
            at.textContent = 'Entrar';
            at.style.display = 'inline';
            at.onclick = () => location.href = '/login.html';
          }
          $('#userCircle').textContent = 'F';
          $('#userCircle').style.display = 'flex';
          $('#alertaLogin').style.display = 'block';
          $('#startTrialBtn').style.display = 'none';
          setTimeout(() => location.href = '/login.html', 4000);
        }
      });
    })();

    /* Menu */
    (function wireMenu() {
      const btn = $('#menuBtn');
      const menu = $('#menu');
      if (!btn || !menu) return;
      const open = () => {
        menu.style.display = 'flex';
        btn.setAttribute('aria-expanded', 'true');
        document.addEventListener('click', onDoc, true);
        document.addEventListener('keydown', onKey);
      };
      const close = () => {
        menu.style.display = 'none';
        btn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', onDoc, true);
        document.removeEventListener('keydown', onKey);
      };
      const toggle = () => menu.style.display === 'flex' ? close() : open();
      function onDoc(e) {
        if (!menu.contains(e.target) && e.target !== btn) close();
      }
      function onKey(e) {
        if (e.key === 'Escape') close();
      }
      btn.addEventListener('click', e => {
        e.stopPropagation();
        toggle();
      });
    })();

    /* === Trial: grava no Firestore (coleção "mail") e redireciona ===
       Requer a extensão Firebase "Trigger Email" instalada e configurada. */
    async function notifyTrialInterest(user) {
      const btn = $('#startTrialBtn');
      try {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Enviando...';

        // Puxa nome do Firestore (fallback pro local-part do email)
        const userDoc = await getDoc(doc(db, 'usuarios', user.uid));
        const nome = userDoc.exists()
          ? (userDoc.data().nomeCompleto || (user.email ? user.email.split('@')[0] : 'Usuário'))
          : (user.email ? user.email.split('@')[0] : 'Usuário');

        // Cria o documento na coleção "mail" monitorada pela extensão Trigger Email
        await addDoc(collection(db, 'mail'), {
          to: ['contato.mostreaki@gmail.com'],  // <- troque se necessário
          message: {
            subject: 'Novo interesse no plano trial - MostreAki',
            text:
`Um usuário demonstrou interesse no Trial.

UID: ${user.uid}
Nome: ${nome}
Email: ${user.email || '(sem email)'}
Foto: ${user.photoURL || '(sem foto)'}
Quando: ${new Date().toISOString()}

Acesse o Firestore para mais detalhes.`
            // Você pode adicionar "html" se quiser email formatado:
            // html: `<p><b>UID:</b> ${user.uid}</p> ...`
          },
          createdAt: serverTimestamp(),
          usuario: {
            uid: user.uid,
            nome,
            email: user.email || null,
            photoURL: user.photoURL || null
          },
          origem: 'teste-gratis.html'
        });

        // Feedback e redirecionamento
        toast('Interesse registrado! Já vamos entrar em contato.');
        setTimeout(() => location.href = '/obrigado.html', 400);
      } catch (e) {
        console.error('Erro ao registrar interesse:', e);
        toast('Não foi possível registrar seu interesse agora. Tente novamente.');
        // Reabilita botão pra nova tentativa
        const btn = $('#startTrialBtn');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Começar Teste Grátis';
        }
      }
    }

    $('#startTrialBtn').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user) {
        await notifyTrialInterest(user);
      } else {
        toast('Você precisa estar logado para começar o Trial.');
        setTimeout(() => location.href = '/login.html', 2000);
      }
    });
  </script>
</body>
</html>
