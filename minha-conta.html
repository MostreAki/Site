<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Minha Conta – MostreAki</title>
  <style>
    :root{
      --brand:#16b0af; --brandLight:#c4e8de; --ink:#083f3e; --bg:#f6fbfa; --danger:#d73e45;
    }
    *{box-sizing:border-box}
    body{margin:0;background:url(/bg-circuit.svg) center/cover fixed, var(--bg);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;z-index:1000;background:#cceee6;display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid #bfe3da}
    header .logo{display:flex;align-items:center;gap:10px;font-weight:800;color:#0b3e3c}
    .user-wrap{margin-left:auto;display:flex;align-items:center;gap:10px}
    .user-circle{width:56px;height:56px;border-radius:50%;overflow:hidden;display:none;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .menu-icon{width:36px;height:26px;position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .menu-icon span{position:absolute;width:24px;height:3px;background:#1b1b1b;border-radius:3px}
    .menu-icon span:nth-child(1){top:2px}
    .menu-icon span:nth-child(2){top:11px}
    .menu-icon span:nth-child(3){bottom:2px}
    nav#menu{display:none;position:absolute;right:12px;top:64px;background:#fff;border:1px solid #e8f2ef;border-radius:12px;
             box-shadow:0 18px 50px rgba(0,0,0,.12);padding:10px 12px;gap:8px;flex-direction:column}
    nav#menu a{padding:10px 12px;border-radius:8px;color:#0b3e3c;text-decoration:none}
    nav#menu a:hover{background:#eef8f5}

    main.container{max-width:980px;margin:22px auto;padding:0 16px}
    h2{color:#0b3e3c;margin:12px 0 18px;font-size:1.8rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:#fff;border:1px solid #e7f3f1;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .card .head{padding:14px 16px;border-bottom:1px solid #e7f3f1;font-weight:700;color:#0b3e3c}
    .card .body{padding:16px}
    label{display:block;margin:10px 0 6px;color:#124b49;font-weight:600}
    input[type="text"],input[type="file"]{width:100%;padding:10px 12px;border:1px solid #cfe9e3;border-radius:10px}
    #fotoPreview{display:block;margin-top:10px;max-width:180px;border-radius:12px}

    .row-btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.save{background:var(--brand);color:#fff}
    .btn.remove{background:var(--danger);color:#fff}
    .btn.ghost{background:#fff;border:2px solid var(--brand);color:var(--brand)}

    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid #e8f2ef}
    .chip.sem-plano{background:#fff;color:#666}
    .chip.pendente{background:#fff7e6;color:#a36b00;border-color:#f7dfb6}
    .chip.ativo{background:#e8fff6;color:#0a7a58;border-color:#b9f0dc}
    .chip.cancelamento_solicitado{background:#fff1f1;color:#a72d2d;border-color:#f3c3c3}
    .chip.cancelado{background:#f1f3f4;color:#666}

    .alerta-login{display:none;margin:14px auto;max-width:980px;background:#fffbe6;border:1px solid #ffe8a3;border-radius:12px;padding:10px 14px;color:#7a5600}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo"><img src="/logo.svg" alt="" height="28"> MostreAki</div>
    <div class="user-wrap">
      <div id="userCircle" class="user-circle"></div>
      <a id="authText" href="/login.html" class="btn ghost" style="text-decoration:none">Entrar</a>
      <div id="menuBtn" class="menu-icon" aria-label="Abrir menu" role="button" tabindex="0">
        <span></span><span></span><span></span>
      </div>
      <nav id="menu">
        <a href="/index.html">Página Inicial</a>
        <a href="/sobre.html">Sobre</a>
        <a href="/parceiros.html">Parceiros</a>
        <a href="/servicos-adicionais.html">Serviços Adicionais</a>
        <a href="/redes-sociais.html">Redes Sociais</a>
        <a href="/contatos.html">Contatos</a>
      </nav>
    </div>
  </header>

  <div id="alertaLogin" class="alerta-login">⚠️ Você precisa estar logado para acessar a página Minha Conta. Redirecionando…</div>

  <main class="container">
    <h2>Minha Conta</h2>
    <div class="grid">
      <!-- PERFIL / REDES -->
      <section class="card">
        <div class="head">Perfil e Redes</div>
        <div class="body">
          <label for="foto">Foto de Perfil</label>
          <input id="foto" type="file" accept="image/*">
          <img id="fotoPreview" alt="Preview">
          <div class="row-btns">
            <button id="btnExcluirFoto" class="btn remove">Remover foto</button>
          </div>

          <label>Instagram</label><input id="instagram" type="text" placeholder="@seuusuario">
          <label>Facebook</label><input id="facebook" type="text" placeholder="link da página">
          <label>WhatsApp</label><input id="whatsapp" type="text" placeholder="55DDD999999999">
          <label>YouTube</label><input id="youtube" type="text" placeholder="link do canal">

          <div class="row-btns">
            <button id="btnSalvar" class="btn save">Salvar alterações</button>
          </div>
        </div>
      </section>

      <!-- ASSINATURA + CATÁLOGO -->
      <section class="card">
        <div class="head">Assinatura</div>
        <div class="body">
          <div id="statusChip" class="chip sem-plano">Sem plano</div>
          <p id="planoLabel" style="margin:10px 0 6px">Plano atual: —</p>
          <small id="assinaturaMeta" style="color:#557"></small>

          <div class="row-btns" style="margin-top:14px">
            <button id="btnAssinar"  class="btn save">Assinar</button>
            <button id="btnAlterar"  class="btn ghost" style="display:none">Alterar plano</button>
            <button id="btnCancelar" class="btn remove" style="display:none">Cancelar plano</button>
          </div>

          <!-- Botões de Catálogo (mostrados dinamicamente) -->
          <div class="row-btns" style="margin-top:8px">
            <button id="btnEditarCatalogo" class="btn ghost" style="display:none">Editar catálogo</button>
            <button id="btnVerCatalogo" class="btn ghost" style="display:none">Ver catálogo</button>
          </div>
          <small id="infoCatalogo" style="display:none;color:#376;opacity:.9"></small>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp,
      collectionGroup, query, where, getDocs
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    const cfg = {
      apiKey: 'AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE',
      authDomain: 'mostreaki-2025.firebaseapp.com',
      projectId: 'mostreaki-2025',
      storageBucket: 'mostreaki-2025.firebasestorage.app',
      messagingSenderId: '748712068097',
      appId: '1:748712068097:web:09cf043fbb45917ef6ec00'
    };
    const app = getApps().length ? getApp() : initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const storage = getStorage(app, 'gs://mostreaki-2025.firebasestorage.app');

    const $ = s => document.querySelector(s);
    const circle = () => document.getElementById('userCircle') || document.querySelector('.user-circle');
    const cacheBust = u => u ? u + (u.includes('?')?'&':'?') + 'v=' + Date.now() : u;

    /* MENU */
    (function wireMenu(){
      const btn=document.getElementById('menuBtn'), menu=document.getElementById('menu');
      if(!btn || !menu) return;
      const open=()=>{ menu.style.display='flex'; document.addEventListener('click', onDoc, true); document.addEventListener('keydown', onKey) };
      const close=()=>{ menu.style.display='none'; document.removeEventListener('click', onDoc, true); document.removeEventListener('keydown', onKey) };
      const toggle=()=> (menu.style.display==='flex'?close():open());
      function onDoc(e){ if(!menu.contains(e.target) && e.target!==btn) close(); }
      function onKey(e){ if(e.key==='Escape') close(); }
      btn.addEventListener('click', toggle);
    })();

    /* ===== AVATAR – cache + busca (Firestore, Storage) ===== */
    function setAvatar(url){
      if(!url) return;
      localStorage.setItem('fotoPerfil', url);
      const el = circle(); if(!el) return;
      el.textContent = ''; el.style.display='flex';
      const img = new Image();
      img.src = cacheBust(url); img.alt='Foto';
      img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
      el.append(img);
      const prev = $('#fotoPreview'); if(prev) prev.src = url;
    }
    // cache imediato para evitar “F”
    (()=>{ const c = localStorage.getItem('fotoPerfil'); if(c) setAvatar(c); })();

    async function prefetchFoto(uid){
      if(auth.currentUser?.photoURL){ setAvatar(auth.currentUser.photoURL); return; }
      try{
        const s = await getDoc(doc(db,'usuarios',uid));
        const saved = s.exists() && s.data().fotoPerfil;
        if(saved){ setAvatar(saved); return; }
      }catch{}
      const tryExt = e => getDownloadURL(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)).catch(()=>null);
      const direct = await tryExt('jpg') || await tryExt('png') || await tryExt('webp') || await tryExt('gif');
      if(direct){
        try{ await setDoc(doc(db,'usuarios',uid), { fotoPerfil:direct }, { merge:true }); }catch{}
        setAvatar(direct);
      }
    }

    function extFromType(t){ return (t?.split('/')[1]||'jpg').replace('jpeg','jpg'); }

    async function previewImagem(ev, uid){
      const file = ev.target.files?.[0]; if(!file) return;
      $('#fotoPreview').src = URL.createObjectURL(file);
      const ext = extFromType(file.type);
      const path = `usuarios/${uid}/perfil/avatar.${ext}`;
      const storageRef = ref(storage, path);
      try{
        await uploadBytes(storageRef, file, { contentType:file.type });
        const url = await getDownloadURL(storageRef);
        await setDoc(doc(db,'usuarios',uid), { fotoPerfil:url }, { merge:true });
        for(const e of ['jpg','png','webp','gif']) if(e!==ext)
          try{ await deleteObject(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)); }catch{}
        setAvatar(url);
        alert('Foto atualizada com sucesso!');
      }catch(e){ console.error(e); alert('Erro ao salvar imagem no Storage.'); }
    }
    async function removerFoto(uid){
      let removed=false;
      for(const e of ['jpg','png','webp','gif']){
        try{ await deleteObject(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)); removed=true; }catch{}
      }
      try{ await setDoc(doc(db,'usuarios',uid),{ fotoPerfil:'' },{ merge:true }); }catch{}
      localStorage.removeItem('fotoPerfil');
      $('#fotoPreview').src=''; $('#userCircle').style.display='none';
      alert(removed? 'Foto removida.' : 'Nenhuma foto encontrada para remover.');
    }

    async function salvar(uid){
      const data={
        instagram: $('#instagram').value.trim(),
        facebook : $('#facebook').value.trim(),
        whatsapp : $('#whatsapp').value.trim(),
        youtube  : $('#youtube').value.trim()
      };
      await setDoc(doc(db,'usuarios',uid), data, { merge:true });
      alert('Dados salvos!');
    }
    async function carregar(uid){
      const s = await getDoc(doc(db,'usuarios',uid));
      if(!s.exists()) return;
      const d=s.data();
      $('#instagram').value = d.instagram || '';
      $('#facebook').value  = d.facebook  || '';
      $('#whatsapp').value  = d.whatsapp  || '';
      $('#youtube').value   = d.youtube   || '';
    }

    /* ===== Assinaturas (Firestore) ===== */
    const PLANOS = { basico:'Plano Básico', essencial:'Plano Intermediário', avancado:'Plano Avançado' };
    const STATUS_LABEL = {
      'sem-plano':'Sem plano',
      'pendente':'Pendente',
      'ativo':'Ativo',
      'cancelamento_solicitado':'Cancelamento solicitado',
      'cancelado':'Cancelado'
    };

    function renderAssinatura(data){
      const status = data?.status || 'sem-plano';
      const plano  = data?.plano  || null;
      const chip = $('#statusChip'); chip.className='chip '+status; chip.textContent = STATUS_LABEL[status]||'—';
      $('#planoLabel').textContent = 'Plano atual: ' + (plano? PLANOS[plano] : '—');

      const meta=[];
      if(data?.createdAt?.toDate) meta.push('Início: ' + data.createdAt.toDate().toLocaleDateString());
      if(data?.updatedAt?.toDate) meta.push('Atualizado: ' + data.updatedAt.toDate().toLocaleString());
      $('#assinaturaMeta').textContent = meta.join(' · ');

      const btnAssinar=$('#btnAssinar'), btnAlterar=$('#btnAlterar'), btnCancelar=$('#btnCancelar');
      if(status==='sem-plano' || !plano){
        btnAssinar.style.display='inline-block'; btnAlterar.style.display='none'; btnCancelar.style.display='none';
      }else if(status==='ativo' || status==='pendente'){
        btnAssinar.style.display='none'; btnAlterar.style.display='inline-block'; btnCancelar.style.display='inline-block';
      }else{
        btnAssinar.style.display='inline-block'; btnAlterar.style.display='none'; btnCancelar.style.display='none';
      }
    }

    async function ensureAssinaturaDoc(uid){
      const r = await getDoc(doc(db,'assinaturas',uid));
      if(!r.exists()){
        await setDoc(doc(db,'assinaturas',uid), {
          status:'sem-plano', plano:null, provider:'mercado_pago',
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        }, { merge:true });
      }
    }
    async function setAssinatura(uid, patch){
      await setDoc(doc(db,'assinaturas',uid), { updatedAt:serverTimestamp(), ...patch }, { merge:true });
    }
    function wireAssinatura(uid){
      onSnapshot(doc(db,'assinaturas',uid), snap=>{
        renderAssinatura(snap.exists()? snap.data() : { status:'sem-plano' });
      });
      $('#btnAssinar').onclick = ()=> location.href='/planos.html';
      $('#btnAlterar').onclick = ()=> location.href='/planos.html';
      $('#btnCancelar').onclick = async ()=>{
        if(!confirm('Confirmar cancelamento do plano?')) return;
        await setAssinatura(uid,{ status:'cancelamento_solicitado' });
        alert('Cancelamento solicitado. Entraremos em contato.');
      };
    }

    // Le retorno do Mercado Pago via URL (ex.: ?status=ativo&plano=basico)
    async function aplicarParametrosURL(uid){
      const p = new URLSearchParams(location.search);
      const status = p.get('status'); const plano = p.get('plano');
      if(!status && !plano) return;
      const patch = {};
      if(['pendente','ativo','cancelado'].includes(status)) patch.status = status;
      if(['basico','essencial','avancado'].includes(plano)) patch.plano = plano;
      if(Object.keys(patch).length) await setAssinatura(uid, patch);
      history.replaceState({}, '', location.pathname);
    }

    /* ===== Catálogo – mostra botões quando houver catálogo ativo ===== */
    async function wireCatalogo(uid){
      const btnEdit = $('#btnEditarCatalogo');
      const btnView = $('#btnVerCatalogo');
      const info    = $('#infoCatalogo');

      try{
        // procura qualquer /catalogos/{slug}/meta/config que pertença ao usuário
        const q = query(
          collectionGroup(db,'meta'),
          where('ownerUid','==', uid)
        );
        const snap = await getDocs(q);

        let cat=null;
        snap.forEach(d=>{
          const data=d.data();
          // o doc da collectionGroup é o próprio "config"
          const slug = data.catalogoSlug || d.ref.parent.parent?.id;
          if(slug) cat = {
            slug,
            ativo: !!data.catalogoAtivo,
            edicaoAtiva: !!data.edicaoAtiva
          };
        });

        if(cat && cat.ativo){
          const urlPublico = `/catalogo-template.html?c=${encodeURIComponent(cat.slug)}`;
          const urlEditar  = `${urlPublico}&edit=1`;

          btnView.style.display='inline-block';
          btnView.onclick = ()=> location.href = urlPublico;

          if(cat.edicaoAtiva){
            btnEdit.style.display='inline-block';
            btnEdit.onclick = ()=> location.href = urlEditar;
          }else{
            btnEdit.style.display='none';
          }

          info.style.display='block';
          info.textContent = `Catálogo "${cat.slug}" está ativo${cat.edicaoAtiva?' e com edição liberada.':'.'}`;
        }else{
          // não há catálogo ativo para este usuário
          btnEdit.style.display='none';
          btnView.style.display='none';
          info.style.display='none';
        }
      }catch(e){
        console.error('Erro ao buscar catálogo:', e);
      }
    }

    /* ===== Auth ===== */
    onAuthStateChanged(auth, async (user)=>{
      const a = $('#authText');
      if(user){
        a.textContent='Sair';
        a.onclick=async()=>{ await signOut(auth); localStorage.removeItem('fotoPerfil'); location='/index.html'; };

        $('#foto').onchange = ev => previewImagem(ev, user.uid);
        $('#btnSalvar').onclick = () => salvar(user.uid);
        $('#btnExcluirFoto').onclick = () => removerFoto(user.uid);

        await ensureAssinaturaDoc(user.uid);
        wireAssinatura(user.uid);
        await aplicarParametrosURL(user.uid);

        carregar(user.uid);
        prefetchFoto(user.uid);

        // <<< ativa botões do Catálogo
        wireCatalogo(user.uid);
      }else{
        $('#alertaLogin').style.display='block';
        document.querySelector('main.container').style.display='none';
        localStorage.removeItem('fotoPerfil');
        setTimeout(()=> location='/index.html', 4000);
      }
    });
  </script>
</body>
</html>
