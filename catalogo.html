<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo ‚Ä¢ MostreAki</title>
  <style>
    :root{
      --bg1:#0e6a67; --bg2:#0b4f4d;
      --card:#0f6f6c; --card2:#0b5a57;
      --paper:#e9fbf7; --ink:#0f2d2c; --muted:#8ccac5;
      --whats:#25D366; --ml:#FFE600; --ml-blue:#002E6C;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      color:#fff; background:linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      padding:16px 20px; display:flex; align-items:center; gap:16px;
    }
    header h1{margin:0; font-size:22px; font-weight:800; letter-spacing:.3px}
    .avatar{
      width:56px; height:56px; border-radius:50%;
      background:#fff2; border:3px solid #fff6; box-shadow:0 6px 24px #0004;
      background-position:center; background-size:cover;
    }
    main{width:100%; max-width:980px; margin:0 auto; padding:8px 14px 28px; flex:1}
    .title{
      text-align:center; margin:4px 0 14px; font-weight:800; font-size:28px; text-shadow:0 1px 0 #0003;
    }
    .banner{
      margin:0 auto 18px; border-radius:18px; width:100%; min-height:140px;
      background:linear-gradient(180deg,#dff7f3,#c7efe9);
      box-shadow:0 10px 24px #003b3a33; border:1px solid #ffffff22;
    }

    /* pagina√ß√£o (topo e base) */
    .pager-top{display:flex; justify-content:center; gap:6px; flex-wrap:wrap; margin:8px 0 14px}
    .pager-top button{
      background:#ffffff1a; border:1px solid #ffffff33; color:#fff; padding:6px 10px; border-radius:10px;
      cursor:pointer; font-weight:700; min-width:38px;
    }
    .pager-top button.active{background:#ffffff; color:var(--bg2)}
    .pager{
      display:flex; justify-content:center; gap:10px; align-items:center; margin:16px 0 6px;
    }
    .pager button{
      background:#ffffff1a; border:1px solid #ffffff33; color:#fff; padding:8px 14px; border-radius:12px;
      cursor:pointer; font-weight:700;
    }
    .pager .info{opacity:.85}

    /* grid */
    .grid{
      display:grid; grid-template-columns:repeat(2,1fr); gap:14px;
    }
    @media (min-width:740px){ .grid{ grid-template-columns:repeat(3,1fr);} }
    @media (min-width:980px){ .grid{ grid-template-columns:repeat(4,1fr);} }

    /* card */
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid #ffffff22; border-radius:16px; overflow:hidden;
      box-shadow:0 10px 26px #003b3a44;
    }
    .card .pic{
      position:relative; width:100%; aspect-ratio:1/1; background:#0002; cursor:pointer;
    }
    .card .pic img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .thumbs{
      position:absolute; bottom:8px; right:8px; display:flex; gap:6px;
    }
    .thumbs img{
      width:40px; height:40px; object-fit:cover; border-radius:8px; border:2px solid #fff9;
      box-shadow:0 4px 12px #0006; cursor:pointer; background:#fff;
    }
    .card .body{padding:10px 12px 12px}
    .name{font-weight:800; margin:2px 0 6px; font-size:16px}
    .meta{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px}
    .price{font-weight:900; font-size:18px; color:#fff}
    .qtd{font-size:12px; opacity:.9}

    .actions{
      display:flex; justify-content:flex-end; gap:8px;
      padding-top:6px; border-top:1px dashed #ffffff33;
    }
    .icon-btn{
      width:42px; height:42px; border-radius:999px; display:inline-grid; place-items:center;
      border:none; cursor:pointer; background:#fff; transition:transform .12s ease, box-shadow .12s ease;
      box-shadow:0 6px 18px #002f2e40;
    }
    .icon-btn:hover{ transform:translateY(-2px); box-shadow:0 10px 24px #002f2e55; }
    .icon-wa{ background:var(--whats); }
    .icon-wa svg{ width:22px; height:22px; fill:#fff }
    .icon-ml{ background:var(--ml); }
    .icon-ml svg{ width:26px; height:26px; }
    .icon-ml .ml-blue{ fill:var(--ml-blue); }

    /* modal de imagem */
    .modal{
      position:fixed; inset:0; background:#000c; display:none; align-items:center; justify-content:center; padding:18px;
      z-index:50;
    }
    .modal.open{ display:flex; }
    .modal img{ max-width:96vw; max-height:86vh; border-radius:16px; box-shadow:0 18px 48px #000b }
    .modal .close{
      position:absolute; top:14px; right:14px; background:#fff; color:#111; border:none; border-radius:999px; width:40px; height:40px; font-size:18px; font-weight:800; cursor:pointer;
      box-shadow:0 6px 18px #0007;
    }

    footer{ text-align:center; padding:24px 10px; color:#d9f4f1; opacity:.9; font-size:14px }
  </style>
</head>
<body>
  <header>
    <div id="avatar" class="avatar" aria-label="Logo/Foto"></div>
    <h1>MostreAki</h1>
  </header>

  <main>
    <div class="title">Cat√°logo</div>
    <div id="banner" class="banner"></div>

    <!-- n√∫meros de p√°gina (topo) -->
    <div id="pagerTop" class="pager-top" aria-label="Navega√ß√£o por p√°ginas"></div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <!-- pagina√ß√£o base -->
    <div class="pager">
      <button id="prevBtn" type="button">‚óÄ Anterior</button>
      <div id="pageInfo" class="info">P√°gina 1</div>
      <button id="nextBtn" type="button">Pr√≥ximo ‚ñ∂</button>
    </div>
  </main>

  <footer>¬© MostreAki ¬∑ Cat√°logo</footer>

  <!-- Modal de imagem -->
  <div id="imgModal" class="modal" role="dialog" aria-modal="true" aria-label="Visualiza√ß√£o da imagem">
    <button class="close" id="closeModal" aria-label="Fechar">√ó</button>
    <img id="modalImg" alt="Imagem ampliada" />
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
  // üëâ Substitua pelo seu config (o mesmo j√° usado nas outras p√°ginas)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Utils
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => [...el.querySelectorAll(s)];
  const params = new URLSearchParams(location.search);
  const slug = params.get("c") || ""; // ?c=almanyx
  const ITEMS_PER_PAGE = 10;

  // Estado de pagina√ß√£o
  let allItems = [];
  let currentPage = 1;

  // Modal
  const modal = qs('#imgModal');
  const modalImg = qs('#modalImg');
  qs('#closeModal').onclick = ()=> modal.classList.remove('open');
  modal.onclick = (e)=> { if(e.target===modal) modal.classList.remove('open'); };

  function openModal(src){ modalImg.src = src; modal.classList.add('open'); }

  function toDigits(s){ return (s||"").replace(/\D/g,''); }
  function priceBRL(item){
    if (typeof item.precoCentavos === 'number') return (item.precoCentavos/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    if (item.preco) return String(item.preco);
    return '‚Äî';
  }

  function renderPage(page=1){
    currentPage = page;
    const grid = qs('#grid');
    grid.innerHTML = '';

    const start = (page-1)*ITEMS_PER_PAGE;
    const pageItems = allItems.slice(start, start + ITEMS_PER_PAGE);

    pageItems.forEach(item => {
      const mainImg = item.img1 || item.urlImagem || '';
      const imgs = [item.img1, item.img2, item.img3].filter(Boolean);

      const card = document.createElement('div');
      card.className = 'card';

      const pic = document.createElement('div');
      pic.className = 'pic';
      const img = document.createElement('img');
      img.alt = item.nome || 'item';
      img.loading = 'lazy';
      img.src = mainImg;
      pic.appendChild(img);

      // thumbs
      if(imgs.length > 1){
        const thumbs = document.createElement('div');
        thumbs.className = 'thumbs';
        imgs.forEach(src=>{
          const t = document.createElement('img');
          t.src = src;
          t.alt = 'miniatura';
          t.addEventListener('click', e=>{
            e.stopPropagation();
            img.src = src;
          });
          thumbs.appendChild(t);
        });
        pic.appendChild(thumbs);
      }

      // ampliar
      pic.addEventListener('click', ()=> openModal(img.src));

      const body = document.createElement('div');
      body.className = 'body';
      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = item.nome || 'Item';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const price = document.createElement('div');
      price.className = 'price';
      price.textContent = priceBRL(item);
      const qtd = document.createElement('div');
      qtd.className = 'qtd';
      qtd.textContent = (item.qtd!=null) ? `Qtd: ${item.qtd}` : '';
      meta.appendChild(price); meta.appendChild(qtd);

      // a√ß√µes (WhatsApp + Mercado Livre condicional)
      const actions = document.createElement('div');
      actions.className = 'actions';

      // WhatsApp button (sempre se houver meta.whats)
      if(window.__metaWhats){
        const wa = document.createElement('a');
        wa.className = 'icon-btn icon-wa';
        wa.href = makeWaLink(window.__metaWhats, item);
        wa.target = '_blank'; wa.rel='noopener';
        wa.title = 'Falar no WhatsApp';
        wa.innerHTML = `
          <svg viewBox="0 0 32 32" aria-hidden="true">
            <path d="M16 3C9.9 3 5 7.9 5 14c0 2.2.7 4.2 1.9 5.9L6 29l9.3-1.8c.9.2 1.9.3 2.7.3 6.1 0 11-4.9 11-11S22.1 3 16 3Z" fill="none"/>
            <path d="M16 5c5 0 9 4 9 9s-4 9-9 9c-.8 0-1.7-.1-2.6-.3l-.5-.1-.5.1-5.4 1.1 1.1-5.4.1-.5-.3-.5C6.6 16.7 6 15.4 6 14c0-5 4-9 10-9Zm-3.2 6.1c-.3-.1-.6-.1-.8.3-.3.4-.9 1-.9 1.8 0 1 .6 2 1.8 3.2 1.2 1.1 3.4 2.4 5.1 2.7.8.1 1.5 0 2.1-.4.5-.3 1-.8 1.2-1.3.1-.3.1-.6-.1-.8-.2-.2-1.3-.7-1.7-.9-.4-.1-.6 0-.8.2-.2.3-.5.7-.7.8-.1.1-.3.1-.6 0-1.3-.5-2.1-1.1-3-2.3-.1-.2-.1-.3 0-.5.1-.2.4-.5.5-.7.2-.2.2-.4.1-.6 0-.2-.6-1.5-.9-1.9-.2-.3-.4-.4-.6-.5Z"/>
          </svg>`;
        actions.appendChild(wa);
      }

      // Mercado Livre button (condicional por item.mlUrl)
      if(item.mlUrl){
        const ml = document.createElement('a');
        ml.className = 'icon-btn icon-ml';
        ml.href = item.mlUrl; ml.target='_blank'; ml.rel='noopener';
        ml.title = 'Ver no Mercado Livre';
        ml.innerHTML = `
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <rect x="2" y="8" width="60" height="48" rx="24" fill="#FFE600"/>
            <path class="ml-blue" d="M18 28c2-2 5-4 8-4s6 2 8 4c2 2 5 4 8 4s6-2 8-4l2 3c-2 2-6 5-10 5s-8-3-10-5c-2-2-5-4-8-4s-6 2-8 4-8 5-12 5l2-4c3 0 8-3 10-4Z"/>
          </svg>`;
        actions.appendChild(ml);
      }

      body.appendChild(name);
      body.appendChild(meta);
      body.appendChild(actions);

      card.appendChild(pic);
      card.appendChild(body);
      grid.appendChild(card);
    });

    // info/pagers
    const totalPages = Math.max(1, Math.ceil(allItems.length/ITEMS_PER_PAGE));
    qs('#pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
    qs('#prevBtn').disabled = currentPage<=1;
    qs('#nextBtn').disabled = currentPage>=totalPages;

    // page numbers (top)
    const top = qs('#pagerTop');
    top.innerHTML = '';
    for(let i=1;i<=totalPages;i++){
      const b = document.createElement('button');
      b.textContent = i;
      if(i===currentPage) b.classList.add('active');
      b.addEventListener('click', ()=>renderPage(i));
      top.appendChild(b);
    }
  }

  function makeWaLink(whats, item){
    const phone = toDigits(whats);
    const txt = `Ol√°! Tenho interesse em: ${item.nome || ''}${item.precoCentavos? ' ('+priceBRL(item)+')' : ''}.`;
    return `https://wa.me/${phone}?text=${encodeURIComponent(txt)}`;
  }

  // Navega√ß√£o
  qs('#prevBtn').addEventListener('click', ()=> { if(currentPage>1) renderPage(currentPage-1); });
  qs('#nextBtn').addEventListener('click', ()=> {
    const total = Math.max(1, Math.ceil(allItems.length/ITEMS_PER_PAGE));
    if(currentPage<total) renderPage(currentPage+1);
  });

  async function load(){
    if(!slug){ alert('Cat√°logo n√£o encontrado.'); return; }

    // meta
    const metaRef = db.doc(`catalogos/${slug}/meta/config`);
    const metaSnap = await metaRef.get();
    if(!metaSnap.exists){ alert('Cat√°logo indispon√≠vel.'); return; }
    const meta = metaSnap.data();

    // deixa dispon√≠vel para montar o WhatsApp
    window.__metaWhats = meta.whats || '';

    // avatar/banner se existirem (opcionais)
    try{
      if(meta.ownerUid){
        const avatarRef = storage.ref().child(`usuarios/${meta.ownerUid}/perfil.jpg`);
        const url = await avatarRef.getDownloadURL();
        qs('#avatar').style.backgroundImage = `url('${url}')`;
      }
    }catch(e){}
    try{
      if(meta.bannerUrl){
        qs('#banner').style.background = `center / cover no-repeat url('${meta.bannerUrl}')`;
      }
    }catch(e){}

    if(meta.catalogoAtivo === false){
      alert('Cat√°logo desativado pelo propriet√°rio.');
      return;
    }

    // itens
    const itemsSnap = await db.collection(`catalogos/${slug}/itens`).get();
    allItems = itemsSnap.docs
      .map(d=>({id:d.id, ...d.data()}))
      .sort((a,b)=> (a.ordem??999) - (b.ordem??999));

    renderPage(1);
  }

  load().catch(err=>{
    console.error(err);
    alert('Erro ao carregar cat√°logo.');
  });
  </script>
</body>
</html>
