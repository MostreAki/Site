<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Entrar ‚Ä¢ MostreAki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --fundo: #92a9a6;
      --tonica: #cee3f2;
      --cinza: #e7eced;
      --bordo: #7d2f59;
      --texto: #143338;
      --grad1: #d9d9d9;
      --grad2: #af91a1;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #bcd2d8 0, var(--fundo) 55%);
      color: var(--texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #c5d4d2;
      border-bottom: 3px solid var(--bordo);
      padding: .7rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    header .brand {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    header .brand img {
      height: 55px;
      display: block;
    }

    header a.voltar {
      padding: .4rem .9rem;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      font-weight: 600;
      font-size: .9rem;
      text-decoration: none;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      border: 2px solid rgba(0,0,0,.12);
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 1.5rem .75rem 2.5rem;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, .9fr);
      gap: 2rem;
      align-items: start;
    }

    @media (max-width: 800px) {
      .shell {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(255,255,255,.88);
      border-radius: 24px;
      padding: 1.75rem 1.5rem 1.9rem;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      border: 1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
    }

    .card h1 {
      font-size: 1.9rem;
      margin-bottom: .4rem;
      color: #00403c;
    }

    .card p.sub {
      font-size: .98rem;
      color: #27454b;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .field {
      margin-bottom: 1rem;
    }

    .field label {
      display: block;
      font-weight: 600;
      font-size: .9rem;
      margin-bottom: .35rem;
      color: #1d3b40;
    }

    .field input[type="email"],
    .field input[type="password"],
    .field input[type="text"],
    .field input[type="tel"] {
      width: 100%;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.12);
      padding: .7rem 1rem;
      font-size: .95rem;
      outline: none;
      background: #f7fafb;
      transition: border-color .2s, box-shadow .2s, background .2s;
    }

    .field input:focus {
      border-color: var(--bordo);
      box-shadow: 0 0 0 2px rgba(125,47,89,.25);
      background: #ffffff;
    }

    .field small {
      display: block;
      font-size: .78rem;
      color: #54666a;
      margin-top: .2rem;
    }

    .row-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      margin-top: .25rem;
    }

    .row-inline label {
      display: flex;
      align-items: center;
      gap: .4rem;
      font-weight: 500;
    }

    .row-inline input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--bordo);
    }

    .btn,
    .btn-ghost {
      width: 100%;
      border-radius: 999px;
      padding: .8rem 1rem;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
    }

    .btn {
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      box-shadow: 0 4px 10px rgba(0,0,0,.22);
      border: 2px solid rgba(0,0,0,.1);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 7px rgba(0,0,0,.2);
    }

    .btn-ghost {
      background: #f7fafb;
      color: #1f2933;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }

    .btn-ghost img {
      width: 20px;
      height: 20px;
    }

    .btn-ghost:hover {
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,.12);
      transform: translateY(-1px);
    }

    .btn-ghost:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }

    .divider {
      margin: 1.25rem 0 1.1rem;
      display: flex;
      align-items: center;
      gap: .75rem;
      color: #6a7b80;
      font-size: .85rem;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: rgba(0,0,0,.12);
    }

    .muted {
      font-size: .85rem;
      color: #4d6267;
      margin-top: 1.1rem;
    }

    .muted a {
      color: var(--bordo);
      font-weight: 600;
      text-decoration: none;
    }

    .muted a:hover {
      text-decoration: underline;
    }

    .hero-card h2 {
      font-size: 1.6rem;
      margin-bottom: .6rem;
      color: #003735;
    }

    .hero-card ul {
      margin-left: 1rem;
      margin-top: .75rem;
      color: #21393f;
      font-size: .93rem;
      line-height: 1.6;
    }

    .hero-card li + li {
      margin-top: .4rem;
    }

    .hero-tag {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      border-radius: 999px;
      padding: .3rem .75rem;
      font-size: .8rem;
      background: rgba(206,227,242,.8);
      color: #143338;
      margin-bottom: .7rem;
      font-weight: 600;
    }

    .hero-tag span.bullet {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--bordo);
    }

    /* Perfil extra (Google first login) */
    #profileStep {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px dashed rgba(0,0,0,.15);
      display: none;
    }

    #profileStep.active {
      display: block;
    }

    #profileStep h2 {
      font-size: 1.2rem;
      margin-bottom: .2rem;
      color: #003735;
    }

    #profileStep p {
      font-size: .9rem;
      color: #425b60;
      margin-bottom: .9rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .35rem .8rem;
      border-radius: 999px;
      background: #f9f2f6;
      border: 1px solid rgba(125,47,89,.25);
      font-size: .78rem;
      color: #5a2742;
      margin-top: .15rem;
    }

    .pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--bordo);
    }

    /* Alert overlay (reutilizado em todo o app) */
    #alert {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    #alert .box {
      background: #ffffff;
      border-radius: 24px;
      max-width: 360px;
      width: 92vw;
      padding: 1.5rem 1.4rem 1.3rem;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      text-align: left;
    }

    #alert h2 {
      font-size: 1.2rem;
      margin-bottom: .4rem;
      color: #102a43;
    }

    #alert p {
      font-size: .9rem;
      color: #243b53;
      margin-bottom: 1rem;
    }

    #alertActions {
      display: flex;
      gap: .6rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .btn-solid {
      padding: .6rem 1.1rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(180deg, var(--grad1), var(--grad2));
      color: var(--bordo);
      font-weight: 600;
      cursor: pointer;
      font-size: .9rem;
    }

    .btn-ghost-sm {
      padding: .55rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.18);
      background: #f8fafc;
      font-size: .88rem;
      font-weight: 500;
      color: #102a43;
      cursor: pointer;
    }

    footer {
      border-top: 3px solid var(--bordo);
      background: #c5d4d2;
      padding: .8rem 1.25rem 1rem;
      text-align: center;
      font-size: .8rem;
      color: #284047;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logomarca.svg" alt="MostreAki">
    </div>
    <a href="index.html" class="voltar">Voltar para o in√≠cio</a>
  </header>

  <main>
    <div class="shell">
      <!-- Coluna: Login -->
      <section class="card">
        <h1>Entrar na sua conta</h1>
        <p class="sub">
          Acesse o painel MostreAki para gerenciar cat√°logo, √°lbum e dados da sua assinatura.
        </p>

        <!-- Form de login padr√£o -->
        <div id="emailStep">
          <div class="field">
            <label for="email">E-mail</label>
            <input type="email" id="email" autocomplete="email" placeholder="voce@exemplo.com">
          </div>

          <div class="field">
            <label for="senha">Senha</label>
            <input type="password" id="senha" autocomplete="current-password" placeholder="Digite sua senha">
            <div class="row-inline">
              <label>
                <input type="checkbox" id="chkMostrarSenha">
                <span>Mostrar senha</span>
              </label>
              <a href="recuperar-senha.html" style="font-size:.85rem;color:var(--bordo);text-decoration:none;font-weight:600;">
                Esqueceu a senha?
              </a>
            </div>
          </div>

          <button class="btn" id="btnEntrar">Entrar com e-mail</button>

          <p class="muted">
            Ainda n√£o tem conta?
            <a href="cadastro.html">Criar cadastro</a>
          </p>

          <div class="divider">ou</div>

          <button class="btn-ghost" id="btnGoogle">
            <!-- pode usar um √≠cone svg local se quiser -->
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
            <span>Entrar com Google</span>
          </button>
        </div>

        <!-- Passo extra para completar perfil (slug & whatsapp) -->
        <div id="profileStep">
          <h2>Completar perfil</h2>
          <p>
            S√≥ mais um passo üôå<br>
            Defina o seu <strong>nome de usu√°rio (slug)</strong> e o n√∫mero de WhatsApp
            que ser√£o usados nos links p√∫blicos e no contato do seu cat√°logo.
          </p>

          <div class="field">
            <label for="slug">
              Nome de usu√°rio (slug)
              <span class="pill">
                <span class="dot"></span> usado nos links p√∫blicos
              </span>
            </label>
            <input type="text" id="slug" placeholder="exemplo: lamaggie, studio-joao">
            <small>Use apenas letras, n√∫meros e h√≠fen. Sem espa√ßos ou acentos.</small>
          </div>

          <div class="field">
            <label for="whats">
              WhatsApp
            </label>
            <input type="tel" id="whats" placeholder="DDD + n√∫mero (somente n√∫meros)">
            <small>Exemplo: 19999998888. Usado para bot√µes de contato.</small>
          </div>

          <button class="btn" id="btnSalvarPerfil">Salvar e continuar</button>

          <p class="muted" style="margin-top:.8rem;">
            Se j√° existir outro usu√°rio com o mesmo slug, voc√™ poder√° escolher outra varia√ß√£o
            (por exemplo, <code>lamaggie-oficial</code>).
          </p>
        </div>
      </section>

      <!-- Coluna: info -->
      <section class="card hero-card">
        <div class="hero-tag">
          <span class="bullet"></span>
          MostreAki ‚Ä¢ painel do assinante
        </div>
        <h2>Central da sua presen√ßa digital</h2>
        <p class="sub" style="margin-bottom:.8rem;">
          Em um s√≥ lugar voc√™ acompanha seus planos, cat√°logo digital e materiais visuais
          criados pelo MostreAki.
        </p>
        <ul>
          <li>Gerencie seus dados de titular e foto de perfil.</li>
          <li>Acesse e edite cat√°logo e √°lbum (conforme o plano ativo).</li>
          <li>Veja o status da sua assinatura e atalhos para alterar ou cancelar.</li>
          <li>Converse com o suporte sempre que precisar de orienta√ß√µes.</li>
        </ul>
      </section>
    </div>
  </main>

  <footer>
    ¬© <span id="ano"></span> MostreAki ‚Ä¢ MostreAki o seu trabalho.
  </footer>

  <!-- Alert global -->
  <div id="alert">
    <div class="box">
      <h2 id="alertTitle">Aviso</h2>
      <p id="alertMsg"></p>
      <div id="alertActions"></div>
    </div>
  </div>

  <!-- Firebase + l√≥gica de login -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      sendEmailVerification
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      query,
      where,
      getDocs,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ========= base =========
    const app = initializeApp({
      apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain: "mostreaki-2025.firebaseapp.com",
      projectId: "mostreaki-2025",
      storageBucket: "mostreaki-2025.firebasestorage.app",
      messagingSenderId: "748712068097",
      appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
    });

    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const alertBG = $("alert");
    const alertTitle = $("alertTitle");
    const alertMsg = $("alertMsg");
    const alertActions = $("alertActions");

    function showAlert({ title = "Aviso", html = "", actions = [{ text: "Fechar" }] }) {
      alertTitle.textContent = title;
      alertMsg.innerHTML = html;
      alertActions.innerHTML = "";
      actions.forEach(a => {
        const b = document.createElement("button");
        b.textContent = a.text;
        b.className = a.kind === "ghost" ? "btn-ghost-sm" : "btn-solid";
        b.onclick = () => {
          if (a.onClick) a.onClick();
          closeAlert();
        };
        alertActions.appendChild(b);
      });
      alertBG.style.display = "flex";
    }

    function closeAlert() {
      alertBG.style.display = "none";
    }

    alertBG.addEventListener("click", (e) => {
      if (e.target === alertBG) closeAlert();
    });

    // ano footer
    $("ano").textContent = new Date().getFullYear();

    // mostrar senha
    (function wireShowPassword() {
      const input = $("senha");
      const chk = $("chkMostrarSenha");
      if (!input || !chk) return;
      chk.addEventListener("change", () => {
        input.type = chk.checked ? "text" : "password";
      });
    })();

    // helpers de valida√ß√£o
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    const slugRe  = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
    const phoneRe = /^[0-9]{10,14}$/;

    function normSlug(v) {
      return v
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9-]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");
    }

    // ========= login e-mail/senha =========
    async function loginEmailSenha() {
      const email = $("email").value.trim();
      const senha = $("senha").value;

      if (!emailRe.test(email)) {
        return showAlert({
          title: "E-mail inv√°lido",
          html: "Digite um e-mail v√°lido para continuar."
        });
      }
      if (!senha) {
        return showAlert({
          title: "Senha vazia",
          html: "Digite sua senha para continuar."
        });
      }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, senha);
        const user = cred.user;

        // se n√£o estiver verificado, reenvia
        if (!user.emailVerified) {
          await sendEmailVerification(user);
          return showAlert({
            title: "Confirme seu e-mail",
            html: `Seu e-mail ainda n√£o foi verificado.<br>
                   Reenviamos um link de confirma√ß√£o para <b>${email}</b>. 
                   Verifique sua caixa de entrada (ou spam) e tente novamente depois de confirmar.`
          });
        }

        // se deu tudo certo, manda para minha-conta
        window.location.href = "minha-conta.html";
      } catch (e) {
        console.error(e);
        let msg = "N√£o conseguimos entrar. Verifique e-mail e senha.";
        if (e.code === "auth/user-not-found") {
          msg = "N√£o encontramos uma conta com esse e-mail.";
        } else if (e.code === "auth/wrong-password" || e.code === "auth/invalid-credential") {
          msg = "E-mail e/ou senha incorretos.";
        } else if (e.code === "auth/too-many-requests") {
          msg = "Muitas tentativas em pouco tempo. Aguarde alguns instantes e tente novamente.";
        }
        showAlert({
          title: "Erro ao entrar",
          html: msg,
          actions: [
            { text: "Recuperar senha", kind: "ghost", onClick: () => window.location.href = "recuperar-senha.html" },
            { text: "Fechar" }
          ]
        });
      }
    }

    $("btnEntrar").addEventListener("click", loginEmailSenha);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && document.activeElement.tagName === "INPUT") {
        loginEmailSenha();
      }
    });

    // ========= login Google + cria√ß√£o de usu√°rio / slug =========
    const provider = new GoogleAuthProvider();
    let pendingGoogleUser = null; // user aguardando completar perfil

    $("btnGoogle").addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        pendingGoogleUser = user;

        // verifica se j√° existe doc em usuarios
        const docRef = doc(db, "usuarios", user.uid);
        const snap = await getDoc(docRef);

        if (snap.exists()) {
          const data = snap.data();
          // se j√° tem slug e whats v√°lidos, vai direto
          if (data.slug && data.whatsapp && slugRe.test(data.slug) && phoneRe.test(String(data.whatsapp))) {
            window.location.href = "minha-conta.html";
            return;
          } else {
            // preencher campos se existirem
            if (data.slug) $("slug").value = data.slug;
            if (data.whatsapp) $("whats").value = String(data.whatsapp);
          }
        } else {
          // sugest√£o de slug baseada no e-mail
          const sugestao = user.email ? normSlug(user.email.split("@")[0]) : "";
          $("slug").value = sugestao;
        }

        // mostra passo de perfil
        $("emailStep").style.display = "none";
        $("profileStep").classList.add("active");

      } catch (e) {
        console.error(e);
        if (e.code === "auth/popup-closed-by-user") return;
        showAlert({
          title: "Erro com Google",
          html: "N√£o foi poss√≠vel concluir o login com Google. Tente novamente."
        });
      }
    });

    async function slugDisponivel(slug) {
      const q = query(collection(db, "usuarios"), where("slug", "==", slug));
      const snap = await getDocs(q);
      return snap.empty;
    }

    $("btnSalvarPerfil").addEventListener("click", async () => {
      if (!pendingGoogleUser) {
        return showAlert({
          title: "Sess√£o expirada",
          html: "Refa√ßa o login com Google para completar o perfil."
        });
      }

      let slug = $("slug").value.trim();
      const whats = $("whats").value.trim();

      slug = normSlug(slug);

      if (!slug || !slugRe.test(slug)) {
        return showAlert({
          title: "Slug inv√°lido",
          html: "Informe um nome de usu√°rio usando apenas letras, n√∫meros e h√≠fen (sem espa√ßos ou acentos)."
        });
      }

      if (!phoneRe.test(whats)) {
        return showAlert({
          title: "WhatsApp inv√°lido",
          html: "Digite apenas n√∫meros, com DDD. Exemplo: <b>19999998888</b>."
        });
      }

      // verificar se o slug j√° n√£o est√° sendo usado por outro usu√°rio
      const disponivel = await slugDisponivel(slug);
      if (!disponivel) {
        return showAlert({
          title: "Slug em uso",
          html: `O nome de usu√°rio <b>${slug}</b> j√° est√° sendo usado. 
                 Experimente outra varia√ß√£o, como <b>${slug}-oficial</b> ou <b>${slug}-studio</b>.`
        });
      }

      try {
        const user = pendingGoogleUser;
        const docRef = doc(db, "usuarios", user.uid);
        await setDoc(docRef, {
          uid: user.uid,
          email: user.email || "",
          nomeCompleto: user.displayName || "",
          slug,
          whatsapp: whats,
          createdAt: serverTimestamp()
        }, { merge: true });

        window.location.href = "minha-conta.html";
      } catch (e) {
        console.error(e);
        showAlert({
          title: "Erro ao salvar",
          html: "N√£o foi poss√≠vel salvar seus dados agora. Tente novamente em instantes."
        });
      }
    });

    // se j√° estiver logado e abrir login.html, manda direto para minha-conta
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Evita loop se estiver justamente preenchendo perfil Google
        if (!pendingGoogleUser) {
          window.location.href = "minha-conta.html";
        }
      }
    });
  </script>
</body>
</html>
