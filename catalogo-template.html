<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editar Catálogo • MostreAki</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg1:#0f6f69; --bg2:#179b93;
    --card:#f3f5f6; --ink:#24423f; --ink-soft:#5e7b76;
    --accent:#1fb394; --title:#c6f2e0;
    --shadow: 0 10px 24px rgba(0,0,0,.18), 0 4px 12px rgba(0,0,0,.12);
    --r:20px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    background: radial-gradient(1200px 600px at 20% -10%, #1aa79f22 0%, #0000 60%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100dvh;
  }

  /* === TOPBAR / DRAWER === */
  .topbar{
    display:flex;align-items:center;gap:12px;padding:12px 16px;
    background:linear-gradient(90deg,#b8efe1aa,#b8efe122);
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid #ffffff2e;position:sticky;top:0;z-index:50
  }
  .mini-brand{display:flex;align-items:center;gap:10px}
  .mini-brand img{width:34px;height:34px;border-radius:999px;object-fit:cover;border:2px solid #ffffffbb;box-shadow:0 1px 0 #0003}
  .mini-brand .name{font-weight:800;color:#fff;text-shadow:0 1px 0 #0003;font-size:20px}
  .spacer{flex:1}
  .avatar{
    width:36px;height:36px;border-radius:999px;object-fit:cover;
    border:2px solid #ffffffcc;box-shadow:0 1px 0 #0003;cursor:pointer
  }
  .hamb{width:40px;height:32px;border:none;background:#ffffff1a;border-radius:10px;
        display:grid;place-items:center;cursor:pointer;margin-left:8px}
  .hamb span,.hamb::before,.hamb::after{
    content:"";display:block;width:18px;height:2px;background:#fff;border-radius:3px;box-shadow:0 1px 0 #0003
  }
  .hamb::before{transform:translateY(-5px)}
  .hamb::after{transform:translateY(5px)}
  .drawer{position:fixed;inset:0;display:none}
  .drawer.open{display:block}
  .drawer .shade{position:absolute;inset:0;background:#0008}
  .drawer nav{position:absolute;right:0;top:0;height:100%;width:min(86vw,340px);background:#0e5c57;color:#eafff9;
              padding:22px;box-shadow:var(--shadow)}
  .drawer nav a{display:block;color:#eafff9;text-decoration:none;font-weight:700;padding:10px 0;border-bottom:1px solid #ffffff26}

  /* === HERO === */
  .hero{max-width:1100px;margin:18px auto 10px;padding:0 16px;text-align:center}
  .logo{
    margin:6px auto 14px;width:140px;height:140px;border-radius:999px;background:#fff;border:6px solid #ffffffcc;
    display:grid;place-items:center;box-shadow:var(--shadow);overflow:hidden
  }
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .banner{height:190px;border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;border:1px solid #fff;background:#dff5ff}
  .banner img,.banner video{width:100%;height:100%;object-fit:cover;display:block}
  .title{margin:16px 0 0;font-size:clamp(26px,4.2vw,40px);font-weight:800;letter-spacing:.3px;
         color:var(--title);text-shadow:0 4px 16px rgba(0,0,0,.35),0 1px 0 #0003}
  .subtitle{margin:2px 0 10px;color:#e9fbf6;font-weight:600;text-shadow:0 1px 0 #0003}

  /* === GRID === */
  .wrap{max-width:1100px;margin:16px auto 100px;padding:0 16px}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .card{background:#eee;border-radius:18px;box-shadow:var(--shadow);border:1px solid #e7ebee;overflow:hidden}
  .frame{background:#e9e9e9;border:12px solid #e5e5e5;border-bottom-width:10px;border-radius:12px;margin:10px}
  .thumb{aspect-ratio:4/3;background:linear-gradient(#bfe8ff,#e7f5ff);border:1px solid #d0dbe2;display:grid;place-items:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .strip{
    display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;
    background:#efefef;border-top:1px solid #d9e1e6;padding:10px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;
  }
  .labels{font-weight:800;color:#2f4e49;line-height:1.15}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .inputs input{
    width:100%;padding:9px 10px;border-radius:10px;border:1px solid #cfd8dd;background:#fff;
    font:600 14px Poppins,sans-serif;color:#263532;outline:none;
  }
  .dirty input{border-color:#1fb394; box-shadow:0 0 0 3px #1fb39433}

  /* === FAB SAVE === */
  .fab{
    position:fixed;right:18px;bottom:18px;z-index:60;
    background:linear-gradient(180deg,#21caa6,#14a285); color:#053b33;
    border:none;border-radius:16px;padding:14px 18px;font:800 16px Poppins;letter-spacing:.3px;
    box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; cursor:pointer; opacity:.6; pointer-events:none;
  }
  .fab.active{opacity:1; pointer-events:auto}
  .fab .dot{width:10px;height:10px;border-radius:999px;background:#0c5b4f;box-shadow:0 0 0 4px #00000015}

  .muted{color:#d9fffa;opacity:.9;text-align:center;margin:12px 0}

  footer{color:#cfe9e4;text-align:center;padding:26px 16px 44px;background:linear-gradient(180deg,#0e6b65,#0a4e4a);border-top:1px solid #ffffff22}
  footer small{opacity:.9}
</style>
</head>
<body>
  <div class="topbar">
    <div class="mini-brand">
      <!-- mini logo do catálogo (placeholder até carregar) -->
      <img id="miniLogo" alt="logo" src="https://dummyimage.com/80x80/e0f7f3/7aa39b.png&text=LOGO" referrerpolicy="no-referrer"/>
      <div class="name" id="miniName">nome/empresa</div>
    </div>
    <div class="spacer"></div>
    <!-- avatar do usuário logado -->
    <img id="userAvatar" class="avatar" alt="Você" title="Minha conta" src="https://dummyimage.com/96x96/e0f7f3/7aa39b.png&text=%F0%9F%99%82" referrerpolicy="no-referrer"/>
    <button class="hamb" id="btnHamb" aria-label="Abrir menu"><span></span></button>
  </div>

  <div class="drawer" id="drawer">
    <div class="shade"></div>
    <nav>
      <h3 style="margin:0 0 10px">Menu</h3>
      <a href="/">Home</a>
      <a href="/minha-conta.html">Minha conta</a>
      <a href="/planos.html">Planos</a>
      <a href="/contato.html">Contato</a>
    </nav>
  </div>

  <header class="hero">
    <div class="logo"><img id="logoImg" alt="logo" src="https://dummyimage.com/240x240/ffffff/cccccc.png&text=LOGO" referrerpolicy="no-referrer"></div>
    <div class="banner" id="banner"></div>
    <div class="title" id="catTitle">Editar catálogo</div>
    <div class="subtitle" id="catSubtitle">Altere preço e quantidade e clique em “Salvar alterações”.</div>
    <div class="muted" id="permMsg"></div>
  </header>

  <main class="wrap">
    <section class="grid" id="grid"></section>
  </main>

  <button class="fab" id="btnSave" title="Salvar alterações">
    <span class="dot"></span> Salvar alterações
  </button>

  <footer><small>© <span id="year"></span> MostreAki. Todos os direitos reservados.</small></footer>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, getDocs, query, orderBy,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    /* ===== CONFIG ===== */
    const firebaseConfig = {
      apiKey:"AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
      authDomain:"mostreaki-2025.firebaseapp.com",
      databaseURL:"https://mostreaki-2025-default-rtdb.firebaseio.com",
      projectId:"mostreaki-2025",
      storageBucket:"mostreaki-2025.firebasestorage.app",
      messagingSenderId:"748712068097",
      appId:"1:748712068097:web:09cf043fbb45917ef6ec00"
    };
    const ASSETS_HOST = "https://assets.mostreaki.com.br";
    const IMG_PREFIX = "produto-";
    const IMG_EXT    = ".png";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const ui = {
      year:$("year"), grid:$("grid"), banner:$("banner"),
      title:$("catTitle"), subtitle:$("catSubtitle"),
      logo:$("logoImg"), miniLogo:$("miniLogo"), miniName:$("miniName"),
      perm:$("permMsg"), save:$("btnSave"),
      avatar:$("userAvatar")
    };
    ui.year.textContent = new Date().getFullYear();

    const params = new URLSearchParams(location.search);
    const slug   = params.get("c") || "demo";
    const imgURL = f => `${ASSETS_HOST}/catalogo/${slug}/${f}`;

    // Drawer
    const drawer = $("drawer");
    $("btnHamb").addEventListener('click',()=>drawer.classList.add('open'));
    drawer.querySelector('.shade').addEventListener('click',()=>drawer.classList.remove('open'));

    // Avatar abre Minha Conta
    ui.avatar.addEventListener("click", ()=> location.href="/minha-conta.html");

    const moneyToNumber = (v)=> {
      if(v==null) return 0;
      return Number(String(v).replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"")) || 0;
    };
    const numberToMoney = (n)=> (Number(n||0)).toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});

    function makeBanner(file){
      if(!file){ ui.banner.innerHTML = ""; return; }
      const isVideo = /\.webm$/i.test(file) || /\.mp4$/i.test(file);
      const src = imgURL(file);
      ui.banner.innerHTML = isVideo
        ? `<video src="${src}" autoplay muted loop playsinline></video>`
        : `<img src="${src}" alt="banner">`;
    }

    function makeEditorCard(idx, data){
      const file = data.imagem || `${IMG_PREFIX}${String(idx).padStart(2,"0")}${IMG_EXT}`;
      const preco= data.preco ?? "";
      const qtd  = data.quantidade ?? "";

      const el = document.createElement("article");
      el.className = "card";
      el.dataset.doc = String(idx).padStart(2,"0");
      el.innerHTML = `
        <div class="frame">
          <div class="thumb"><img src="${imgURL(file)}" alt=""></div>
          <div class="strip">
            <div class="labels">Preço<br>Qtde</div>
            <div class="inputs">
              <input class="in-price" type="text" inputmode="decimal" value="${preco!==""?numberToMoney(preco):""}" placeholder="0,00">
              <input class="in-qty"   type="number" step="1" min="0" value="${qtd!==""?qtd:""}" placeholder="0">
            </div>
          </div>
        </div>
      `;
      const price = el.querySelector(".in-price");
      const qty   = el.querySelector(".in-qty");

      [price, qty].forEach(inp=>{
        inp.addEventListener("input", ()=>{
          el.classList.add("dirty");
          ui.save.classList.add("active");
        });
      });
      price.addEventListener("blur", ()=>{
        const n = moneyToNumber(price.value);
        price.value = n ? numberToMoney(n) : "";
      });

      return el;
    }

    async function loadMeta(){
      try{
        const cfgRef = doc(db,"catalogos",slug,"meta","config");
        const snap   = await getDoc(cfgRef);
        return snap.exists()? snap.data(): {};
      }catch(e){ console.error(e); return {}; }
    }
    async function loadItens(){
      try{
        const itRef = collection(db,"catalogos",slug,"itens");
        const qRef  = query(itRef, orderBy("ordem","asc"));
        const snap  = await getDocs(qRef);
        const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
        return arr;
      }catch(e){ console.error(e); return []; }
    }

    async function saveAll(){
      try{
        ui.save.disabled = true;
        const cards = [...ui.grid.querySelectorAll(".card")].filter(c=>c.classList.contains("dirty"));
        if(!cards.length){ ui.save.classList.remove("active"); return; }

        const batch = writeBatch(db);
        cards.forEach((card)=>{
          const id   = card.dataset.doc;
          const ref  = doc(db, "catalogos", slug, "itens", id);
          const price= moneyToNumber(card.querySelector(".in-price").value);
          const qty  = Number(card.querySelector(".in-qty").value || 0);
          const ordem= Number(id);
          batch.set(ref, { preco:price, quantidade:qty, ordem }, { merge:true });
        });
        await batch.commit();

        cards.forEach(c=>c.classList.remove("dirty"));
        ui.save.classList.remove("active");
        alert("Catálogo salvo com sucesso!");
      }catch(e){
        console.error(e);
        alert("Falha ao salvar. Verifique sua conexão e permissões.");
      }finally{
        ui.save.disabled = false;
      }
    }

    function setAvatar(url){
      ui.avatar.src = url || "https://dummyimage.com/96x96/e0f7f3/7aa39b.png&text=%F0%9F%99%82";
    }

    async function boot(user){
      const meta  = await loadMeta();
      const itens = await loadItens();

      // topo/mini (catálogo)
      ui.miniLogo.src = meta.miniLogo ? imgURL(meta.miniLogo) :
                        (meta.logo ? imgURL(meta.logo) : ui.miniLogo.src);
      ui.miniName.textContent = meta.nome || meta.titulo || "nome/empresa";

      // logo central, título/sub
      ui.logo.src = meta.logo ? imgURL(meta.logo) : ui.logo.src;
      ui.title.textContent    = meta.titulo    || "Editar catálogo";
      ui.subtitle.textContent = "Altere preço e quantidade dos itens e clique em Salvar.";

      // banner
      makeBanner(meta.banner);

      // permissões
      const ok = !!meta.edicaoAtiva ||
                 (Array.isArray(meta.editores) && meta.editores.includes(user.uid)) ||
                 (meta.ownerUid && meta.ownerUid===user.uid);
      if(!ok){
        ui.perm.textContent = "Você não tem permissão para editar este catálogo. Peça ao MostreAki para habilitar.";
        ui.grid.innerHTML = "";
        ui.save.remove();
        return;
      }

      // render
      ui.grid.innerHTML = "";
      if(itens.length){
        itens.forEach((d,idx)=> ui.grid.appendChild( makeEditorCard(idx+1, d) ));
      }else{
        for(let i=1;i<=30;i++){
          ui.grid.appendChild( makeEditorCard(i, {} ) );
        }
      }

      // salvar
      ui.save.addEventListener("click", saveAll);
    }

    // ===== auth & carregar avatar do usuário (usuarios/{uid}.fotoPerfil) =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        setAvatar("");
        ui.perm.innerHTML = 'Você precisa estar logado para editar. <a href="/entrar" style="color:#fff;font-weight:800">Entrar</a>';
        ui.save.remove();
        return;
      }

      // tenta foto de /usuarios/{uid}.fotoPerfil
      try{
        const us = await getDoc(doc(db,"usuarios", user.uid));
        const foto = us.exists() && us.data().fotoPerfil ? us.data().fotoPerfil : (user.photoURL || "");
        setAvatar(foto);
      }catch(e){
        console.warn("avatar:", e);
        setAvatar(user.photoURL || "");
      }

      boot(user);
    });
  </script>
</body>
</html>
