<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catálogo – MostreAki</title>
<style>
  :root{
    --brand:#15b0af; --brandSoft:#c6f2e0; --ink:#063b39;
    --card:#fff; --line:#e6f3f1; --muted:#456;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6fbfa;color:#123}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#c2e7df}
  header .logo{display:flex;align-items:center;gap:8px; font-weight:800}
  header .logo span:nth-child(1){color:#00C2BF} header .logo span:nth-child(2){color:#FA1E39}
  #authBtn{background:#15b0af;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{margin:6px 0 16px;color:#0b4d4c}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:680px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06);display:flex;flex-direction:column}
  .thumb{position:relative;background:#eef;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .card-body{padding:12px 14px 8px;display:flex;flex-direction:column;gap:8px}
  .title{font-weight:800;color:#0b4d4c}
  .meta{display:flex;gap:8px;flex-wrap:wrap;color:#345}
  .meta b{color:#0d6}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="number"], input[type="text"]{
    border:1px solid #cfeee9;border-radius:8px;padding:8px 10px;min-width:0
  }
  .price{font-size:1.2rem;font-weight:900;color:#0e7270}
  .cta{margin:10px 0;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
  .cta:hover{filter:brightness(.96)}
  .owner-tools{background:#f3fbfa;border-top:1px solid var(--line);padding:10px 12px;display:flex;flex-direction:column;gap:8px}
  .owner-tools .row{justify-content:space-between}
  .mini{font-size:.86rem;color:#567}
  .upload{display:flex;gap:8px;align-items:center}
  .switch{display:flex;align-items:center;gap:6px;font-size:.92rem}
  .note{margin:12px 0 4px;padding:10px 12px;background:#f3fbfa;border-left:4px solid var(--brand);border-radius:10px;color:#234;font-size:.92rem}
  .toast{position:fixed;top:16px;right:16px;background:#FA1E39;color:#fff;padding:10px 12px;border-radius:10px;display:none;box-shadow:0 6px 18px rgba(0,0,0,.2);z-index:9999;font-weight:700}
</style>
</head>
<body>

<header>
  <div class="logo"><img src="logo.png" alt="Logo" style="height:28px"><span>Mostre</span><span>Aki</span></div>
  <button id="authBtn">Entrar</button>
</header>

<main>
  <h1>Catálogo</h1>
  <p class="mini">Fotos sobem para o Storage pelo MostreAki. O cliente (logado) pode ajustar <b>Preço</b> e <b>Quantidade</b>.</p>

  <div id="grid" class="grid"></div>

  <div class="note"><b>Nota:</b> clique em <b>WhatsApp</b> para chamar com a peça pré-preenchida. Preços são responsabilidade do lojista.</div>
</main>

<div id="toast" class="toast"></div>

<script type="module">
  /* Firebase */
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  const app = initializeApp({
    apiKey: "AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE",
    authDomain: "mostreaki-2025.firebaseapp.com",
    projectId: "mostreaki-2025",
    storageBucket: "mostreaki-2025.firebasestorage.app",
    messagingSenderId: "748712068097",
    appId: "1:748712068097:web:09cf043fbb45917ef6ec00"
  });

  const auth = getAuth(app);
  const db   = getFirestore(app);
  const stg  = getStorage(app, 'gs://mostreaki-2025.firebasestorage.app');

  /* UI helpers */
  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); };

  /* WhatsApp link */
  function waLink(telefoneBR, titulo, preco){
    const fone = telefoneBR.replace(/\D/g,''); // ex: 5599999999999
    const msg = encodeURIComponent(`Olá! Tenho interesse em "${titulo}" (${preco}). Pode me informar disponibilidade?`);
    return `https://wa.me/${fone}?text=${msg}`;
  }

  /* formatações */
  const fmtBRL = v => (typeof v==='number'? v : Number(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  /* render de card */
  function renderItem(id, data, user){
    const isOwner = user && data.ownerUID === user.uid;
    const card = document.createElement('article');
    card.className = 'card';
    card.dataset.id = id;

    const foto = data.fotoURL || 'https://via.placeholder.com/800x800?text=Foto';

    card.innerHTML = `
      <div class="thumb"><img src="${foto}" alt="${data.titulo||'Item'}"></div>
      <div class="card-body">
        <div class="title">${data.titulo||'Sem título'}</div>
        <div class="meta">
          <span class="price">${fmtBRL(data.preco||0)}</span>
          <span>•</span>
          <span>Qtd: <b>${data.quantidade??0}</b></span>
        </div>
        <button class="cta">WhatsApp</button>
      </div>
      ${isOwner ? `
      <div class="owner-tools">
        <div class="row">
          <label>Preço (R$): <input type="number" step="0.01" min="0" value="${Number(data.preco||0)}" class="in-preco"></label>
          <label>Quantidade: <input type="number" step="1" min="0" value="${Number(data.quantidade||0)}" class="in-qty"></label>
        </div>
        <div class="upload">
          <input type="file" accept="image/*" class="in-foto">
          <button class="mini-btn" data-act="save">Salvar</button>
        </div>
        <label class="switch">
          <input type="checkbox" class="in-ativo" ${data.ativo!==false?'checked':''}> Ativo
        </label>
        <div class="mini">Somente você vê estes controles.</div>
      </div>` : ``}
    `;

    /* ações */
    const btn = card.querySelector('.cta');
    btn.onclick = () => {
      const tel = data.whatsapp || '5599999999999'; // troque para o tel do lojista
      location.href = waLink(tel, data.titulo||'Produto', fmtBRL(data.preco||0));
    };

    if (isOwner){
      const inPreco = card.querySelector('.in-preco');
      const inQty   = card.querySelector('.in-qty');
      const inFoto  = card.querySelector('.in-foto');
      const inAtivo = card.querySelector('.in-ativo');
      const btnSave = card.querySelector('[data-act="save"]');

      btnSave.onclick = async ()=>{
        try{
          const refDoc = doc(db,'catalogo', id);
          const payload = {
            preco: Number(inPreco.value||0),
            quantidade: Number(inQty.value||0),
            ativo: inAtivo.checked
          };
          await updateDoc(refDoc, payload);
          toast('Dados salvos!');
        }catch(e){ console.error(e); toast('Falha ao salvar.'); }
      };

      inFoto.onchange = async (ev)=>{
        const file = ev.target.files?.[0];
        if(!file) return;
        try{
          const path = `catalogo/${data.ownerUID}/${id}.${(file.type.split('/')[1]||'jpg')}`;
          const refFoto = ref(stg, path);
          await uploadBytes(refFoto, file, {contentType:file.type});
          const url = await getDownloadURL(refFoto);
          await updateDoc(doc(db,'catalogo', id), { fotoURL:url });
          card.querySelector('img').src = url;
          toast('Foto atualizada!');
        }catch(e){ console.error(e); toast('Erro no upload.'); }
      };
    }

    return card;
  }

  /* carrega catálogo (somente itens ativos para público) */
  let unsub = null, currentUser = null;
  function loadCatalog(){
    if (unsub) { unsub(); unsub = null; }
    const base = collection(db,'catalogo');
    const q = currentUser
      ? query(base, orderBy('titulo'))               // dono vê tudo (inclusive inativo) no layout atual
      : query(base, where('ativo','==',true), orderBy('titulo'));  // público vê só ativos
    unsub = onSnapshot(q, snap=>{
      grid.innerHTML = '';
      snap.forEach(docSnap=>{
        const el = renderItem(docSnap.id, docSnap.data(), currentUser);
        grid.appendChild(el);
      });
      if (!snap.size) grid.innerHTML = '<p class="mini">Nenhum item disponível.</p>';
    });
  }

  /* auth simples (troque por seu modal) */
  const authBtn = $('#authBtn');
  onAuthStateChanged(auth, async (u)=>{
    currentUser = u || null;
    authBtn.textContent = u ? 'Sair' : 'Entrar';
    loadCatalog();
  });
  authBtn.onclick = async ()=>{
    if (currentUser) { await signOut(auth); return; }
    // exemplo rápido: login fixo (troque por seu fluxo)
    const email = prompt('E-mail:');
    const senha = prompt('Senha:');
    if(!email || !senha) return;
    try{ await signInWithEmailAndPassword(auth,email,senha); }
    catch(e){ console.error(e); toast('Falha no login.'); }
  };
</script>
</body>
</html>