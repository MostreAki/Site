<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Minha Conta – MostreAki</title>
<link rel="icon" href="favicon.ico" type="image/x-icon"/>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
  :root{
    --brand:#15b0af; --brandLight:#c2e7df; --accent:#FA1E39; --ink:#063b39;
  }
  body{
    background-image:url("fundo-mobile.png");
    background-size:cover;background-repeat:no-repeat;background-attachment:fixed;min-height:100vh;
    display:flex;flex-direction:column;color:#222;
  }
  @media (min-width:768px){ body{ background-image:url("fundo-desktop.png"); } }

  header{
    background:#c2e7df;height:60px;display:flex;align-items:center;justify-content:space-between;
    padding:0 20px;position:relative;box-shadow:0 2px 6px rgba(0,0,0,.1)
  }
  .logo-container{display:flex;align-items:center;cursor:pointer}
  .logo-container img{height:40px;margin-right:10px}
  .logo{font-size:1.5rem;font-weight:bold}
  .logo .mostre{color:#00C2BF}.logo .aki{color:#FA1E39}

  .menu-icon{font-size:1.5rem;cursor:pointer;user-select:none}
  .menu-list{
    position:absolute;top:60px;right:20px;background:#16807C;border:2px solid #000;border-radius:6px;
    display:none;flex-direction:column;padding:10px;z-index:10000;
  }
  .menu-list a{background:#FA1E39;color:#fff;text-decoration:none;padding:10px;margin-bottom:8px;border-radius:6px;text-align:center;font-weight:bold}
  .menu-list a:hover{background:#b8313b}

  .header-auth{display:flex;align-items:center;gap:10px}
  #authText{font-weight:bold;color:#15b0af;cursor:pointer;display:none}
  .user-circle{
    background:#15b0af;color:#fff;font-weight:bold;border-radius:50%;
    width:32px;height:32px;display:none;align-items:center;justify-content:center;
    background-size:cover;background-position:center;font-size:.9rem;overflow:hidden
  }

  main.container{
    width:100%;max-width:1100px;margin:30px auto;padding:0 16px;display:flex;flex-direction:column;gap:20px
  }
  .card{
    background:#fff;border:1px solid #e6f3f1;border-radius:12px;box-shadow:0 6px 20px #00000010;overflow:hidden
  }
  .card h2{
    background:linear-gradient(90deg,var(--brandLight),var(--brand));
    padding:14px 16px;color:var(--ink);font-size:1.1rem
  }
  .card .body{padding:16px}

  /* ===== Assinatura ===== */
  .assinatura{
    display:grid;gap:16px
  }
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{
    display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:bold;font-size:.95rem
  }
  .chip.sem-plano{background:#eef1f4;color:#445}
  .chip.pendente{background:#fff4d6;color:#7a5d00}
  .chip.ativo{background:#e8f7f0;color:#116b3c}
  .chip.cancelamento_solicitado{background:#ffe8e3;color:#8a3a2e}
  .chip.cancelado{background:#ffe3e7;color:#7a2030}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;font-weight:bold;text-decoration:none;text-align:center;cursor:pointer;border:none}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-outline{background:#fff;color:var(--brand);border:2px solid var(--brand)}
  .btn-danger{background:#FA1E39;color:#fff}

  /* ===== Perfil ===== */
  .grid{display:grid;gap:16px}
  @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
  label{display:block;margin:10px 0 6px;color:#333}
  input[type="text"],input[type="url"],input[type="email"],input[type="tel"],textarea{
    width:100%;padding:10px;border:1px solid #ccc;border-radius:8px
  }
  .help{color:#556;font-size:.9rem}

  /* ===== Avatar ===== */
  .avatar-wrap{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .avatar-wrap img{width:120px;height:120px;border-radius:50%;object-fit:cover;background:#f5f5f5;border:1px solid #eee}
  .avatar-actions{display:flex;flex-direction:column;gap:10px}
  .danger{background:#fff;border:2px solid #FA1E39;color:#FA1E39}

  /* ===== Avisos ===== */
  #alertaLogin{display:none;background:#fffbea;border:1px solid #ffe58f;color:#7a5d00;padding:14px;border-radius:8px;margin:20px}
  footer{background:#c2e7df;padding:20px;text-align:center;color:#555;font-size:.9rem;margin-top:auto}
</style>
</head>
<body>

<header>
  <div class="logo-container" onclick="location.href='index.html'">
    <img src="logo.png" alt="Logo">
    <div class="logo"><span class="mostre">Mostre</span><span class="aki">Aki</span></div>
  </div>
  <div class="header-auth">
    <span id="authText">Entrar</span>
    <div id="userCircle" class="user-circle" title="Perfil">F</div>
    <div id="menuBtn" class="menu-icon" aria-controls="menu" aria-expanded="false">☰</div>
  </div>
  <nav class="menu-list" id="menu">
    <a href="/index.html">Página Inicial</a>
    <a href="/sobre.html">Sobre</a>
    <a href="/minha-conta.html">Minha Conta</a>
    <a href="/planos.html">Planos</a>
    <a href="/parceiros.html">Parceiros</a>
    <a href="/servicos-adicionais.html">Serviços Adicionais</a>
    <a href="/redes-sociais.html">Redes Sociais</a>
    <a href="/contatos.html">Contatos</a>
  </nav>
</header>

<div id="alertaLogin">Você precisa estar logado para ver e editar sua conta. Redirecionando…</div>

<main class="container">
  <!-- ===== Assinatura ===== -->
  <section class="card" id="assinaturaCard">
    <h2>Assinatura</h2>
    <div class="body assinatura">
      <div class="row">
        <div id="statusChip" class="chip sem-plano">Sem plano</div>
        <div id="planoLabel" class="help">Plano atual: —</div>
      </div>

      <div class="row">
        <button id="btnAssinar"   class="btn btn-primary">Assinar agora</button>
        <button id="btnAlterar"   class="btn btn-outline" style="display:none">Alterar plano</button>
        <button id="btnCancelar"  class="btn btn-danger"  style="display:none">Cancelar plano</button>
      </div>

      <div id="assinaturaMeta" class="help"></div>
    </div>
  </section>

  <!-- ===== Perfil social ===== -->
  <section class="card">
    <h2>Perfil e redes</h2>
    <div class="body grid">
      <div>
        <label for="instagram">Instagram</label>
        <input id="instagram" type="text" placeholder="@seuperfil">
        <label for="facebook">Facebook</label>
        <input id="facebook" type="text" placeholder="facebook.com/sua.pagina">
        <label for="whatsapp">WhatsApp</label>
        <input id="whatsapp" type="tel" placeholder="(DDD) 90000-0000">
        <label for="youtube">YouTube</label>
        <input id="youtube" type="url" placeholder="https://youtube.com/@seucanal">
        <button id="btnSalvar" class="btn btn-primary" style="margin-top:10px">Salvar dados</button>
      </div>

      <div>
        <div class="avatar-wrap">
          <img id="fotoPreview" alt="Foto de perfil">
          <div class="avatar-actions">
            <input id="foto" type="file" accept="image/*">
            <button id="btnExcluirFoto" class="btn danger">Remover foto</button>
          </div>
        </div>
        <p class="help" style="margin-top:8px">Sua foto é usada no círculo do topo e guardada com segurança no seu espaço.</p>
      </div>
    </div>
  </section>
</main>

<footer>&copy; 2025 MostreAki. Todos os direitos reservados.</footer>

<script type="module">
import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

const app = getApps().length ? getApp() : initializeApp({
  apiKey:'AIzaSyBrKUtwP4T77oXE22cjOFVhfEUiJ7yctIE',
  authDomain:'mostreaki-2025.firebaseapp.com',
  projectId:'mostreaki-2025',
  storageBucket:'mostreaki-2025.firebasestorage.app',
  messagingSenderId:'748712068097',
  appId:'1:748712068097:web:09cf043fbb45917ef6ec00'
});
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app, 'gs://mostreaki-2025.firebasestorage.app');

const $ = sel => document.querySelector(sel);

// ===== menu (toggle com clique fora + ESC)
(function wireMenu(){
  const btn=document.getElementById('menuBtn'); const menu=document.getElementById('menu'); if(!btn||!menu) return;
  btn.setAttribute('aria-controls','menu'); btn.setAttribute('aria-expanded','false');
  const open=()=>{menu.style.display='flex';btn.setAttribute('aria-expanded','true');document.addEventListener('click',onDoc,true);document.addEventListener('keydown',onKey)};
  const close=()=>{menu.style.display='none';btn.setAttribute('aria-expanded','false');document.removeEventListener('click',onDoc,true);document.removeEventListener('keydown',onKey)};
  const toggle=()=> menu.style.display==='flex'?close():open();
  function onDoc(e){ if(!menu.contains(e.target) && e.target!==btn) close(); }
  function onKey(e){ if(e.key==='Escape') close(); }
  btn.addEventListener('click',e=>{ e.stopPropagation(); toggle(); });
})();

// ===== helpers & debug
const DEBUG=false;
const say=(...a)=>{ if(DEBUG) console.log('[MostreAki]',...a); };
function cacheBust(url){ return url ? url + (url.includes('?')?'&':'?') + 'v=' + Date.now() : url; }
function setAvatar(url){
  if(!url) return;
  localStorage.setItem('fotoPerfil', url);
  const bust = cacheBust(url);
  const preview = $('#fotoPreview'); if(preview) preview.src = bust;
  const el = $('#userCircle'); if(!el) return;
  el.innerHTML=''; el.style.display='flex';
  const img = new Image(); img.src=bust; img.alt='Foto';
  el.append(img);
}

// tenta de cara o cache
(()=>{ const c=localStorage.getItem('fotoPerfil'); if(c) try{ setAvatar(c) }catch{} })();

function extFromType(type){
  const map={'image/jpeg':'jpg','image/png':'png','image/webp':'webp','image/gif':'gif'}; return map[type]||'jpg';
}
async function prefetchFoto(uid){
  // 1) photoURL
  const u = auth.currentUser; if(u?.photoURL){ setAvatar(u.photoURL); return; }
  // 2) Firestore
  try{
    const s = await getDoc(doc(db,'usuarios',uid));
    const v = s.exists() && s.data().fotoPerfil; if(v){ setAvatar(v); return; }
  }catch{}
  // 3) Storage: tenta jpg/png/webp/gif
  try{
    const tryExt = async e => getDownloadURL(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)).catch(()=>null);
    const direct = await tryExt('jpg') || await tryExt('png') || await tryExt('webp') || await tryExt('gif');
    if(direct){ try{ await setDoc(doc(db,'usuarios',uid),{ fotoPerfil:direct },{ merge:true }); }catch{} setAvatar(direct); return; }
  }catch{}
  // 4) cache
  const c = localStorage.getItem('fotoPerfil'); if(c) setAvatar(c);
}

// ===== Upload/Remover avatar
async function previewImagem(ev, uid){
  const file = ev.target.files?.[0]; if(!file) return;
  $('#fotoPreview').src = URL.createObjectURL(file);
  const ext = extFromType(file.type);
  const path = `usuarios/${uid}/perfil/avatar.${ext}`;
  const storageRef = ref(storage, path);
  try{
    await uploadBytes(storageRef, file, { contentType:file.type });
    const url = await getDownloadURL(storageRef);
    await setDoc(doc(db,'usuarios',uid),{ fotoPerfil:url },{ merge:true });

    // limpa variantes antigas
    for(const e of ['jpg','png','webp','gif']){ if(e===ext) continue; try{ await deleteObject(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)); }catch{} }

    if(DEBUG){
      const list = await listAll(ref(storage, `usuarios/${uid}/perfil`));
      say('pasta perfil:', list.items.map(i=>i.name));
    }
    setAvatar(url); alert('Foto atualizada com sucesso!');
  }catch(e){ console.error(e); alert('Erro ao salvar imagem no Storage.'); }
}
async function removerFoto(uid){
  try{
    for(const e of ['jpg','png','webp','gif']){ try{ await deleteObject(ref(storage, `usuarios/${uid}/perfil/avatar.${e}`)); }catch{} }
    await setDoc(doc(db,'usuarios',uid),{ fotoPerfil:'' },{ merge:true });
    localStorage.removeItem('fotoPerfil');
    const prev = $('#fotoPreview'); if(prev) prev.src = '';
    const uc = $('#userCircle'); if(uc) uc.style.display='none';
    alert('Foto removida.');
  }catch(e){ console.error(e); alert('Falha ao remover.'); }
}

// ===== Salvar/Carregar redes
async function salvar(uid){
  const data={
    instagram: $('#instagram').value.trim(),
    facebook : $('#facebook').value.trim(),
    whatsapp : $('#whatsapp').value.trim(),
    youtube  : $('#youtube').value.trim()
  };
  await setDoc(doc(db,'usuarios',uid), data, { merge:true });
  alert('Dados salvos!');
}
async function carregar(uid){
  const s = await getDoc(doc(db,'usuarios',uid)); if(!s.exists()) return;
  const d = s.data();
  $('#instagram').value = d.instagram || '';
  $('#facebook').value  = d.facebook  || '';
  $('#whatsapp').value  = d.whatsapp  || '';
  $('#youtube').value   = d.youtube   || '';
}

// ===== Assinatura (Firestore)
const PLANOS = { basico:'Plano Básico', essencial:'Plano Intermediário', avancado:'Plano Avançado' };
const STATUS_LABEL = {
  'sem-plano':'Sem plano',
  'pendente':'Pendente',
  'ativo':'Ativo',
  'cancelamento_solicitado':'Cancelamento solicitado',
  'cancelado':'Cancelado'
};

function renderAssinatura(data){
  const status = data?.status || 'sem-plano';
  const plano  = data?.plano  || null;
  const chip = $('#statusChip'); chip.className = 'chip ' + status; chip.textContent = STATUS_LABEL[status] || '—';
  $('#planoLabel').textContent = 'Plano atual: ' + (plano ? PLANOS[plano] : '—');

  // Meta opcional (datas / refs)
  const meta = [];
  if(data?.createdAt?.toDate) meta.push('Início: ' + data.createdAt.toDate().toLocaleDateString());
  if(data?.updatedAt?.toDate) meta.push('Atualizado: ' + data.updatedAt.toDate().toLocaleString());
  $('#assinaturaMeta').textContent = meta.join(' · ');

  // botões
  const btnAssinar  = $('#btnAssinar');
  const btnAlterar  = $('#btnAlterar');
  const btnCancelar = $('#btnCancelar');

  if(status === 'sem-plano' || !plano){
    btnAssinar.style.display = 'inline-block';
    btnAlterar.style.display = 'none';
    btnCancelar.style.display= 'none';
  }else if(status === 'ativo' || status === 'pendente'){
    btnAssinar.style.display = 'none';
    btnAlterar.style.display = 'inline-block';
    btnCancelar.style.display= 'inline-block';
  }else{
    // cancelado / cancelamento_solicitado
    btnAssinar.style.display = 'inline-block';
    btnAlterar.style.display = 'none';
    btnCancelar.style.display= 'none';
  }
}

async function setAssinatura(uid, patch){
  await setDoc(doc(db,'assinaturas',uid), { updatedAt:serverTimestamp(), ...patch }, { merge:true });
}

function wireAssinatura(uid){
  // observa em tempo real
  onSnapshot(doc(db,'assinaturas',uid), snap=>{
    renderAssinatura(snap.exists() ? snap.data() : { status:'sem-plano' });
  });

  // botões
  $('#btnAssinar').onclick = ()=> location.href='/planos.html';
  $('#btnAlterar').onclick = ()=> location.href='/planos.html';
  $('#btnCancelar').onclick = async ()=>{
    if(!confirm('Confirmar cancelamento do plano?')) return;
    await setAssinatura(uid, { status:'cancelamento_solicitado' });
    alert('Cancelamento solicitado. Concluiremos em breve e enviaremos a confirmação.');
  };
}

// captura retorno do Mercado Pago via querystring e grava
async function aplicarParametrosURL(uid){
  const p = new URLSearchParams(location.search);
  const plano  = p.get('plano');                  // ex: basico | essencial | avancado
  const status = (p.get('status')||'').toLowerCase(); // ex: approved | pending | failure
  const mpPref = p.get('preference_id') || p.get('pref'); // opcional
  const mpPay  = p.get('payment_id')    || p.get('pay');  // opcional

  if(!plano && !status) return;

  let novoStatus = null;
  if(status==='approved') novoStatus='ativo';
  else if(status==='pending') novoStatus='pendente';
  else if(status==='failure') novoStatus='sem-plano';

  const patch = {
    plano: plano || undefined,
    status: novoStatus || undefined,
    mpPreferenceId: mpPref || undefined,
    mpPaymentId: mpPay || undefined,
    mpStatus: status || undefined
  };
  await setAssinatura(uid, { createdAt: serverTimestamp(), ...patch });
  // limpa a URL para evitar reprocessar
  history.replaceState({}, document.title, location.pathname);
}

// ===== Auth state
onAuthStateChanged(auth, user=>{
  const a = $('#authText');
  if(user){
    a.textContent='Sair'; a.style.display='inline';
    a.onclick = async ()=>{ await signOut(auth); localStorage.removeItem('fotoPerfil'); location='/index.html'; };

    // hooks
    $('#foto').onchange = ev => previewImagem(ev, user.uid);
    $('#btnExcluirFoto').onclick = ()=> removerFoto(user.uid);
    $('#btnSalvar').onclick = ()=> salvar(user.uid);

    // carrega perfil e avatar
    carregar(user.uid); prefetchFoto(user.uid);

    // assinatura
    wireAssinatura(user.uid);
    aplicarParametrosURL(user.uid);

    // mostra conteúdo
    document.querySelector('main.container').style.display='flex';
    document.getElementById('alertaLogin').style.display='none';

  }else{
    // esconde conteúdo e avisa
    document.querySelector('main.container').style.display='none';
    const al = document.getElementById('alertaLogin'); al.style.display='block';
    setTimeout(()=> location='/index.html', 4000);

    a.textContent='Entrar'; a.style.display='inline'; a.onclick = ()=> location='/login.html';
  }
});
</script>
</body>
</html>
